<div class="container mt-4">
  <div class="card mb-4">
    <div class="card-header">
      <h2>Exam Finance Details</h2>
    </div>
    <div class="card-body">
      <div class="row">
        <!-- Left Column: Main Details -->
        <div class="col-md-6">
          <div class="row mb-3">
            <div class="col-md-4 fw-bold">Learner:</div>
            <div class="col-md-8"><%= @exam_finance.user.full_name %></div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4 fw-bold">Hub:</div>
            <div class="col-md-8"><%= @exam_finance.user.hubs.first.name %></div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4 fw-bold">Exam Season:</div>
            <div class="col-md-8"><%= @exam_finance.exam_season %></div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4 fw-bold">Previous Status:</div>
            <div class="col-md-8"><%= @exam_finance.status %></div>
          </div>



        </div>

        <!-- Right Column: Status Change Log -->
        <div class="col-md-6">
          <% if @exam_finance.status_changes_log.any? %>
            <div class="border rounded p-3" style="max-height: 160px; overflow-y: auto;">
              <% @exam_finance.status_changes_log.each do |change| %>
                <% changed_time = Time.parse(change['changed_at']) %>
                <div class="mb-2">
                  <div class="d-flex align-items-center gap-2">
                    <% if change['subject'].present? %>
                      <span class="fw-bold" style="font-size: 0.85em; min-width: 120px;"><%= change['subject'] %>:</span>
                    <% end %>
                    <span class="badge <%= finance_status_badge_class(change['from']) %>" style="font-size: 0.85em; padding: 0.35em 0.6em;">
                      <%= change['from'] %>
                    </span>
                    <span>→</span>
                    <span class="badge <%= finance_status_badge_class(change['to']) %>" style="font-size: 0.85em; padding: 0.35em 0.6em;">
                      <%= change['to'] %>
                    </span>
                    <span class="text-muted ms-auto" style="font-size: 0.9em;">
                      <%= changed_time.strftime("%-d/%-m/%Y at %H:%M")%>
                      <% if change['changed_by'].present? && change['changed_by'] != 'Unknown' %>
                        <span class="d-inline-flex align-items-center justify-content-center bg-primary text-white rounded-circle email-tooltip"
                              style="width: 24px; height: 24px; font-size: 0.75em; cursor: pointer; margin-left: 4px;"
                              data-bs-toggle="tooltip"
                              data-bs-placement="top"
                              title="<%= change['changed_by'] %>">
                          <%= email_initials(change['changed_by']) %>
                        </span>
                      <% else %>
                        <span class="text-muted" style="font-size: 0.8em;"><%= change['changed_by'] || 'Unknown' %></span>
                      <% end %>
                    </span>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="fw-bold mb-2">Status Change Log:</div>
            <div class="border rounded p-3 text-muted">
              No status changes recorded yet.
            </div>
          <% end %>
        </div>
      </div>
    </div>
    <div class="card-footer d-flex gap-2">
      <%= link_to 'Preview Statement', preview_statement_exam_finance_path(@exam_finance), class: 'btn btn-primary' %>
      <%= link_to 'Back to List', exam_finances_path, class: 'btn btn-secondary' %>
    </div>
  </div>

  <h3 class="mb-4">Exam Enrollments</h3>

  <% @exam_enrolls.each do |exam_enroll| %>
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5><%= exam_enroll.subject_name %></h5>
        <%= link_to 'View Exam Enroll', exam_enroll_path(exam_enroll), class: 'btn btn-info btn-sm' %>
        <% if exam_enroll.respond_to?(:finance_status) %>
          <div class="d-flex align-items-center justify-content-center gap-2">
            <strong>Finance Status:</strong>
            <%= form_with(model: exam_enroll, url: exam_enroll_path(exam_enroll), local: true, class: 'd-inline') do |f| %>
              <%= hidden_field_tag :return_to_exam_finance_id, @exam_finance.id %>
              <%= f.select :finance_status,
                  options_for_select([
                    ['No Status', 'No Status'],
                    ['Sent to Finance', 'Sent to Finance'],
                    ['Invoiced', 'Invoiced'],
                    ['Paid', 'Paid'],
                    ['Deleted', 'Deleted'],
                  ], exam_enroll.finance_status),
                  {},
                  { class: 'form-select form-select-sm', style: 'width: auto; display: inline-block;', onchange: 'this.form.requestSubmit()' }
            %>
          <% end %>
        </div>
        <% end %>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-3">
            <p><strong>Code:</strong> <%= exam_enroll.code %></p>
          </div>
          <div class="col-md-3">
            <p><strong>Qualification:</strong> <%= exam_enroll.qualification %></p>
          </div>
          <div class="col-md-3">
            <p><strong>Board:</strong> <%= exam_enroll.exam_board %></p>
          </div>
          <div class="col-md-3">
            <p><strong>Status:</strong> <%= exam_enroll.status %></p>
          </div>
          <div class="col-md-12">
            <% if exam_enroll.specific_papers.present? %>
              <p><strong>Specific Papers:</strong> <%= exam_enroll.specific_papers %></p>
              <div class="mt-3">
                <div data-controller="paper-costs" data-paper-costs-enroll-id-value="<%= exam_enroll.id %>">
                  <form data-paper-costs-target="form" data-action="submit->paper-costs#save" class="mt-3">
                    <div class="d-flex flex-column gap-2">
                      <div class="d-flex gap-2">
                        <% (0..1).each do |i| %>
                          <div class="input-group input-group-sm">
                            <input type="text"
                                  name="papers[]"
                                  class="form-control bg-white"
                                  style="min-width: 200px;"
                                  placeholder="Paper <%= i + 1 %>"
                                  value="<%= exam_enroll.send("paper#{i + 1}") %>"
                            >
                            <input type="number"
                                  name="costs[]"
                                  class="form-control bg-white px-1"
                                  style="width: 35px; min-width: 35px;"
                                  step="0.01"
                                  value="<%= exam_enroll.send("paper#{i + 1}_cost") %>"
                            >
                            <span class="input-group-text bg-white">€</span>
                          </div>
                        <% end %>
                      </div>
                      <div class="d-flex gap-2">
                        <% (2..3).each do |i| %>
                          <div class="input-group input-group-sm">
                            <input type="text"
                                  name="papers[]"
                                  class="form-control bg-white"
                                  style="min-width: 200px;"
                                  placeholder="Paper <%= i + 1 %>"
                                  value="<%= exam_enroll.send("paper#{i + 1}") %>"
                            >
                            <input type="number"
                                  name="costs[]"
                                  class="form-control bg-white px-1"
                                  style="width: 35px; min-width: 35px;"
                                  step="0.01"
                                  value="<%= exam_enroll.send("paper#{i + 1}_cost") %>"
                            >
                            <span class="input-group-text bg-white">€</span>
                          </div>
                        <% end %>
                      </div>
                      <div class="d-flex gap-2 align-items-start">
                        <div class="input-group input-group-sm">
                          <input type="text"
                                name="papers[]"
                                class="form-control bg-white"
                                style="min-width: 200px;"
                                placeholder="Paper 5"
                                value="<%= exam_enroll.paper5 %>"
                          >
                          <input type="number"
                                name="costs[]"
                                class="form-control bg-white px-1"
                                style="width: 5px; min-width: 35px;"
                                step="0.01"
                                value="<%= exam_enroll.paper5_cost %>"
                          >
                          <span class="input-group-text bg-white">€</span>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">Save Papers</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            <% else %>
              <p><strong>Specific Papers:</strong> N/A</p>
            <% end %>
          </div>
        </div>

      </div>
    </div>
  <% end %>

  <% if @exam_enrolls.empty? %>
    <div class="alert alert-info">
      No exam enrollments found for this learner.
    </div>
  <% end %>
</div>

<style>
  /* Style for status select dropdown */
  select.form-select option[value="No Status"] {
    background-color: #6c757d;
    color: white;
  }
  select.form-select option[value="Sent to Finance"] {
    background-color: #0dcaf0;
    color: #000;
  }
  select.form-select option[value="Invoiced"] {
    background-color: #ffc107;
    color: #000;
  }
  select.form-select option[value="Paid"] {
    background-color: #198754;
    color: white;
  }
  select.form-select option[value="Deleted"] {
    background-color: #dc3545;
    color: white;
  }

  /* Make tooltips wider for email tooltips */
  .tooltip .tooltip-inner {
    max-width: 400px !important;
    white-space: normal !important;
    word-wrap: break-word !important;
  }
</style>
