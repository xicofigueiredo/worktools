<div class="container mt-4">
  <div class="card mb-4">
    <div class="card-header">
      <h2>Exam Finance Details</h2>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-3 fw-bold">Learner:</div>
        <div class="col-md-9"><%= @exam_finance.user.full_name %></div>
      </div>

      <div class="row mb-3">
        <div class="col-md-3 fw-bold">Hub:</div>
        <div class="col-md-9"><%= @exam_finance.user.hubs.first.name %></div>
      </div>

      <div class="row mb-3">
        <div class="col-md-3 fw-bold">Exam Season:</div>
        <div class="col-md-9"><%= @exam_finance.exam_season %></div>
      </div>

      <div class="row mb-3">
        <div class="col-md-3 fw-bold">Finance Status:</div>
        <div class="col-md-9">
          <%= form_with(model: @exam_finance, local: false, class: 'd-flex gap-2 align-items-center') do |f| %>
            <%= f.select :status,
                options_for_select([
                  ['No Status', 'No Status'],
                  ['Sent to Finance', 'Sent to Finance']
                ], @exam_finance.status),
                {},
                { class: 'form-select', style: 'width: auto', onchange: 'this.form.requestSubmit()' }
            %>
            <div id="status-update-message" class="text-success" style="display: none;">
              Status updated successfully!
            </div>
          <% end %>

          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const form = document.querySelector('form');
              const message = document.getElementById('status-update-message');

              form.addEventListener('ajax:success', function() {
                message.style.display = 'block';
                setTimeout(() => {
                  message.style.display = 'none';
                }, 3000);
              });
            });
          </script>
        </div>
      </div>

    </div>
    <div class="card-footer d-flex gap-2">
      <%= link_to 'Preview Statement', preview_statement_exam_finance_path(@exam_finance), class: 'btn btn-primary' %>
      <%= link_to 'Edit', edit_exam_finance_path(@exam_finance), class: 'btn btn-warning' %>
      <%= link_to 'Back to List', exam_finances_path, class: 'btn btn-secondary' %>
    </div>
  </div>

  <h3 class="mb-4">Exam Enrollments</h3>

  <% @exam_enrolls.each do |exam_enroll| %>
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5><%= exam_enroll.subject_name %></h5>
        <%= link_to 'View Exam Enroll', exam_enroll_path(exam_enroll), class: 'btn btn-info btn-sm' %>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-4">
            <p><strong>Code:</strong> <%= exam_enroll.code %></p>
          </div>
          <div class="col-md-4">
            <p><strong>Qualification:</strong> <%= exam_enroll.qualification %></p>
          </div>
          <div class="col-md-3">
            <p><strong>Status:</strong> <%= exam_enroll.status %></p>
          </div>
          <div class="col-md-12">
            <% if exam_enroll.specific_papers.present? %>
              <p><strong>Specific Papers:</strong> <%= exam_enroll.specific_papers %></p>
              <div class="mt-3">
                <div data-controller="paper-costs" data-paper-costs-enroll-id-value="<%= exam_enroll.id %>">
                  <form data-paper-costs-target="form" data-action="submit->paper-costs#save" class="mt-3">
                    <div class="d-flex flex-column gap-2">
                      <div class="d-flex gap-2">
                        <% (0..1).each do |i| %>
                          <div class="input-group input-group-sm">
                            <input type="text"
                                  name="papers[]"
                                  class="form-control bg-white"
                                  style="min-width: 200px;"
                                  placeholder="Paper <%= i + 1 %>"
                                  value="<%= exam_enroll.send("paper#{i + 1}") %>"
                            >
                            <input type="number"
                                  name="costs[]"
                                  class="form-control bg-white px-1"
                                  style="width: 35px; min-width: 35px;"
                                  step="0.01"
                                  value="<%= exam_enroll.send("paper#{i + 1}_cost") %>"
                            >
                            <span class="input-group-text bg-white">€</span>
                          </div>
                        <% end %>
                      </div>
                      <div class="d-flex gap-2">
                        <% (2..3).each do |i| %>
                          <div class="input-group input-group-sm">
                            <input type="text"
                                  name="papers[]"
                                  class="form-control bg-white"
                                  style="min-width: 200px;"
                                  placeholder="Paper <%= i + 1 %>"
                                  value="<%= exam_enroll.send("paper#{i + 1}") %>"
                            >
                            <input type="number"
                                  name="costs[]"
                                  class="form-control bg-white px-1"
                                  style="width: 35px; min-width: 35px;"
                                  step="0.01"
                                  value="<%= exam_enroll.send("paper#{i + 1}_cost") %>"
                            >
                            <span class="input-group-text bg-white">€</span>
                          </div>
                        <% end %>
                      </div>
                      <div class="d-flex gap-2 align-items-start">
                        <div class="input-group input-group-sm">
                          <input type="text"
                                name="papers[]"
                                class="form-control bg-white"
                                style="min-width: 200px;"
                                placeholder="Paper 5"
                                value="<%= exam_enroll.paper5 %>"
                          >
                          <input type="number"
                                name="costs[]"
                                class="form-control bg-white px-1"
                                style="width: 5px; min-width: 35px;"
                                step="0.01"
                                value="<%= exam_enroll.paper5_cost %>"
                          >
                          <span class="input-group-text bg-white">€</span>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">Save Papers</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            <% else %>
              <p><strong>Specific Papers:</strong> N/A</p>
            <% end %>
          </div>
        </div>

      </div>
    </div>
  <% end %>

  <% if @exam_enrolls.empty? %>
    <div class="alert alert-info">
      No exam enrollments found for this learner.
    </div>
  <% end %>
</div>
