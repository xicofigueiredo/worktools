<div class="container mt-4">
  <div id="flash">
    <%= render "shared/flash" %>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <!-- Left side: Season name -->
    <div class="text-start" style="flex: 1;">
      <h4 class="mb-2">
        <%= @season[:name] %>
      </h4>
    </div>

    <!-- Center: Season navigation -->
    <div class="d-flex gap-2 justify-content-center" style="flex: 1;">
      <%= link_to exam_finances_path(date: @previous_season&.dig(:start_date), status: params[:status], hub: params[:hub], subject: params[:subject], exam_centre: params[:exam_centre]),
          class: "btn btn-outline-secondary rounded d-flex align-items-center #{@previous_season ? '' : 'disabled'}" do %>
        <i class="fa-solid fa-chevron-left"></i>
      <% end %>

      <%= link_to 'Current Season',
          exam_finances_path(status: params[:status], hub: params[:hub], subject: params[:subject], exam_centre: params[:exam_centre]),
          class: "btn btn-outline-secondary rounded d-flex align-items-center" %>

      <%= link_to exam_finances_path(date: @next_season&.dig(:start_date), status: params[:status], hub: params[:hub], subject: params[:subject], exam_centre: params[:exam_centre]),
          class: "btn btn-outline-secondary rounded d-flex align-items-center #{@next_season ? '' : 'disabled'}" do %>
        <i class="fa-solid fa-chevron-right"></i>
      <% end %>
    </div>

    <!-- Right side: Filters -->
    <div class="d-flex align-items-end gap-2 justify-content-end" style="flex: 1;">
      <%= form_with url: exam_finances_path, method: :get, local: true, class: "d-flex align-items-end gap-2", id: "filter-form" do |form| %>

        <!-- Status Filter -->
        <div style="width: 150px;">
          <%= form.select :status,
              options_for_select([['All Status', 'all']] + @available_statuses.map { |status| [status, status] }, @current_status),
              {},
              {
                class: "form-select",
                id: "status-filter",
                onchange: "this.form.submit();"
              } %>
        </div>

        <!-- Preserve date parameter -->
        <%= form.hidden_field :date, value: params[:date] if params[:date].present? %>
      <% end %>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Learner</th>
              <th>Hub</th>
              <th>Subjects</th>
              <th>Total Cost</th>
              <th>Finance Status</th>
            </tr>
          </thead>

          <tbody>
            <% if @exam_finances.any? %>
              <% @exam_finances.each do |exam_finance| %>
                <tr onclick="window.location='<%= exam_finance_path(exam_finance) %>'" style="cursor: pointer;">
                  <td><%= exam_finance.user.full_name %></td>
                  <td><%= exam_finance.user.main_hub&.name || 'N/A' %></td>
                  <td>
                    <% enrolls = @exam_enrolls_by_finance[exam_finance.id] || [] %>
                    <% if enrolls.any? %>
                      <div style="font-size: 0.9em;">
                        <% enrolls.each do |enroll| %>
                          <div>
                            <%= enroll.subject_name %> - <%= enroll.code %>
                          </div>
                        <% end %>
                      </div>
                    <% else %>
                      <span class="text-muted">No subjects</span>
                    <% end %>
                  </td>
                  <td><%= exam_finance.total_cost %> <%= exam_finance.currency %></td>
                  <td>
                    <span class="badge <%= finance_status_badge_class(exam_finance.status) %>">
                      <%= exam_finance.status %>
                    </span>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="5" class="text-center">
                  <p class="my-3 text-muted">No exam finances found with this filter</p>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<style>
  .table-hover tbody tr:hover {
    background-color: rgba(0,0,0,.075);
  }
</style>
