<div class="mb-5">
  <div class="card mb-2 shadow-sm px-2 responsive-card" style="border-radius: 10px;">
    <div class="px-2 overflow-auto">
      <table class="table">
        <thead>
          <tr>
            <th>Subject</th>
            <th>Progress</th>
            <th>Topics</th>
            <th>Start Date</th>
            <th>Mock 50%</th>
            <th>Mock 100%</th>
            <th>End Date</th>
            <% if @has_exam_date %>
              <th>Exam Season</th>
            <% end %>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if @moodle_timelines.any? %>
            <% total_columns = @has_exam_date ? 9 : 8 %>
            <% @moodle_timelines.each do |timeline| %>              <%# Compute exam season display if needed %>
              <% exam_season = if timeline.exam_date.present?
                                   case timeline.exam_date.date.month
                                   when 5, 6
                                     "May/Jun #{timeline.exam_date.date.strftime('%Y')}"
                                   when 10, 11
                                     "Oct/Nov #{timeline.exam_date.date.strftime('%Y')}"
                                   else
                                     timeline.exam_date.date.strftime("%B %Y")
                                   end
                                 else
                                   "N/A"
                                 end %>
              <!-- Main timeline row -->
              <tr class="clickable" data-moodle-timeline-id="<%= timeline.id %>" style="cursor: pointer;">
                <td style="text-align: left;">
                  <%= timeline.subject.name.present? ? timeline.subject.name : timeline.personalized_name %>
                </td>
                <td>
                  <div style="font-weight: bold;">
                    <%= timeline.progress %>%
                  </div>
                </td>
                <td>
                  <% if timeline.balance %>
                    <% if timeline.balance.positive? %>
                      <div class="badge rounded-pill bg-success">
                        +<%= timeline.balance %>
                      </div>
                    <% elsif timeline.balance.negative? %>
                      <div class="badge rounded-pill bg-danger">
                        <%= timeline.balance %>
                      </div>
                    <% else %>
                      <div class="badge rounded-pill bg-warning">On time</div>
                    <% end %>
                  <% end %>
                </td>
                <td><%= timeline.start_date.strftime("%d/%m/%Y") %></td>
                <% if timeline.mock50.present? %>
                  <td><%= timeline.mock50.strftime("%d/%m/%Y") %></td>
                <% else %>
                  <td></td>
                <% end %>
                <% if timeline.mock100.present? %>
                  <td><%= timeline.mock100.strftime("%d/%m/%Y") %></td>
                <% else %>
                  <td></td>
                <% end %>
                <td><%= timeline.end_date.strftime("%d/%m/%Y") %></td>
                <% if @has_exam_date %>
                  <td><%= exam_season %></td>
                <% end %>
                <td>
                  <%= link_to edit_moodle_timeline_path(timeline.id) do %>
                    <i class="fa-solid fa-pencil" title="Edit" style="font-size: 17px; color: gray;"></i>
                  <% end %>
                  <%= link_to toggle_archive_moodle_timeline_path(timeline.id),
                              data: { turbo_method: :patch, turbo_confirm: "Are you sure you want to archive this timeline?" } do %>
                    <i class="fa-solid fa-box-archive" title="Archive" style="font-size: 17px; color: #808080;"></i>
                  <% end %>
                  <% if current_user.role == "admin" || current_user.email == "guest@edubga.com" %>
                    <%= link_to moodle_timeline_path(timeline.id),
                                data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this timeline?" } do %>
                      <i class="fa-solid fa-trash" title="Delete" style="font-size: 17px; color: gray;"></i>
                    <% end %>
                  <% end %>
                </td>
              </tr>
              <!-- Progress bar row underneath the main row -->
              <tr class="progress-row">
                <td colspan="<%= total_columns %>" style="padding: 0; border: none;">
                  <div class="progress" style="height: 15px; margin: 0;">
                    <% if timeline.progress >= timeline.expected_progress %>
                      <!-- Blue segment for expected progress -->
                      <div class="progress-bar bg-primary d-flex align-items-center justify-content-center" role="progressbar" style="width: <%= timeline.expected_progress %>%;opacity: 0.8;"
                           aria-valuenow="<%= timeline.expected_progress %>" aria-valuemin="0" aria-valuemax="100">
                        <%= timeline.expected_progress %>%
                      </div>
                      <!-- Green segment for extra progress -->
                      <div class="progress-bar bg-success d-flex align-items-center justify-content-center" role="progressbar" style="width: <%= timeline.progress - timeline.expected_progress %>%;opacity: 0.8;"
                           aria-valuenow="<%= timeline.progress - timeline.expected_progress %>" aria-valuemin="0" aria-valuemax="100">
                        <%= timeline.progress - timeline.expected_progress %>%
                      </div>
                    <% else %>
                      <!-- Blue segment for achieved progress -->
                      <div class="progress-bar bg-primary d-flex align-items-center justify-content-center" role="progressbar" style="width: <%= timeline.progress %>%;opacity: 0.8;"
                           aria-valuenow="<%= timeline.progress %>" aria-valuemin="0" aria-valuemax="100">
                        <%= timeline.progress %>%
                      </div>
                      <!-- Red segment for shortfall -->
                      <div class="progress-bar bg-danger d-flex align-items-center justify-content-center" role="progressbar" style="width: <%= timeline.expected_progress - timeline.progress %>%;opacity: 0.8;"
                           aria-valuenow="<%= timeline.expected_progress - timeline.progress %>" aria-valuemin="0" aria-valuemax="100">
                        <%= timeline.expected_progress - timeline.progress %>%
                      </div>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          <% else %>
            <% colspan_val = @has_exam_date ? 8 : 7 %>
            <tr>
              <td colspan="<%= colspan_val %>">
                <div class="text-center py-5">
                  <h2>No Timelines available...</h2>
                  <p>Please help <%= @learner.full_name %> set up their timelines.</p>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Placeholder for timeline details -->
<div id="timeline-details" class="mt-4"></div>

<!-- JavaScript to load timeline details on row click -->
<script>
// Clear dynamic content before Turbo caches the page.
document.addEventListener("turbo:before-cache", function() {
  var timelineDetails = document.getElementById("timeline-details");
  if (timelineDetails) {
    timelineDetails.innerHTML = "";
  }
});

// Use Turbo's load event (or DOMContentLoaded if you're not using Turbo)
document.addEventListener("turbo:load", function() {
  const tableBody = document.querySelector("table tbody");
  if (tableBody) {
    tableBody.addEventListener("click", function(e) {
      const row = e.target.closest(".clickable");
      if (row) {
        if (row.classList.contains("selected")) {
          row.classList.remove("selected");
          document.getElementById("timeline-details").innerHTML = "";
          return;
        }

        document.querySelectorAll("tr.clickable").forEach(function(r) {
          r.classList.remove("selected");
        });
        row.classList.add("selected");

        // Get the moodle timeline ID from the data attribute
        const timelineId = row.dataset.moodleTimelineId;
        if (!timelineId) {
          console.error("No moodle timeline ID found");
          return;
        }

        document.getElementById("timeline-details").innerHTML =
          '<div class="text-center my-3"><i class="fa-solid fa-spinner fa-spin" style="font-size:24px;"></i> Updating topics from Moodle...</div>';

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute("content");

        // Update the topics
        fetch(`/moodle_timelines/${timelineId}/update_topics`, {
          method: 'POST',
          headers: {
            "X-CSRF-Token": csrfToken,
            "Content-Type": "application/json",
            "Accept": "application/json"
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (!data.success) {
            throw new Error(data.error || 'Failed to update topics');
          }
          // After successful update, show the details
          return fetch(`/moodle_timelines/${timelineId}/moodle_show`, {
            headers: {
              "Accept": "text/html",
              "X-CSRF-Token": csrfToken
            }
          });
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.text();
        })
        .then(html => {
          document.getElementById("timeline-details").innerHTML = html;
        })
        .catch(error => {
          console.error("Error:", error);
          document.getElementById("timeline-details").innerHTML =
            '<div class="text-center text-danger">Error updating topics. Please try again.</div>';
        });
      }
    });
  }

  // Attach a listener for the modal close button.
  const closeBtn = document.getElementById("closeModal");
  if (closeBtn) {
    closeBtn.addEventListener("click", () => {
      document.getElementById("editModal").style.display = "none";
    });
  }

  // Close the modal if clicking outside the modal content.
  window.addEventListener("click", function(e) {
    const modal = document.getElementById("editModal");
    if (e.target === modal) {
      modal.style.display = "none";
    }
  });
});
</script>


<style>
tr {
  font-size: 17px;
}
tr.clickable:hover td {
  background-color: lightgray !important;
}
table.table tbody tr.selected td {
  background-color: #d5f000 !important;
}
</style>
