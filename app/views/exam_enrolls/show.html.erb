<div class="container mt-4">
  <% if flash[:warning] %>
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
      <%= flash[:warning] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <% if flash[:notice] %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <%= flash[:notice] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Exam Enrollment Details</h1>
    <div>
      <%= link_to "Edit", edit_exam_enroll_path(@exam_enroll), class: "btn btn-warning" %>
      <%= link_to "Back",  exam_enrolls_path(status: params[:status], hub: params[:hub], subject: params[:subject], exam_centre: params[:exam_centre], date: params[:date]), class: "btn btn-secondary" %>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5>Learner Information</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <p><strong>Name:</strong> <%= @exam_enroll.learner_name %></p>
          <p><strong>ID Type:</strong> <%= @exam_enroll.learner_id_type %></p>
          <p><strong>ID Number:</strong> <%= @exam_enroll.learner_id_number %></p>
        </div>
        <div class="col-md-6">
          <p><strong>Date of Birth:</strong> <%= @exam_enroll.date_of_birth&.strftime("%B %d, %Y") %></p>
          <p><strong>Gender:</strong> <%= @exam_enroll.gender %></p>
          <p><strong>Native English Speaker:</strong> <%= @exam_enroll.native_language_english ? "Yes" : "No" %></p>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex gap-4 flex-wrap">
    <div class="card mb-4 flex-grow-1">
      <div class="card-header">
        <h5>Learning Coach Information</h5>
      </div>
      <div class="card-body">
        <% if @exam_enroll.learning_coach_ids.any? %>
          <div class="row">
            <% @exam_enroll.learning_coach_ids.each do |lc_id| %>
              <% if lc = User.find_by(id: lc_id) %>
                <div class="col-md-6 mb-3">
                  <div class="card">
                    <div class="card-body">
                      <h6 class="card-title"><%= lc.full_name %></h6>
                      <p class="card-text"><small class="text-muted"><%= lc.email %></small></p>
                    </div>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        <% else %>
          <p class="text-muted">No Learning Coaches assigned</p>
        <% end %>
      </div>
    </div>
    <div class="card mb-4 flex-grow-1">
      <div class="card-header">
        <h5>Status History</h5>
      </div>
      <div class="card-body">
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5>Course Information</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4">
          <p><strong>Hub:</strong> <%= @exam_enroll.hub %></p>
        </div>
        <div class="col-md-4">
          <p><strong>Subject:</strong> <%= @exam_enroll.subject_name %></p>
        </div>
        <div class="col-md-4">
          <p><strong>Code:</strong> <%= @exam_enroll.code %></p>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4">
          <p><strong>Qualification:</strong> <%= @exam_enroll.qualification %></p>
        </div>
        <div class="col-md-4">
          <p><strong>Progress Cut-off Met:</strong> <%= @exam_enroll.progress_cut_off ? "Yes" : "No" %></p>
        </div>
        <div class="col-md-4">
          <p><strong>Mock Results:</strong> <%= @exam_enroll.mock_results %></p>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-md-12">
          <p><strong>Specific Papers:</strong> <%= @exam_enroll.specific_papers %></p>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5>Exam Details</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 mb-3">
          <p><strong>BGA Exam Centre:</strong> <%= @exam_enroll.bga_exam_centre %></p>
          <p><strong>Exam Board:</strong> <%= @exam_enroll.exam_board %></p>
        </div>
        <div class="col-md-6 mb-3">
          <p><strong>Repeating:</strong> <%= @exam_enroll.repeating? ? "Yes" : "No" %></p>
          <p><strong>Graduating:</strong> <%= @exam_enroll.graduating? ? "Yes" : "No" %></p>
        </div>
      </div>

      <div class="row">
        <div class="col-12 mb-3">
          <p>
            <strong>Special Accommodations Required:</strong>
            <%= @exam_enroll.has_special_accommodations ? "Yes" : "No" %>
          </p>
        </div>

        <% if @exam_enroll.has_special_accommodations %>
          <div class="col-md-6 mb-3">
            <strong>Special Accommodations Details:</strong>
            <p class="mt-2"><%= @exam_enroll.special_accommodations_personalized %></p>
          </div>
        <% end %>

        <% if @documents.any? %>
          <div class="col-md-6 mb-3">
            <strong>Supporting Documents:</strong>
            <div class="mt-2">
              <% @documents.each do |doc| %>
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                  <div>
                    <span class="fw-bold"><%= doc.file_name %></span>
                    <% if doc.description.present? %>
                      <br><small class="text-muted"><%= doc.description %></small>
                    <% end %>
                  </div>
                  <div class="d-flex gap-2">
                    <% if doc.file.attached? %>
                      <%= link_to "Open", download_document_exam_enroll_path(@exam_enroll, doc.id),
                          class: "btn btn-primary btn-sm",
                          target: "_blank" %>
                    <% else %>
                      <span class="text-muted">File not available</span>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <div class="col-12 mb-3">
          <strong>Additional Comments:</strong>
          <p class="mt-2"><%= @exam_enroll.additional_comments %></p>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5>Pre-registration Exception</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-12 mb-3">
          <p><strong>Justification:</strong></p>
          <p><%= @exam_enroll.pre_registration_exception_justification %></p>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4">
          <p>
            <strong>CM Approval:</strong>
            <% if @exam_enroll.pre_registration_exception_cm_approval == nil && @exam_enroll.pre_registration_exception_justification.blank? %>
              <span class="badge bg-secondary">Not Requested</span>
            <% elsif @exam_enroll.pre_registration_exception_cm_approval == nil %>
              <span class="badge bg-secondary">Pending</span>
            <% else %>
              <span class="badge <%= @exam_enroll.pre_registration_exception_cm_approval ? 'bg-success' : 'bg-danger' %>">
                <%= @exam_enroll.pre_registration_exception_cm_approval ? 'Approved' : 'Rejected' %>
              </span>
            <% end %>
          </p>
          <p><strong>CM Comment:</strong></p>
          <p><%= @exam_enroll.pre_registration_exception_cm_comment %></p>
        </div>

        <div class="col-md-4">
          <p>
            <strong>DC Approval:</strong>
            <% if @exam_enroll.pre_registration_exception_dc_approval == nil && @exam_enroll.pre_registration_exception_justification.blank? %>
              <span class="badge bg-secondary">Not Requested</span>
            <% elsif @exam_enroll.pre_registration_exception_dc_approval == nil %>
              <span class="badge bg-secondary">Pending</span>
            <% else %>
              <span class="badge <%= @exam_enroll.pre_registration_exception_dc_approval ? 'bg-success' : 'bg-danger' %>">
                <%= @exam_enroll.pre_registration_exception_dc_approval ? 'Approved' : 'Rejected' %>
              </span>
            <% end %>
          </p>
          <p><strong>DC Comment:</strong></p>
          <p><%= @exam_enroll.pre_registration_exception_dc_comment %></p>
        </div>

        <div class="col-md-4">
          <p>
            <strong>EDU Approval:</strong>
            <% if @exam_enroll.pre_registration_exception_edu_approval == nil && @exam_enroll.pre_registration_exception_justification.blank? %>
              <span class="badge bg-secondary">Not Requested</span>
            <% elsif @exam_enroll.pre_registration_exception_edu_approval == nil %>
              <span class="badge bg-secondary">Pending</span>
            <% else %>
              <span class="badge <%= @exam_enroll.pre_registration_exception_edu_approval ? 'bg-success' : 'bg-danger' %>">
                <%= @exam_enroll.pre_registration_exception_edu_approval ? 'Approved' : 'Rejected' %>
              </span>
            <% end %>
          </p>
          <p><strong>EDU Comment:</strong></p>
          <p><%= @exam_enroll.pre_registration_exception_edu_comment %></p>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5>Failed Mock Exception</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-12 mb-3">
          <p><strong>Justification:</strong></p>
          <p><%= @exam_enroll.failed_mock_exception_justification %></p>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4">
          <p>
            <strong>CM Approval:</strong>
            <% if @exam_enroll.failed_mock_exception_cm_approval == nil && @exam_enroll.failed_mock_exception_justification.blank? %>
              <span class="badge bg-secondary">Not Requested</span>
            <% elsif @exam_enroll.failed_mock_exception_cm_approval == nil %>
              <span class="badge bg-secondary">Pending</span>
            <% else %>
              <span class="badge <%= @exam_enroll.failed_mock_exception_cm_approval ? 'bg-success' : 'bg-danger' %>">
                <%= @exam_enroll.failed_mock_exception_cm_approval ? 'Approved' : 'Rejected' %>
              </span>
            <% end %>
          </p>
          <p><strong>CM Comment:</strong></p>
          <p><%= @exam_enroll.failed_mock_exception_cm_comment %></p>
        </div>

        <div class="col-md-4">
          <p>
            <strong>DC Approval:</strong>
            <% if @exam_enroll.failed_mock_exception_dc_approval == nil && @exam_enroll.failed_mock_exception_justification.blank? %>
              <span class="badge bg-secondary">Not Requested</span>
            <% elsif @exam_enroll.failed_mock_exception_dc_approval == nil %>
              <span class="badge bg-secondary">Pending</span>
            <% else %>
              <span class="badge <%= @exam_enroll.failed_mock_exception_dc_approval ? 'bg-success' : 'bg-danger' %>">
                <%= @exam_enroll.failed_mock_exception_dc_approval ? 'Approved' : 'Rejected' %>
              </span>
            <% end %>
          </p>
          <p><strong>DC Comment:</strong></p>
          <p><%= @exam_enroll.failed_mock_exception_dc_comment %></p>
        </div>

        <div class="col-md-4">
          <p>
            <strong>EDU Approval:</strong>
            <% if @exam_enroll.failed_mock_exception_edu_approval == nil && @exam_enroll.failed_mock_exception_justification.blank? %>
              <span class="badge bg-secondary">Not Requested</span>
            <% elsif @exam_enroll.failed_mock_exception_edu_approval == nil %>
              <span class="badge bg-secondary">Pending</span>
            <% else %>
              <span class="badge <%= @exam_enroll.failed_mock_exception_edu_approval ? 'bg-success' : 'bg-danger' %>">
                <%= @exam_enroll.failed_mock_exception_edu_approval ? 'Approved' : 'Rejected' %>
              </span>
            <% end %>
          </p>
          <p><strong>EDU Comment:</strong></p>
          <p><%= @exam_enroll.failed_mock_exception_edu_comment %></p>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5>Extension Request</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-12 mb-3">
          <p><strong>Extension Justification:</strong></p>
          <p><%= @exam_enroll.extension_justification %></p>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4">
          <p>
            <strong>CM Approval:</strong>
            <% if @exam_enroll.extension_cm_approval == nil && @exam_enroll.extension_justification.blank? %>
              <span class="badge bg-secondary">Not Requested</span>
            <% elsif @exam_enroll.extension_cm_approval == nil %>
              <span class="badge bg-secondary">Pending</span>
            <% else %>
              <span class="badge <%= @exam_enroll.extension_cm_approval ? 'bg-success' : 'bg-danger' %>">
                <%= @exam_enroll.extension_cm_approval ? 'Approved' : 'Rejected' %>
              </span>
            <% end %>
          </p>
          <p><strong>CM Comment:</strong></p>
          <p><%= @exam_enroll.extension_cm_comment %></p>
        </div>

        <div class="col-md-4">
          <p>
            <strong>DC Approval:</strong>
            <% if @exam_enroll.extension_dc_approval == nil && @exam_enroll.extension_justification.blank? %>
              <span class="badge bg-secondary">Not Requested</span>
            <% elsif @exam_enroll.extension_dc_approval == nil %>
              <span class="badge bg-secondary">Pending</span>
            <% else %>
              <span class="badge <%= @exam_enroll.extension_dc_approval ? 'bg-success' : 'bg-danger' %>">
                <%= @exam_enroll.extension_dc_approval ? 'Approved' : 'Rejected' %>
              </span>
            <% end %>
          </p>
          <p><strong>DC Comment:</strong></p>
          <p><%= @exam_enroll.extension_dc_comment %></p>
        </div>

        <div class="col-md-4">
          <p>
            <strong>EDU Approval:</strong>
            <% if @exam_enroll.extension_edu_approval == nil && @exam_enroll.extension_justification.blank? %>
              <span class="badge bg-secondary">Not Requested</span>
            <% elsif @exam_enroll.extension_edu_approval == nil %>
              <span class="badge bg-secondary">Pending</span>
            <% else %>
              <span class="badge <%= @exam_enroll.extension_edu_approval ? 'bg-success' : 'bg-danger' %>">
                <%= @exam_enroll.extension_edu_approval ? 'Approved' : 'Rejected' %>
              </span>
            <% end %>
          </p>
          <p><strong>EDU Comment:</strong></p>
          <p><%= @exam_enroll.extension_edu_comment %></p>
        </div>
      </div>
    </div>
  </div>
</div>
