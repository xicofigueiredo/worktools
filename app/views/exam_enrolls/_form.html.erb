<%= form_with(model: exam_enroll, local: true) do |f| %>
  <% if exam_enroll.errors.any? %>
    <div class="alert alert-danger">
      <h4><%= pluralize(exam_enroll.errors.count, "error") %> prohibited this enrollment from being saved:</h4>
      <ul>
        <% exam_enroll.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="card mb-4">
    <div class="card-header">
      <h5>Moodle Timeline</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-12 mb-3">
          <%= f.label :moodle_timeline_id, "Select Moodle Timeline", class: "form-label" %>
          <%= f.collection_select :moodle_timeline_id, @moodle_timelines,
              :last, :first,
              { prompt: "Select a Moodle Timeline" },
              { class: "form-select" } %>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5>Learner Information</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= f.label :learner_name, "Learner's Name (as per ID)", class: "form-label" %>
          <%= f.text_field :learner_name,
              class: "form-control",
              disabled: field_disabled?(:learner_name, current_user) %>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :hub, class: "form-label" %>
          <%= f.text_field :hub,
              class: "form-control",
              disabled: field_disabled?(:hub, current_user) %>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :learner_id_type, "Learner's ID Type", class: "form-label" %>
          <%= f.select :learner_id_type,
              ["Passport", "Residence Card", "Citizen Card"],
              { prompt: "Select ID Type" },
              class: "form-select",
              disabled: field_disabled?(:learner_id_type, current_user) %>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :learner_id_number, "Learner's ID Number", class: "form-label" %>
          <%= f.text_field :learner_id_number, class: "form-control", disabled: field_disabled?(:learner_id_number, current_user) %>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :date_of_birth, "Date of Birth", class: "form-label" %>
          <%= f.date_field :date_of_birth, class: "form-control", disabled: field_disabled?(:date_of_birth, current_user) %>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :gender, class: "form-label" %>
          <%= f.select :gender, ["Male", "Female"], { prompt: "Select Gender" }, class: "form-select", disabled: field_disabled?(:gender, current_user) %>
        </div>
        <div class="col-md-4 mb-3">
          <div class="form-check mt-4">
            <%= f.check_box :native_language_english, class: "form-check-input", disabled: field_disabled?(:native_language_english, current_user) %>
            <%= f.label :native_language_english, "Native Language is English", class: "form-check-label", disabled: field_disabled?(:native_language_english, current_user) %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5>Learning Coach Information</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= f.label :learning_coach, "Learning Coach Name", class: "form-label" %>
          <%= f.text_field :learning_coach, class: "form-control", disabled: field_disabled?(:learning_coach, current_user) %>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :learning_coach_email, "Learning Coach Email", class: "form-label" %>
          <%= f.email_field :learning_coach_email, class: "form-control", disabled: field_disabled?(:learning_coach_email, current_user) %>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5>Course Information</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4 mb-3">
          <%= f.label :subject_name, class: "form-label" %>
          <%= f.text_field :subject_name, class: "form-control", disabled: field_disabled?(:subject_name, current_user) %>
        </div>
        <div class="col-md-4 mb-3">
          <%= f.label :code, class: "form-label" %>
          <%= f.text_field :code, class: "form-control", disabled: field_disabled?(:code, current_user) %>
        </div>
        <div class="col-md-4 mb-3">
          <%= f.label :qualification, class: "form-label" %>
          <%= f.text_field :qualification, class: "form-control", disabled: field_disabled?(:qualification, current_user) %>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :progress_cut_off, class: "form-label" %>
          <%= f.text_field :progress_cut_off, class: "form-control", disabled: field_disabled?(:progress_cut_off, current_user) %>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :mock_results, class: "form-label" %>
          <%= f.text_field :mock_results, class: "form-control", disabled: field_disabled?(:mock_results, current_user) %>
        </div>
        <div class="col-12 mb-3">
          <%= f.label :specific_papers, "If your learner is sitting specific papers, please indicate which ones:", class: "form-label" %>
          <%= f.text_field :specific_papers, class: "form-control", disabled: field_disabled?(:specific_papers, current_user) %>
        </div>
      </div>
    </div>
  </div>


  <div class="card mb-4">
    <div class="card-header">
      <h5>Exam Details</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= f.label :bga_exam_centre, "BGA Exam Centre", class: "form-label" %>
          <%= f.select :bga_exam_centre,
              grouped_options_for_select({
                "Cambridge" => [["Portuguese", "Cambridge - Portuguese"]],
                "Pearson" => [
                  ["Mozambique", "Pearson - Mozambique"],
                  ["Angola", "Pearson - Angola"],
                  ["Malawi", "Pearson - Malawi"],
                  ["Zambia", "Pearson - Zambia"],
                  ["Zimbabwe", "Pearson - Zimbabwe"]
                ]
              }, @exam_enroll.bga_exam_centre),
              { prompt: "Select an exam centre" },
              { class: "form-control", disabled: field_disabled?(:bga_exam_centre, current_user) } %>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :exam_board, class: "form-label" %>
          <%= f.text_field :exam_board, class: "form-control", disabled: field_disabled?(:exam_board, current_user) %>
        </div>
        <div class="col-12 mb-3 mt-3">
          <div class="form-check mb-3">
            <%= f.check_box :has_special_accommodations, class: "form-check-input", disabled: field_disabled?(:has_special_accommodations, current_user) %>
            <%= f.label :has_special_accommodations, "Requires Special Accommodations", class: "form-check-label", disabled: field_disabled?(:has_special_accommodations, current_user) %>
          </div>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :special_accommodations_personalized, "Special Accommodations Details", class: "form-label" %>
          <%= f.text_area :special_accommodations_personalized, class: "form-control", rows: 3, disabled: field_disabled?(:special_accommodations_personalized, current_user) %>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :documents, "Doc", class: "form-label", style: "color: rgb(244 244 244)" %>
          <%= f.file_field :documents, multiple: true, class: "form-control mb-2", disabled: field_disabled?(:documents, current_user) %>
          <div class="form-text" style="font-size: 12px;">Please upload a recent diagnostic or medical report (in English or with certified translation) from a qualified professional, dated from Year 9 onwards.</div>
          <% if @exam_enroll.exam_enroll_documents.any? %>
            <div class="mt-2">
              <small class="text-muted mb-2 d-block">Current Documents:</small>
              <% @exam_enroll.exam_enroll_documents.each do |document| %>
                <div class="d-flex align-items-center gap-2 mb-2">
                  <span class="text-truncate"><%= document.filename %></span>
                  <%= link_to "Delete", delete_document_exam_enroll_path(@exam_enroll, document_id: document.id),
                      method: :delete,
                      data: { confirm: "Are you sure you want to delete this document?" },
                      class: "btn btn-danger btn-sm",
                      disabled: field_disabled?(:documents, current_user) %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
        <div class="col-md-6 mb-3 mt-3">
          <div class="d-flex gap-2">
            <%= f.label :repeating, "Is the learner repeating the exam?", class: "form-check-label" %>
            <%= f.check_box :repeating, class: "form-check-input", disabled: field_disabled?(:repeating, current_user) %>
          </div>
        </div>
        <div class="col-md-6 mb-3 mt-3">
          <div class="d-flex gap-2">
            <%= f.label :graduating, "Is the learner graduating after this exam?", class: "form-check-label" %>
            <%= f.check_box :graduating, class: "form-check-input", disabled: field_disabled?(:graduating, current_user) %>
          </div>
        </div>
        <div class="col-12 mb-3 mt-3">
          <%= f.label :additional_comments, class: "form-label" %>
          <%= f.text_area :additional_comments, class: "form-control", rows: 3, disabled: field_disabled?(:additional_comments, current_user) %>
        </div>
      </div>
    </div>
  </div>

  <div class="accordion" id="approvalAccordion">
    <!-- Pre-registration Exception Section -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed card-header d-flex align-items-center gap-1" type="button" data-bs-toggle="collapse" data-bs-target="#preRegistrationException" style="background-color: #ececec;">
          <h5>Pre-registration Exception</h5>
          <i class="fa-solid fa-circle-info" style="color:rgb(108 117 126);" title="In case your learner has not achieved 80% of progress by the established deadline, but still wants to be enrolled in the respective exam, an exception requirement must be submitted for the educational department to review"></i>
        </button>
      </h2>
      <div id="preRegistrationException" class="accordion-collapse collapse" data-bs-parent="#approvalAccordion">
        <div class="accordion-body">
          <div class="row">
            <div class="col-12 mb-3">
              <%= f.label :pre_registration_exception_justification, "Justification:", class: "form-label" %>
              <%= f.text_area :pre_registration_exception_justification, class: "form-control", rows: 3, disabled: field_disabled?(:pre_registration_exception_justification, current_user) %>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Course Manager Approval</label>
              <div class="btn-group" role="group" aria-label="CM Approval buttons">
                <%= f.radio_button :pre_registration_exception_cm_approval, true,
                    class: 'btn-check',
                    disabled: field_disabled?(:pre_registration_exception_cm_approval, current_user) %>
                <%= f.label :pre_registration_exception_cm_approval_true, 'Approve',
                    class: "btn btn-outline-success" %>

                <%= f.radio_button :pre_registration_exception_cm_approval, false,
                    class: 'btn-check',
                    disabled: field_disabled?(:pre_registration_exception_cm_approval, current_user) %>
                <%= f.label :pre_registration_exception_cm_approval_false, 'Reject',
                    class: "btn btn-outline-danger" %>
              </div>
              <div class="mt-3">
                <%= f.label :pre_registration_exception_cm_comment, "CM Comment", class: "form-label" %>
                <%= f.text_area :pre_registration_exception_cm_comment,
                    class: "form-control",
                    rows: 2,
                    disabled: field_disabled?(:pre_registration_exception_cm_comment, current_user) %>
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Development Coach Approval</label>
              <div class="btn-group" role="group" aria-label="DC Approval buttons">
                <%= f.radio_button :pre_registration_exception_dc_approval, true,
                    class: 'btn-check',
                    disabled: field_disabled?(:pre_registration_exception_dc_approval, current_user) %>
                <%= f.label :pre_registration_exception_dc_approval_true, 'Approve',
                    class: "btn btn-outline-success" %>

                <%= f.radio_button :pre_registration_exception_dc_approval, false,
                    class: 'btn-check',
                    disabled: field_disabled?(:pre_registration_exception_dc_approval, current_user) %>
                <%= f.label :pre_registration_exception_dc_approval_false, 'Reject',
                    class: "btn btn-outline-danger" %>
              </div>
              <div class="mt-3">
                <%= f.label :pre_registration_exception_dc_comment, "DC Comment", class: "form-label" %>
                <%= f.text_area :pre_registration_exception_dc_comment,
                    class: "form-control",
                    rows: 2,
                    disabled: field_disabled?(:pre_registration_exception_dc_comment, current_user) %>
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Education Team Approval</label>
              <div class="btn-group" role="group" aria-label="EDU Approval buttons">
                <%= f.radio_button :pre_registration_exception_edu_approval, true,
                    class: 'btn-check',
                    disabled: field_disabled?(:pre_registration_exception_edu_approval, current_user) %>
                <%= f.label :pre_registration_exception_edu_approval_true, 'Approve',
                    class: "btn btn-outline-success" %>

                <%= f.radio_button :pre_registration_exception_edu_approval, false,
                    class: 'btn-check',
                    disabled: field_disabled?(:pre_registration_exception_edu_approval, current_user) %>
                <%= f.label :pre_registration_exception_edu_approval_false, 'Reject',
                    class: "btn btn-outline-danger" %>
              </div>
              <div class="mt-3">
                <%= f.label :pre_registration_exception_edu_comment, "EDU Comment", class: "form-label" %>
                <%= f.text_area :pre_registration_exception_edu_comment,
                    class: "form-control",
                    rows: 2,
                    disabled: field_disabled?(:pre_registration_exception_edu_comment, current_user) %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Failed Mock Exception Section -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed card-header d-flex align-items-center gap-1" type="button" data-bs-toggle="collapse" data-bs-target="#failedMockException" style="background-color: #ececec;">
          <h5>Failed Mock Exception</h5>
          <i class="fa-solid fa-circle-info" style="color:rgb(108 117 126);" title="In case your learner has received a U as the Mock result, but still wants to be enrolled in the respective exam, an exception requirement must be submitted for the educational department to review"></i>
        </button>
      </h2>
      <div id="failedMockException" class="accordion-collapse collapse" data-bs-parent="#approvalAccordion">
        <div class="accordion-body">
          <div class="row">
            <div class="col-12 mb-3">
              <%= f.label :failed_mock_exception_justification, "Justification:", class: "form-label" %>
              <%= f.text_area :failed_mock_exception_justification, class: "form-control", rows: 3, disabled: field_disabled?(:failed_mock_exception_justification, current_user) %>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Course Manager Approval</label>
              <div class="btn-group" role="group" aria-label="CM Approval buttons">
                <%= f.radio_button :failed_mock_exception_cm_approval, true,
                    class: 'btn-check',
                    disabled: field_disabled?(:failed_mock_exception_cm_approval, current_user) %>
                <%= f.label :failed_mock_exception_cm_approval_true, 'Approve',
                    class: "btn btn-outline-success" %>

                <%= f.radio_button :failed_mock_exception_cm_approval, false,
                    class: 'btn-check',
                    disabled: field_disabled?(:failed_mock_exception_cm_approval, current_user) %>
                <%= f.label :failed_mock_exception_cm_approval_false, 'Reject',
                    class: "btn btn-outline-danger" %>
              </div>
              <div class="mt-3">
                <%= f.label :failed_mock_exception_cm_comment, "CM Comment", class: "form-label" %>
                <%= f.text_area :failed_mock_exception_cm_comment,
                    class: "form-control",
                    rows: 2,
                    disabled: field_disabled?(:failed_mock_exception_cm_comment, current_user) %>
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">DC Approval</label>
              <div class="btn-group" role="group" aria-label="DC Approval buttons">
                <%= f.radio_button :failed_mock_exception_dc_approval, true,
                    class: 'btn-check',
                    disabled: field_disabled?(:failed_mock_exception_dc_approval, current_user) %>
                <%= f.label :failed_mock_exception_dc_approval_true, 'Approve',
                    class: "btn btn-outline-success" %>

                <%= f.radio_button :failed_mock_exception_dc_approval, false,
                    class: 'btn-check',
                    disabled: field_disabled?(:failed_mock_exception_dc_approval, current_user) %>
                <%= f.label :failed_mock_exception_dc_approval_false, 'Reject',
                    class: "btn btn-outline-danger" %>
              </div>
              <div class="mt-3">
                <%= f.label :failed_mock_exception_dc_comment, "DC Comment", class: "form-label" %>
                <%= f.text_area :failed_mock_exception_dc_comment,
                    class: "form-control",
                    rows: 2,
                    disabled: field_disabled?(:failed_mock_exception_dc_comment, current_user) %>
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Education Team Approval</label>
              <div class="btn-group" role="group" aria-label="EDU Approval buttons">
                <%= f.radio_button :failed_mock_exception_edu_approval, true,
                    class: 'btn-check',
                    disabled: field_disabled?(:failed_mock_exception_edu_approval, current_user) %>
                <%= f.label :failed_mock_exception_edu_approval_true, 'Approve',
                    class: "btn btn-outline-success" %>

                <%= f.radio_button :failed_mock_exception_edu_approval, false,
                    class: 'btn-check',
                    disabled: field_disabled?(:failed_mock_exception_edu_approval, current_user) %>
                <%= f.label :failed_mock_exception_edu_approval_false, 'Reject',
                    class: "btn btn-outline-danger" %>
              </div>
              <div class="mt-3">
                <%= f.label :failed_mock_exception_edu_comment, "EDU Comment", class: "form-label" %>
                <%= f.text_area :failed_mock_exception_edu_comment,
                    class: "form-control",
                    rows: 2,
                    disabled: field_disabled?(:failed_mock_exception_edu_comment, current_user) %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Extension Approval Section -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed card-header d-flex align-items-center gap-1" type="button" data-bs-toggle="collapse" data-bs-target="#extensionApproval" style="background-color: #ececec;">
         <h5>Extension Approval</h5>
         <i class="fa-solid fa-circle-info" style="color:rgb(108 117 126);" title="In case your learner will not submit the Mock Exam by the established deadline, but still wants to be enrolled in the respective exam, an extension requirement must be submitted for the educational department to review"></i>
        </button>
      </h2>
      <div id="extensionApproval" class="accordion-collapse collapse" data-bs-parent="#approvalAccordion">
        <div class="accordion-body">
          <div class="row">
            <div class="col-12 mb-3">
              <%= f.label :extension_justification, "Justification:", class: "form-label" %>
              <%= f.text_area :extension_justification, class: "form-control", rows: 3, disabled: field_disabled?(:extension_justification, current_user) %>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Course Manager Approval</label>
              <div class="btn-group" role="group" aria-label="CM Approval buttons">
                <%= f.radio_button :extension_cm_approval, "true",
                    class: 'btn-check',
                    disabled: field_disabled?(:extension_cm_approval, current_user) %>
                <%= f.label :extension_cm_approval_true, 'Approve',
                    class: "btn btn-outline-success" %>

                <%= f.radio_button :extension_cm_approval, "false",
                    class: 'btn-check',
                    disabled: field_disabled?(:extension_cm_approval, current_user) %>
                <%= f.label :extension_cm_approval_false, 'Reject',
                    class: "btn btn-outline-danger" %>
              </div>
              <div class="mt-3">
                <%= f.label :extension_cm_comment, "CM Comment", class: "form-label" %>
                <%= f.text_area :extension_cm_comment,
                    class: "form-control",
                    rows: 2,
                    disabled: field_disabled?(:extension_cm_comment, current_user) %>
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">DC Approval</label>
              <div class="btn-group" role="group" aria-label="DC Approval buttons">
                <%= f.radio_button :extension_dc_approval, "true",
                    class: 'btn-check',
                    disabled: field_disabled?(:extension_dc_approval, current_user) %>
                <%= f.label :extension_dc_approval_true, 'Approve',
                    class: "btn btn-outline-success" %>

                <%= f.radio_button :extension_dc_approval, "false",
                    class: 'btn-check',
                    disabled: field_disabled?(:extension_dc_approval, current_user) %>
                <%= f.label :extension_dc_approval_false, 'Reject',
                    class: "btn btn-outline-danger" %>
              </div>
              <div class="mt-3">
                <%= f.label :extension_dc_comment, "DC Comment", class: "form-label" %>
                <%= f.text_area :extension_dc_comment,
                    class: "form-control",
                    rows: 2,
                    disabled: field_disabled?(:extension_dc_comment, current_user) %>
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Education Team Approval</label>
              <div class="btn-group" role="group" aria-label="EDU Approval buttons">
                <%= f.radio_button :extension_edu_approval, "true",
                    class: 'btn-check',
                    disabled: field_disabled?(:extension_edu_approval, current_user) %>
                <%= f.label :extension_edu_approval_true, 'Approve',
                    class: "btn btn-outline-success" %>

                <%= f.radio_button :extension_edu_approval, "false",
                    class: 'btn-check',
                    disabled: field_disabled?(:extension_edu_approval, current_user) %>
                <%= f.label :extension_edu_approval_false, 'Reject',
                    class: "btn btn-outline-danger" %>
              </div>
              <div class="mt-3">
                <%= f.label :extension_edu_comment, "EDU Comment", class: "form-label" %>
                <%= f.text_area :extension_edu_comment,
                    class: "form-control",
                    rows: 2,
                    disabled: field_disabled?(:extension_edu_comment, current_user) %>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="form-actions mt-4 d-flex justify-content-center mb-3 gap-2">
    <%= f.submit class: "btn btn-primary" %>
    <%= link_to "Back", exam_enrolls_path, class: "btn btn-secondary" %>
  </div>
<% end %>

<style>
  .btn-check {
  position: absolute;
  clip: rect(0,0,0,0);
  pointer-events: none;
}

.btn-check:checked + .btn-outline-success {
  color: #fff;
  background-color: #198754;
  border-color: #198754;
}

.btn-check:checked + .btn-outline-danger {
  color: #fff;
  background-color: #dc3545;
  border-color: #dc3545;
}

.btn-check:checked + .btn-outline-secondary {
  color: #fff;
  background-color: #6c757d;
  border-color: #6c757d;
}

.btn-group {
  display: flex;
  gap: 5px;
}

.accordion-button:not(.collapsed) {
  background-color: #ececec !important;
  color: inherit;
}

.accordion-button {
  background-color: #ececec !important;
}

.accordion-button:focus {
  box-shadow: none;
  border-color: rgba(0,0,0,.125);
}

.accordion-item {
  margin-bottom: 1rem;
}

.accordion-button:hover {
  background-color: #ececec !important;
}

.accordion-button,
.accordion-button:not(.collapsed),
.accordion-button:hover,
.accordion-button:focus {
  color: #212529;
}
</style>
