<%= form_with(model: exam_enroll, local: true) do |f| %>
  <% if flash[:alert] %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <%= flash[:alert] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <% if flash[:warning] %>
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
      <%= flash[:warning] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <% if exam_enroll.errors.any? %>
    <div class="alert alert-danger">
      <h4><%= pluralize(exam_enroll.errors.count, "error") %> prohibited this enrollment from being saved:</h4>
      <ul>
        <% exam_enroll.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="card mb-4">
    <div class="card-header">
      <h5>Learner Information</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= f.label :learner_name, "Learner's Name (as per ID)", class: "form-label" %>
          <%= f.text_field :learner_name,
              class: "form-control",
              disabled: field_disabled?(:learner_name, current_user) %>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :hub, class: "form-label" %>
          <%= f.text_field :hub,
              class: "form-control",
              disabled: field_disabled?(:hub, current_user) %>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :learner_id_type, "Learner's ID Type", class: "form-label" %>
          <%= f.select :learner_id_type,
              ["Passport", "Residence Card", "Citizen Card"],
              { prompt: "Select ID Type" },
              class: "form-select",
              disabled: field_disabled?(:learner_id_type, current_user) %>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :learner_id_number, "Learner's ID Number", class: "form-label" %>
          <%= f.text_field :learner_id_number, class: "form-control", disabled: field_disabled?(:learner_id_number, current_user) %>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :date_of_birth, "Date of Birth", class: "form-label" %>
          <%= f.date_field :date_of_birth, class: "form-control", disabled: field_disabled?(:date_of_birth, current_user) %>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :gender, class: "form-label" %>
          <%= f.select :gender, ["Male", "Female"], { prompt: "Select Gender" }, class: "form-select", disabled: field_disabled?(:gender, current_user) %>
        </div>
        <div class="col-md-4 mb-3">
          <div class="form-check mt-4">
            <%= f.check_box :native_language_english, class: "form-check-input", disabled: field_disabled?(:native_language_english, current_user) %>
            <%= f.label :native_language_english, "Native Language is English", class: "form-check-label", disabled: field_disabled?(:native_language_english, current_user) %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5>Learning Coach Information</h5>
    </div>
    <div class="card-body">
      <div class="row" id="learning-coaches-container">
        <% @exam_enroll.learning_coach_ids.each do |lc_id| %>
          <div class="col-12 mb-3 d-flex justify-content-between align-items-center border-bottom pb-2" id="lc-<%= lc_id %>">
            <div>
              <strong><%= User.find(lc_id).full_name %></strong><br>
              <small class="text-muted"><%= User.find(lc_id).email %></small>
            </div>
            <% if current_user.role == 'admin' || current_user.role == 'lc' %>
              <button type="button" class="btn btn-sm btn-danger" onclick="removeLearningCoach(<%= lc_id %>)">
                <i class="fas fa-times"></i> Remove
              </button>
            <% end %>
          </div>
        <% end %>

        <% if @exam_enroll.learning_coach_ids.empty? %>
          <div class="col-12 text-center text-muted">
            <p>No learning coaches assigned</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5>Course Information</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4 mb-3">
          <%= f.label :qualification, class: "form-label" %>
          <%= f.select :qualification,
              options_for_select([
                ["IGCSE", "IGCSE"],
                ["AS", "AS"],
                ["A2", "A2"],
                ["A Level", "A Level"]
              ], @exam_enroll.qualification),
              { prompt: "Select qualification" },
              { class: "form-select", disabled: field_disabled?(:qualification, current_user, @exam_enroll) } %>
        </div>
        <div class="col-md-4 mb-3">
          <%= f.label :subject_name, class: "form-label" %>
          <%= f.text_field :subject_name, class: "form-control", disabled: field_disabled?(:subject_name, current_user) %>
        </div>
        <div class="col-md-4 mb-3">
          <%= f.label :code, class: "form-label" %>
          <%= f.text_field :code, class: "form-control", disabled: field_disabled?(:code, current_user) %>
        </div>
        <div class="col-md-6 mb-3">
          <div class="form-check mt-4">
            <%= f.check_box :progress_cut_off, class: "form-check-input", disabled: field_disabled?(:progress_cut_off, current_user) %>
            <%= f.label :progress_cut_off, "Has achieved 80% of progress by the established deadline?", class: "form-check-label" %>
            <i class="fa-solid fa-circle-info" style="color:rgb(108 117 126);" title="In case your learner has not achieved 80% of progress by the established deadline, but still wants to be enrolled in the respective exam, an exception requirement must be submitted for the educational department to review"></i>
          </div>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :mock_results, class: "form-label" %>
          <%= f.select :mock_results,
              grouped_options_for_select({
                "Cambridge" => [
                  ["A*", "A*"],
                  ["A", "A"],
                  ["B", "B"],
                  ["C", "C"],
                  ["D", "D"],
                  ["E", "E"],
                  ["F", "F"],
                  ["G", "G"],
                  ["U", "U"]
                ],
                "Pearson" => [
                  ["9", "9"],
                  ["8", "8"],
                  ["7", "7"],
                  ["6", "6"],
                  ["5", "5"],
                  ["4", "4"],
                  ["3", "3"],
                  ["2", "2"],
                  ["1", "1"],
                  ["U", "U"]
                ]
              }, @exam_enroll.mock_results),
              { prompt: "Select a grade", include_blank: true },
              { class: "form-select", disabled: field_disabled?(:mock_results, current_user) } %>
        </div>
        <div class="col-12 mb-3">
          <%= f.label :specific_papers, "If your learner is ONLY sitting specific papers, please indicate which ones:", class: "form-label" %>
          <%= f.text_field :specific_papers, class: "form-control", disabled: field_disabled?(:specific_papers, current_user) %>
        </div>
      </div>
    </div>
  </div>


  <div class="card mb-4">
    <div class="card-header">
      <h5>Exam Details</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6 mb-3">
          <%= f.label :exam_board, class: "form-label" %>
          <%= f.text_field :exam_board, class: "form-control", disabled: field_disabled?(:exam_board, current_user) %>
        </div>
          <div class="col-md-6 mb-3" style="display: none;">
            <%= f.hidden_field :personalized_exam_date %>
            <div class="form-text">
              <% if @exam_enroll.timeline&.exam_date&.date.present? %>
                Timeline exam date: <%= @exam_enroll.timeline.exam_date.date.strftime("%B %d, %Y") %>
              <% else %>
                No timeline exam date set - using personalized date
              <% end %>
            </div>
          </div>
        <div class="col-md-6 mb-3">
          <%= f.label :bga_exam_centre, "BGA Exam Centre", class: "form-label" %>
          <%= f.select :bga_exam_centre,
              grouped_options_for_select({
                "Pearson" => [
                  ["Portugal/North – Aveiro", "Pearson - Portugal/North – Aveiro"],
                  ["Portugal/Center – Linhó", "Pearson - Portugal/Center – Linhó"],
                  ["Portugal/South – Tavira", "Pearson - Portugal/South – Tavira"],
                  ["Portugal/Madeira Island – Funchal", "Pearson - Portugal/Madeira Island – Funchal"],
                  ["South Africa – Durban", "Pearson - South Africa – Durban"],
                  ["South Africa – Tyger Valley", "Pearson - South Africa – Tyger Valley"],
                  ["South Africa – Nelspruit", "Pearson - South Africa – Nelspruit"],
                  ["Namibia – Windhoek", "Pearson - Namibia – Windhoek"],
                  ["Mozambique – Maputo", "Pearson - Mozambique – Maputo"],
                  ["Mozambique – Tofo", "Pearson - Mozambique – Tofo"],
                  ["Tutors and Exams – Valencia", "Pearson - Tutors and Exams – Valencia"]
                ],
                "Cambridge" => [
                  ["International School of Palmela/Partner School - Portugal (Center/North)", "Cambridge - International School of Palmela/Partner School - Portugal (Center/North)"],
                  ["Aljezur International School/Partner School - Portugal (South)", "Cambridge - Aljezur International School/Partner School - Portugal (South)"],
                  ["El Plantio International School – Valencia", "Cambridge - El Plantio International School – Valencia"]
                ],
                "Pearson & Cambridge" => [
                  ["The British School of Málaga – Marbella", "Pearson & Cambridge - The British School of Málaga – Marbella"]
                ],
                "Other" => [
                  ["Remote Invigilation Service", "Other - Remote Invigilation Service"]
                ]
              }, @exam_enroll.bga_exam_centre),
              { prompt: "Select an exam centre" },
              { class: "form-control", disabled: field_disabled?(:bga_exam_centre, current_user) } %>
        </div>
        <div class="col-12 mb-3 mt-3">
          <div class="form-check mb-3">
            <%= f.check_box :has_special_accommodations, class: "form-check-input", disabled: field_disabled?(:has_special_accommodations, current_user) %>
            <%= f.label :has_special_accommodations, "Requires Special Accommodations", class: "form-check-label", disabled: field_disabled?(:has_special_accommodations, current_user) %>
          </div>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :special_accommodations_personalized, "Special Accommodations Details", class: "form-label" %>
          <%= f.text_area :special_accommodations_personalized, class: "form-control", rows: 3, disabled: field_disabled?(:special_accommodations_personalized, current_user) %>
        </div>
        <div class="col-md-6 mb-3">
          <%= f.label :documents, "Doc", class: "form-label", style: "color: rgb(244 244 244)" %>
          <%= f.file_field :documents,
              multiple: true,
              class: "form-control mb-2",
              disabled: field_disabled?(:documents, current_user),
              accept: ".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" %>
          <div class="form-text" style="font-size: 12px;">
            Please upload a recent diagnostic or medical report (in English or with certified translation) from a qualified professional, dated from Year 9 onwards.
            <strong>Only PDF and Word documents are allowed.</strong>
          </div>
          <% if @exam_enroll.exam_enroll_documents.any? %>
            <div class="mt-2">
              <small class="text-muted mb-2 d-block">Current Documents:</small>
              <% @exam_enroll.exam_enroll_documents.each do |document| %>
                <div class="d-flex align-items-center gap-2 mb-2">
                  <span class="text-truncate"><%= document.file_name %></span>
                  <%= link_to "Delete", delete_document_exam_enroll_path(@exam_enroll, document.id),
                      data: { confirm: "Are you sure you want to delete this document?" },
                      class: "btn btn-danger btn-sm" %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
        <div class="col-md-6 mb-3 mt-3">
          <div class="d-flex gap-2">
            <%= f.label :repeating, "Is the learner repeating the exam?", class: "form-check-label" %>
            <%= f.check_box :repeating, class: "form-check-input", disabled: field_disabled?(:repeating, current_user) %>
          </div>
        </div>
        <div class="col-md-6 mb-3 mt-3">
          <div class="d-flex gap-2">
            <%= f.label :graduating, "Is the learner graduating after this exam?", class: "form-check-label" %>
            <%= f.check_box :graduating, class: "form-check-input", disabled: field_disabled?(:graduating, current_user) %>
          </div>
        </div>
        <div class="col-12 mb-3 mt-3">
          <%= f.label :additional_comments, class: "form-label" %>
          <%= f.text_area :additional_comments, class: "form-control", rows: 3, disabled: field_disabled?(:additional_comments, current_user) %>
        </div>
      </div>
    </div>
  </div>

  <div class="accordion" id="approvalAccordion">
    <!-- Pre-registration Exception Section -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed card-header d-flex align-items-center gap-1" type="button" data-bs-toggle="collapse" data-bs-target="#preRegistrationException" style="background-color: #ececec;">
          <h5>Pre-registration Exception</h5>
          <i class="fa-solid fa-circle-info" style="color:rgb(108 117 126);" title="In case your learner has not achieved 80% of progress by the established deadline, but still wants to be enrolled in the respective exam, an exception requirement must be submitted for the educational department to review"></i>
        </button>
      </h2>
      <div id="preRegistrationException" class="accordion-collapse collapse" data-bs-parent="#approvalAccordion">
        <div class="accordion-body">
          <div class="row">
            <div class="col-12 mb-3">
              <%= f.label :pre_registration_exception_justification, "Justification:", class: "form-label" %>
              <%= f.text_area :pre_registration_exception_justification, class: "form-control", rows: 3, disabled: field_disabled?(:pre_registration_exception_justification, current_user) %>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Course Manager Approval</label>
              <div class="btn-group" role="group" aria-label="CM Approval buttons">
                <%= f.radio_button :pre_registration_exception_cm_approval, true,
                    class: 'btn-check',
                    disabled: field_disabled?(:pre_registration_exception_cm_approval, current_user) %>
                <%= f.label :pre_registration_exception_cm_approval_true, 'Approve',
                    class: "btn btn-outline-success" %>

                <%= f.radio_button :pre_registration_exception_cm_approval, false,
                    class: 'btn-check',
                    disabled: field_disabled?(:pre_registration_exception_cm_approval, current_user) %>
                <%= f.label :pre_registration_exception_cm_approval_false, 'Reject',
                    class: "btn btn-outline-danger" %>
              </div>
              <div class="mt-3">
                <%= f.label :pre_registration_exception_cm_comment, "CM Comment", class: "form-label" %>
                <%= f.text_area :pre_registration_exception_cm_comment,
                    class: "form-control",
                    rows: 2,
                    disabled: field_disabled?(:pre_registration_exception_cm_comment, current_user) %>
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Regional Manager Approval</label>
              <div class="btn-group" role="group" aria-label="DC Approval buttons">
                <%= f.radio_button :pre_registration_exception_dc_approval, true,
                    class: 'btn-check',
                    disabled: field_disabled?(:pre_registration_exception_dc_approval, current_user) %>
                <%= f.label :pre_registration_exception_dc_approval_true, 'Approve',
                    class: "btn btn-outline-success" %>

                <%= f.radio_button :pre_registration_exception_dc_approval, false,
                    class: 'btn-check',
                    disabled: field_disabled?(:pre_registration_exception_dc_approval, current_user) %>
                <%= f.label :pre_registration_exception_dc_approval_false, 'Reject',
                    class: "btn btn-outline-danger" %>
              </div>
              <div class="mt-3">
                <%= f.label :pre_registration_exception_dc_comment, "RM Comment", class: "form-label" %>
                <%= f.text_area :pre_registration_exception_dc_comment,
                    class: "form-control",
                    rows: 2,
                    disabled: field_disabled?(:pre_registration_exception_dc_comment, current_user) %>
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Education Team Approval</label>
              <div class="btn-group" role="group" aria-label="EDU Approval buttons">
                <%= f.radio_button :pre_registration_exception_edu_approval, true,
                    class: 'btn-check',
                    disabled: field_disabled?(:pre_registration_exception_edu_approval, current_user) %>
                <%= f.label :pre_registration_exception_edu_approval_true, 'Approve',
                    class: "btn btn-outline-success" %>

                <%= f.radio_button :pre_registration_exception_edu_approval, false,
                    class: 'btn-check',
                    disabled: field_disabled?(:pre_registration_exception_edu_approval, current_user) %>
                <%= f.label :pre_registration_exception_edu_approval_false, 'Reject',
                    class: "btn btn-outline-danger" %>
              </div>
              <div class="mt-3">
                <%= f.label :pre_registration_exception_edu_comment, "EDU Comment", class: "form-label" %>
                <%= f.text_area :pre_registration_exception_edu_comment,
                    class: "form-control",
                    rows: 2,
                    disabled: field_disabled?(:pre_registration_exception_edu_comment, current_user) %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Failed Mock Exception Section -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed card-header d-flex align-items-center gap-1" type="button" data-bs-toggle="collapse" data-bs-target="#failedMockException" style="background-color: #ececec;">
          <h5>Failed Mock Exception</h5>
          <i class="fa-solid fa-circle-info" style="color:rgb(108 117 126);" title="In case your learner has received a U as the Mock result, but still wants to be enrolled in the respective exam, an exception requirement must be submitted for the educational department to review"></i>
        </button>
      </h2>
      <div id="failedMockException" class="accordion-collapse collapse" data-bs-parent="#approvalAccordion">
        <div class="accordion-body">
          <div class="row">
            <div class="col-12 mb-3">
              <%= f.label :failed_mock_exception_justification, "Justification:", class: "form-label" %>
              <%= f.text_area :failed_mock_exception_justification, class: "form-control", rows: 3, disabled: field_disabled?(:failed_mock_exception_justification, current_user) %>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Course Manager Approval</label>
              <div class="btn-group" role="group" aria-label="CM Approval buttons">
                <%= f.radio_button :failed_mock_exception_cm_approval, true,
                    class: 'btn-check',
                    disabled: field_disabled?(:failed_mock_exception_cm_approval, current_user) %>
                <%= f.label :failed_mock_exception_cm_approval_true, 'Approve',
                    class: "btn btn-outline-success" %>

                <%= f.radio_button :failed_mock_exception_cm_approval, false,
                    class: 'btn-check',
                    disabled: field_disabled?(:failed_mock_exception_cm_approval, current_user) %>
                <%= f.label :failed_mock_exception_cm_approval_false, 'Reject',
                    class: "btn btn-outline-danger" %>
              </div>
              <div class="mt-3">
                <%= f.label :failed_mock_exception_cm_comment, "CM Comment", class: "form-label" %>
                <%= f.text_area :failed_mock_exception_cm_comment,
                    class: "form-control",
                    rows: 2,
                    disabled: field_disabled?(:failed_mock_exception_cm_comment, current_user) %>
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Regional Manager Approval</label>
              <div class="btn-group" role="group" aria-label="DC Approval buttons">
                <%= f.radio_button :failed_mock_exception_dc_approval, true,
                    class: 'btn-check',
                    disabled: field_disabled?(:failed_mock_exception_dc_approval, current_user) %>
                <%= f.label :failed_mock_exception_dc_approval_true, 'Approve',
                    class: "btn btn-outline-success" %>

                <%= f.radio_button :failed_mock_exception_dc_approval, false,
                    class: 'btn-check',
                    disabled: field_disabled?(:failed_mock_exception_dc_approval, current_user) %>
                <%= f.label :failed_mock_exception_dc_approval_false, 'Reject',
                    class: "btn btn-outline-danger" %>
              </div>
              <div class="mt-3">
                <%= f.label :failed_mock_exception_dc_comment, "RM Comment", class: "form-label" %>
                <%= f.text_area :failed_mock_exception_dc_comment,
                    class: "form-control",
                    rows: 2,
                    disabled: field_disabled?(:failed_mock_exception_dc_comment, current_user) %>
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Education Team Approval</label>
              <div class="btn-group" role="group" aria-label="EDU Approval buttons">
                <%= f.radio_button :failed_mock_exception_edu_approval, true,
                    class: 'btn-check',
                    disabled: field_disabled?(:failed_mock_exception_edu_approval, current_user) %>
                <%= f.label :failed_mock_exception_edu_approval_true, 'Approve',
                    class: "btn btn-outline-success" %>

                <%= f.radio_button :failed_mock_exception_edu_approval, false,
                    class: 'btn-check',
                    disabled: field_disabled?(:failed_mock_exception_edu_approval, current_user) %>
                <%= f.label :failed_mock_exception_edu_approval_false, 'Reject',
                    class: "btn btn-outline-danger" %>
              </div>
              <div class="mt-3">
                <%= f.label :failed_mock_exception_edu_comment, "EDU Comment", class: "form-label" %>
                <%= f.text_area :failed_mock_exception_edu_comment,
                    class: "form-control",
                    rows: 2,
                    disabled: field_disabled?(:failed_mock_exception_edu_comment, current_user) %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Extension Approval Section -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed card-header d-flex align-items-center gap-1" type="button" data-bs-toggle="collapse" data-bs-target="#extensionApproval" style="background-color: #ececec;">
         <h5>Extension Approval</h5>
         <i class="fa-solid fa-circle-info" style="color:rgb(108 117 126);" title="In case your learner will not submit the Mock Exam by the established deadline, but still wants to be enrolled in the respective exam, an extension requirement must be submitted for the educational department to review"></i>
        </button>
      </h2>
      <div id="extensionApproval" class="accordion-collapse collapse" data-bs-parent="#approvalAccordion">
        <div class="accordion-body">
          <div class="row">
            <div class="col-12 mb-3">
              <%= f.label :extension_justification, "Justification:", class: "form-label" %>
              <%= f.text_area :extension_justification, class: "form-control", rows: 3, disabled: field_disabled?(:extension_justification, current_user) %>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Course Manager Approval</label>
              <div class="btn-group" role="group" aria-label="CM Approval buttons">
                <%= f.radio_button :extension_cm_approval, "true",
                    class: 'btn-check',
                    disabled: field_disabled?(:extension_cm_approval, current_user) %>
                <%= f.label :extension_cm_approval_true, 'Approve',
                    class: "btn btn-outline-success" %>

                <%= f.radio_button :extension_cm_approval, "false",
                    class: 'btn-check',
                    disabled: field_disabled?(:extension_cm_approval, current_user) %>
                <%= f.label :extension_cm_approval_false, 'Reject',
                    class: "btn btn-outline-danger" %>
              </div>
              <div class="mt-3">
                <%= f.label :extension_cm_comment, "CM Comment", class: "form-label" %>
                <%= f.text_area :extension_cm_comment,
                    class: "form-control",
                    rows: 2,
                    disabled: field_disabled?(:extension_cm_comment, current_user) %>
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Regional Manager Approval</label>
              <div class="btn-group" role="group" aria-label="DC Approval buttons">
                <%= f.radio_button :extension_dc_approval, "true",
                    class: 'btn-check',
                    disabled: field_disabled?(:extension_dc_approval, current_user) %>
                <%= f.label :extension_dc_approval_true, 'Approve',
                    class: "btn btn-outline-success" %>

                <%= f.radio_button :extension_dc_approval, "false",
                    class: 'btn-check',
                    disabled: field_disabled?(:extension_dc_approval, current_user) %>
                <%= f.label :extension_dc_approval_false, 'Reject',
                    class: "btn btn-outline-danger" %>
              </div>
              <div class="mt-3">
                <%= f.label :extension_dc_comment, "RM Comment", class: "form-label" %>
                <%= f.text_area :extension_dc_comment,
                    class: "form-control",
                    rows: 2,
                    disabled: field_disabled?(:extension_dc_comment, current_user) %>
              </div>
            </div>

            <div class="col-md-4 mb-3">
              <label class="form-label">Education Team Approval</label>
              <div class="btn-group" role="group" aria-label="EDU Approval buttons">
                <%= f.radio_button :extension_edu_approval, "true",
                    class: 'btn-check',
                    disabled: field_disabled?(:extension_edu_approval, current_user) %>
                <%= f.label :extension_edu_approval_true, 'Approve',
                    class: "btn btn-outline-success" %>

                <%= f.radio_button :extension_edu_approval, "false",
                    class: 'btn-check',
                    disabled: field_disabled?(:extension_edu_approval, current_user) %>
                <%= f.label :extension_edu_approval_false, 'Reject',
                    class: "btn btn-outline-danger" %>
              </div>
              <div class="mt-3">
                <%= f.label :extension_edu_comment, "EDU Comment", class: "form-label" %>
                <%= f.text_area :extension_edu_comment,
                    class: "form-control",
                    rows: 2,
                    disabled: field_disabled?(:extension_edu_comment, current_user) %>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="form-actions mt-4 d-flex justify-content-center mb-3 gap-2">
    <%= f.submit "Update Exam Register", class: "btn btn-primary" %>
    <%= link_to "Back", exam_enrolls_path, class: "btn btn-secondary" %>
  </div>
<% end %>

<style>
  .btn-check {
  position: absolute;
  clip: rect(0,0,0,0);
  pointer-events: none;
}

.btn-check:checked + .btn-outline-success {
  color: #fff;
  background-color: #198754;
  border-color: #198754;
}

.btn-check:checked + .btn-outline-danger {
  color: #fff;
  background-color: #dc3545;
  border-color: #dc3545;
}

.btn-check:checked + .btn-outline-secondary {
  color: #fff;
  background-color: #6c757d;
  border-color: #6c757d;
}

.btn-group {
  display: flex;
  gap: 5px;
}

.accordion-button:not(.collapsed) {
  background-color: #ececec !important;
  color: inherit;
}

.accordion-button {
  background-color: #ececec !important;
}

.accordion-button:focus {
  box-shadow: none;
  border-color: rgba(0,0,0,.125);
}

.accordion-item {
  margin-bottom: 1rem;
}

.accordion-button:hover {
  background-color: #ececec !important;
}

.accordion-button,
.accordion-button:not(.collapsed),
.accordion-button:hover,
.accordion-button:focus {
  color: #212529;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const fileInput = document.querySelector('input[type="file"][name="exam_enroll[documents][]"]');
  const progressCheckbox = document.querySelector('#exam_enroll_progress_cut_off');
  const form = document.querySelector('form');
  const isAdmin = <%= current_user.role == 'admin' ? 'true' : 'false' %>;

  if (fileInput) {
    fileInput.addEventListener('change', function(e) {
      const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
      const allowedExtensions = ['.pdf', '.doc', '.docx'];

      Array.from(e.target.files).forEach(file => {
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

        if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
          alert(`File "${file.name}" is not allowed. Only PDF and Word documents are permitted.`);
          e.target.value = ''; // Clear the input
          return false;
        }
      });
    });
  }

  if (progressCheckbox && isAdmin) {
    form.addEventListener('submit', function(e) {
      console.log('Form submitted');
      console.log('User role: <%= current_user.role %>');
      console.log('Progress checkbox checked:', progressCheckbox.checked);

      if (progressCheckbox && !progressCheckbox.checked) {
        e.preventDefault();
        alert('⚠️ WARNING: Progress cut-off is not met!\n\nPlease verify the learner\'s progress or proceed with an exception request.');
        return false;
      }
    });
  }
});

function removeLearningCoach(lcId) {
  if (confirm('Are you sure you want to remove this Learning Coach?')) {
    fetch(`/exam_enrolls/<%= @exam_enroll.id %>/remove_lc`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      },
      body: JSON.stringify({ lc_id: lcId })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Remove the LC from the DOM
        document.getElementById(`lc-${lcId}`).remove();

        // Show success message
        showFlashMessage('Learning Coach removed successfully', 'success');

        // Check if container is empty
        const container = document.getElementById('learning-coaches-container');
        if (container.children.length === 0) {
          container.innerHTML = '<div class="col-12 text-center text-muted"><p>No learning coaches assigned</p></div>';
        }
      } else {
        showFlashMessage(data.error || 'Failed to remove Learning Coach', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showFlashMessage('An error occurred while removing the Learning Coach', 'error');
    });
  }
}

function showFlashMessage(message, type) {
  const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
  const alertHtml = `
    <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  `;

  // Add to top of the form
  const form = document.querySelector('form');
  form.insertAdjacentHTML('afterbegin', alertHtml);
}
</script>
