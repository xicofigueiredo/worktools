<style>
  .li-section {
    border: 1px solid #000;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 18px;
    background: #fff;
  }
  .li-section h4 { margin-top: 0; margin-bottom: 12px; font-weight: 600;
  }

  .editable-input,
  .editable-input:enabled {
    background-color: #f3f8ff;
    border-color: #cfe4ff;
    color: #111;
  }

  input[disabled].form-control,
  textarea[disabled].form-control,
  select[disabled].form-select {
    background-color: #ffffff;
    border-color: #e0e0e0;
    color: #444;
    opacity: 1;
  }

  input.form-control, textarea.form-control, select.form-select, input[type="date"].form-control {
    border-radius: 4px;
    padding: .375rem .5rem;
  }

  .form-control-plaintext {
    background: transparent;
    color: #212529;
    padding-top: .375rem;
    padding-bottom: .375rem;
  }
</style>


<% edit_mode = params[:edit] == '1' || @learner_info.errors.any? %>
<% perm = @permission || LearnerInfoPermission.new(current_user, @learner_info) %>
<% visible_learner_fields = perm.visible_learner_fields.map(&:to_sym) %>
<% visible_finance_fields = perm.visible_finance_fields.map(&:to_sym) %>
<% editable_attrs = edit_mode ? perm.permitted_attributes.map(&:to_sym) : [] %>
<% finance_editable_attrs = edit_mode ? perm.finance_permitted_attributes.map(&:to_sym) : [] %>

<%# Grade/Year options per curriculum %>
<% grades_per_curriculum = {
  "British Curriculum" => ["UK Year 13", "UK Year 12", "UK Year 11", "UK Year 10", "UK Year 9", "UK Year 8"],
  "American Curriculum" => ["US Year 12", "US Year 11", "US Year 10", "US Year 9", "US Year 8", "US Year 7", "US Year 6", "US Year 5"],
  "Portuguese Curriculum" => ["PT Year 12", "PT Year 11", "PT Year 10", "PT Year 9", "PT Year 8", "PT Year 7"],
  "Own Curriculum" => ["N/A"],
  "ESL Course" => ["N/A"],
  "UP Business" => ["Level 3", "Level 4", "Level 5", "Level 6"],
  "UPx Business" => ["Level 3", "Level 4", "Level 5", "Level 6"],
  "UP Sports Management" => ["Level 3", "Level 4", "Level 5", "Level 6"],
  "UP Sports Exercise" => ["Level 3", "Level 4", "Level 5", "Level 6"],
  "UP Computing" => ["Level 3", "Level 4", "Level 5", "Level 6"]
} %>

<%# Field presentation hints: type, grid column, rows, choices for selects %>
<% field_opts = {
  programme: { type: :select, col: '6', choices: [
    "In-Person: Secondary Education",
    "In-Person: UP Programme",
    "Online: Secondary Education",
    "Online: UP Programme",
    "BAS Programme",
    "Own Curriculum"
  ]},
  preferred_name: { col: '6' },
  full_name: { col: '6' },
  student_number: { col: '6' },
  status: { col: '6' },
  curriculum_course_option: { type: :select, col: '6', choices: [
    "British Curriculum",
    "American Curriculum",
    "Portuguese Curriculum",
    "Own Curriculum",
    "ESL Course",
    "UP Business",
    "UPx Business",
    "UP Sports Management",
    "UP Sports Exercise",
    "UP Computing"
  ]},
  grade_year: { type: :select, col: '6', choices: grades_per_curriculum[@learner_info.curriculum_course_option] || [], prompt: 'Select Grade/Year' },
  start_date: { type: :date, col: '3' },
  birthdate: { type: :date, col: '4' },
  transfer_of_programme_date: { type: :date, col: '3' },
  end_date: { type: :date, col: '3' },
  end_day_communication: { col: '3' },
  personal_email: { type: :email, col: '6' },
  institutional_email: { type: :email, col: '6' },
  phone_number: { col: '6' },
  home_address: { type: :text_area, rows: 2, col: '12' },
  nationality: { col: '6' },
  gender: { type: :select, col: '6', choices: ['Male', 'Female', 'Other'] },
  native_language: { col: '6' },
  english_proficiency: { type: :toggle, col: '6' },
  data_validated: { type: :toggle, col: '6' }, # NEW: Added toggle for data_validated
  parent1_full_name: { col: '6' },
  parent1_email: { type: :email, col: '6' },
  parent1_phone_number: { col: '6' },
  parent1_id_information: { col: '6' },
  parent2_full_name: { col: '6' },
  parent2_email: { type: :email, col: '6' },
  parent2_phone_number: { col: '6' },
  parent2_id_information: { col: '6' },
  parent2_info_not_to_be_contacted: { type: :text_area, rows: 2, col: '12' },
  registering_school_pt_plus: { col: '6' },
  previous_schooling: { type: :select, col: '6', choices: [
    "Abroad",
    "National Private",
    "National Public",
    "Homeschooled"
  ]},
  previous_school_status: { col: '6' },
  previous_school_name: { col: '6' },
  previous_school_email: { type: :email, col: '6' },
  previous_school_grade_year: { col: '6' },
  id_information: { col: '6' },
  fiscal_number: { col: '6' },
  use_of_image_authorisation: { type: :checkbox, col: '6' },
  emergency_protocol_choice: { col: '6' },
  withdrawal_category: { type: :select, col: '6', choices: [
    "Moved abroad",
    "Balencing Studies",
    "No adaptation - Back to traditional",
    "No adaptation - Back to online",
    "Lack of Support or Guidance",
    "Lack of Social aspects",
    "Accreditation",
    "Expelled",
    "Learning Dificulties",
    "Changed Curriculum",
    "Graduated"
  ], include_blank: true },
  withdrawal_reason: { type: :text_area, rows: 2, col: '12' },
  onboarding_meeting_notes: { type: :text_area, rows: 4, col: '12' }
} %>

<% field_opts.merge!({
  payment_plan: { type: :select, col: '6', choices: [
    "N/A",
    "Monthly",
    "Annually",
    "Semi Annual",
    "Quarterly"
  ]},
  financial_responsibility: { type: :text_area, rows: 2, col: '12' },
  monthly_fee: { type: :number, col: '3', step: 1, label: "Monthly Fee (#{@currency_symbol})" },
  discount_mf: { type: :number, col: '3', step: 0.01, min: 0, max: 100, label: "Discount (%)" },
  scholarship: { type: :number, col: '3', step: 0.01, min: 0, max: 100, label: "Scholarship (%)" },
  billable_mf: { type: :number, col: '3', step: 1, readonly: true, label: "Billable Monthly Fee (#{@currency_symbol})" },
  admission_fee: { type: :number, col: '4', step: 1, label: "Admission Fee (#{@currency_symbol})" },
  discount_af: { type: :number, col: '4', step: 0.01, min: 0, max: 100, label: "Discount (%)" },
  billable_af: { type: :number, col: '4', step: 1, readonly: true, label: "Billable Admission Fee (#{@currency_symbol})" },
  renewal_fee: { type: :number, col: '4', step: 1, label: "Renewal Fee (#{@currency_symbol})" },
  discount_rf: { type: :number, col: '4', step: 0.01, min: 0, max: 100, label: "Discount (%)" },
  billable_rf: { type: :number, col: '4', step: 1, readonly: true, label: "Billable Renewal Fee (#{@currency_symbol})" }
}) %>

<% render_input = lambda do |f, attr, opts = {}, is_finance = false, object = @learner_info| %>
  <% attr_sym = attr.to_sym %>
  <% editable_list = is_finance ? finance_editable_attrs : editable_attrs %>
  <% next unless is_finance ? visible_finance_fields.include?(attr_sym) : visible_learner_fields.include?(attr_sym) %>

  <% label = opts[:label] || attr.to_s.humanize %>
  <% type = opts[:type] || :text %>
  <% col = opts[:col] || '12' %>
  <% value = f ? f.object.send(attr) : object.send(attr) %>

  <% # Force disable main fees in edit mode for finance %>
  <% forced_disabled = false %>
  <% if edit_mode && f && is_finance && ['monthly_fee', 'admission_fee', 'renewal_fee'].include?(attr_sym.to_s) %>
    <% forced_disabled = true %>
  <% end %>

  <% disabled_flag = forced_disabled || (!editable_list.include?(attr_sym)) %>

  <% if edit_mode && f %>
    <% input_classes = "form-control" %>
    <% input_classes += " editable-input" unless disabled_flag %>

    <% if attr_sym == :institutional_email %>
      <%= content_tag(:div, class: "mb-3 col-md-#{opts[:col] || 6}") do %>
        <%= f.label(:institutional_email, label) %>
        <%= content_tag(:div, class: "input-group") do %>
          <%= f.text_field(:institutional_email_prefix, value: f.object.institutional_email_prefix, class: input_classes, disabled: disabled_flag, placeholder: "name") %>
          <%= content_tag(:span, "@edubga.com", class: "input-group-text") %>
        <% end %>
      <% end %>
    <% else %>
      <% case type %>
      <% when :text_area %>
        <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
          <%= f.label(attr, label) %>
          <%= f.text_area(attr, rows: opts[:rows] || 2, class: input_classes, disabled: disabled_flag) %>
        <% end %>
      <% when :select %>
        <% choices = opts[:choices] || [] %>
        <% select_classes = disabled_flag ? "form-select" : "form-select editable-input" %>
        <% stimulus_attrs = {} %>
        <% html_options = stimulus_attrs.merge(class: select_classes, disabled: disabled_flag) %>
        <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
          <%= f.label(attr, label) %>
          <%= f.select(attr, choices, { prompt: opts[:prompt] || opts[:include_blank] || false }, html_options) %>
        <% end %>
      <% when :checkbox %>
        <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
          <%= content_tag(:label, class: "form-check") do %>
            <%= f.check_box(attr, disabled: disabled_flag, class: "form-check-input") %>
            <%= " " %>
            <%= content_tag(:span, label, class: "form-check-label") %>
          <% end %>
        <% end %>
      <% when :toggle %>
        <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
          <%= content_tag(:label, label, class: "toggle-label-top") %>
          <%= content_tag(:div, class: "mt-1 form-check form-switch") do %>
            <%= f.check_box(attr, disabled: disabled_flag, class: "form-check-input", id: "switch_#{attr}") %>
          <% end %>
        <% end %>
      <% when :date %>
        <% date_classes = disabled_flag ? "form-control" : "form-control editable-input" %>
        <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
          <%= f.label(attr, label) %>
          <%= f.date_field(attr, class: date_classes, disabled: disabled_flag) %>
        <% end %>
      <% when :email %>
        <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
          <%= f.label(attr, label) %>
          <%= f.email_field(attr, class: input_classes, disabled: disabled_flag, placeholder: "name@example.com", autocomplete: "email") %>
        <% end %>
      <% when :number %>
        <% readonly_flag = opts[:readonly] || false %>
        <% is_blocked = disabled_flag || readonly_flag %>
        <% number_classes = is_blocked ? "form-control bg-light" : "form-control editable-input" %>
        <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
          <%= f.label(attr, label) %>
          <% if is_blocked %>
            <%= content_tag(:div, class: "input-group") do %>
              <%= f.number_field(attr, class: number_classes, disabled: disabled_flag, readonly: true, step: opts[:step] || 1, min: 0, style: "background-color: #e9ecef; cursor: not-allowed;") %>
            <% end %>
          <% else %>
            <%= f.number_field(attr, class: number_classes, disabled: disabled_flag, readonly: disabled_flag, step: opts[:step] || 1, min: opts[:min] || 0, max: opts[:max], value: value) %>
          <% end %>
        <% end %>
      <% else %>
        <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
          <%= f.label(attr, label) %>
          <%= f.text_field(attr, class: input_classes, disabled: disabled_flag) %>
        <% end %>
      <% end %>
    <% end %>
  <% else %>
    <% display_value = case attr_sym
      when :use_of_image_authorisation then (value.to_s.downcase == 'true' || value.to_s.downcase == 'i consent to the above mentioned conditions'.downcase ? "Yes (Consent Given)" : "No (Consent Denied)")
      when :emergency_protocol_choice then value.presence || "-" # FIX: Display raw string instead of Yes/No boolean check
      when :data_validated then value ? "Yes" : "No" # NEW: Display Yes/No for data_validated
      when TrueClass then "Yes"
      when FalseClass then "No"
      when Date, Time, ActiveSupport::TimeWithZone then (value.present? ? value.strftime("%d-%m-%Y") : "-")
      when type == :number && is_finance && value.present?
        discount_attrs = ['discount_mf', 'scholarship', 'discount_af', 'discount_rf']
        if discount_attrs.include?(attr_sym.to_s)
          "#{number_with_precision(value, precision: 2)}%"
        else
          "#{@currency_symbol} #{number_with_precision(value, precision: 2)}"
        end
      else value.presence || "-"
      end %>

    <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
      <%= label_tag(nil, label, class: "form-label") %>
      <% case type %>
      <% when :text_area %>
        <%= tag.textarea(display_value, rows: opts[:rows] || 2, class: "form-control", disabled: true) %>
      <% when :email %>
        <%= tag.input(value: display_value, type: "email", class: "form-control", disabled: true) %>
      <% else %>
        <%= tag.input(value: display_value, type: "text", class: "form-control", disabled: true, readonly: true) %>
      <% end %>
    <% end %>
  <% end %>
<% end %>

<div class="mb-3 d-flex justify-content-end align-items-start">
  <% if edit_mode %>
    <%# Save/Cancel appear inside form %>
  <% else %>
    <div class="d-flex gap-2">
      <% if perm.update? %>
        <%= link_to 'Edit', admission_path(@learner_info, edit: '1'), class: 'btn btn-primary' %>
      <% end %>
      <%= link_to 'Back to list', admissions_path, class: 'btn btn-secondary' %>
    </div>
  <% end %>
</div>

<% if edit_mode %>
  <% if @main_hub %>
  <div data-controller="curriculum-pricing"
      data-curriculum-pricing-hub-id-value="<%= @main_hub.id %>"
      data-curriculum-pricing-current-curriculum-value="<%= @learner_info.curriculum_course_option %>"
      data-curriculum-pricing-current-programme-value="<%= @learner_info.programme %>"
      data-curriculum-pricing-learner-info-id-value="<%= @learner_info.id %>"
      data-curriculum-pricing-model-value="<%= @main_hub.name.downcase == 'remote' ? 'Online' : 'Hybrid' %>"
      data-curriculum-pricing-country-value="<%= @main_hub.country %>"
      data-curriculum-pricing-hub-name-value="<%= @main_hub.name %>"
      data-curriculum-pricing-currency-symbol-value="<%= @currency_symbol %>">
  <% end %>

  <%= form_with model: @learner_info, url: admission_path(@learner_info), method: :patch, local: true, html: { id: 'learner-info-form' } do |f| %>
    <div class="mb-3 d-flex justify-content-end gap-2">
      <%= f.submit "Save changes", class: "btn btn-primary" %>
      <%= link_to 'Cancel', admission_path(@learner_info), class: 'btn btn-secondary' %>
    </div>

    <div class="li-section li-grid">
      <h4>Basic information</h4>
      <div class="row gx-3">
        <% render_input.call(f, :full_name, field_opts[:full_name] || { col: '6' }) %>
        <% render_input.call(f, :preferred_name, field_opts[:preferred_name] || { col: '6' }) %>
        <% render_input.call(f, :student_number, field_opts[:student_number] || { col: '6' }) %>
        <% render_input.call(f, :status, field_opts[:status] || { col: '6' }) %>
        <% render_input.call(f, :birthdate, field_opts[:birthdate] || { type: :date, col: '6' }) %>
        <% render_input.call(f, :programme, field_opts[:programme] || { col: '6' }) %>
        <% render_input.call(f, :curriculum_course_option, field_opts[:curriculum_course_option] || { col: '6' }) %>
        <% render_input.call(f, :grade_year, field_opts[:grade_year] || { col: '6' }) %>
      </div>
    </div>

    <div class="li-section li-grid">
      <h4>Contact information</h4>
      <div class="row gx-3">
        <% render_input.call(f, :personal_email, field_opts[:personal_email] || { col: '6' }) %>
        <% render_input.call(f, :institutional_email, field_opts[:institutional_email] || { col: '6' }) %>
        <% render_input.call(f, :phone_number, field_opts[:phone_number] || { col: '6' }) %>
        <% render_input.call(f, :home_address, field_opts[:home_address] || { type: :text_area, rows: 2, col: '12' }) %>
        <% render_input.call(f, :nationality, field_opts[:nationality] || { col: '6' }) %>
        <% render_input.call(f, :gender, field_opts[:gender] || { col: '6' }) %>
        <% render_input.call(f, :native_language, field_opts[:native_language] || { col: '6' }) %>
        <% render_input.call(f, :english_proficiency, field_opts[:english_proficiency] || { type: :toggle, col: '6' }) %>
      </div>
    </div>

    <div class="li-section li-grid">
      <h4>Parents / Guardians</h4>
      <div class="row gx-3">
        <% render_input.call(f, :parent1_full_name, field_opts[:parent1_full_name] || { col: '6' }) %>
        <% render_input.call(f, :parent1_email, field_opts[:parent1_email] || { col: '6' }) %>
        <% render_input.call(f, :parent1_phone_number, field_opts[:parent1_phone_number] || { col: '6' }) %>
        <% render_input.call(f, :parent1_id_information, field_opts[:parent1_id_information] || { col: '6' }) %>
        <% render_input.call(f, :parent2_full_name, field_opts[:parent2_full_name] || { col: '6' }) %>
        <% render_input.call(f, :parent2_email, field_opts[:parent2_email] || { col: '6' }) %>
        <% render_input.call(f, :parent2_phone_number, field_opts[:parent2_phone_number] || { col: '6' }) %>
        <% render_input.call(f, :parent2_id_information, field_opts[:parent2_id_information] || { col: '6' }) %>
        <% render_input.call(f, :parent2_info_not_to_be_contacted, field_opts[:parent2_info_not_to_be_contacted] || { type: :text_area, rows: 2, col: '12' }) %>
      </div>
    </div>

    <% if perm.finance_visible? %>
      <div class="li-section li-grid">
        <h4>Financial / Payments</h4>
        <%= f.fields_for :learner_finance, @learner_finance do |ff| %>
          <div class="row gx-3">
            <% render_input.call(ff, :payment_plan, field_opts[:payment_plan] || { col: '6' }, true) %>
            <% render_input.call(ff, :financial_responsibility, field_opts[:financial_responsibility] || { type: :text_area, rows: 2, col: '12' }, true) %> <%# NEW FIELD ADDED %>
          </div>

          <h5 style="margin-top: 20px; margin-bottom: 10px;">Monthly Fees</h5>
          <div class="row gx-3">
            <% render_input.call(ff, :monthly_fee, field_opts[:monthly_fee] || { col: '3' }, true) %>
            <% render_input.call(ff, :discount_mf, field_opts[:discount_mf] || { col: '3' }, true) %>
            <% render_input.call(ff, :scholarship, field_opts[:scholarship] || { col: '3' }, true) %>
            <% render_input.call(ff, :billable_mf, field_opts[:billable_mf] || { col: '3' }, true) %>
          </div>

          <h5 style="margin-top: 20px; margin-bottom: 10px;">Admission Fees</h5>
          <div class="row gx-3">
            <% render_input.call(ff, :admission_fee, field_opts[:admission_fee] || { col: '4' }, true) %>
            <% render_input.call(ff, :discount_af, field_opts[:discount_af] || { col: '4' }, true) %>
            <% render_input.call(ff, :billable_af, field_opts[:billable_af] || { col: '4' }, true) %>
          </div>

          <h5 style="margin-top: 20px; margin-bottom: 10px;">Renewal Fees</h5>
          <div class="row gx-3">
            <% render_input.call(ff, :renewal_fee, field_opts[:renewal_fee] || { col: '4' }, true) %>
            <% render_input.call(ff, :discount_rf, field_opts[:discount_rf] || { col: '4' }, true) %>
            <% render_input.call(ff, :billable_rf, field_opts[:billable_rf] || { col: '4' }, true) %>
          </div>
        <% end %>
      </div>
    <% end %>

    <div class="li-section li-grid">
      <h4>School / Previous education</h4>
      <div class="row gx-3">
        <% render_input.call(f, :registering_school_pt_plus, field_opts[:registering_school_pt_plus] || { col: '6' }) %>
        <% render_input.call(f, :previous_schooling, field_opts[:previous_schooling] || { col: '6' }) %>
        <% render_input.call(f, :previous_school_status, field_opts[:previous_school_status] || { col: '6' }) %>
        <% render_input.call(f, :previous_school_name, field_opts[:previous_school_name] || { col: '6' }) %>
        <% render_input.call(f, :previous_school_email, field_opts[:previous_school_email] || { col: '6' }) %>
        <% render_input.call(f, :previous_school_grade_year, field_opts[:previous_school_grade_year] || { col: '6' }) %>
      </div>
    </div>

    <div class="li-section li-grid">
      <h4>Administrative</h4>
      <div class="row gx-3">
        <% render_input.call(f, :id_information, field_opts[:id_information] || { col: '6' }) %>
        <% render_input.call(f, :fiscal_number, field_opts[:fiscal_number] || { col: '6' }) %>
        <% render_input.call(f, :start_date, field_opts[:start_date] || { type: :date, col: '3' }) %>
        <% render_input.call(f, :transfer_of_programme_date, field_opts[:transfer_of_programme_date] || { type: :date, col: '3' }) %>
        <% render_input.call(f, :end_date, field_opts[:end_date] || { type: :date, col: '3' }) %>
        <% render_input.call(f, :end_day_communication, field_opts[:end_day_communication] || { col: '3' }) %>
        <% render_input.call(f, :use_of_image_authorisation, field_opts[:use_of_image_authorisation] || { type: :checkbox, col: '6' }) %>
        <% render_input.call(f, :emergency_protocol_choice, field_opts[:emergency_protocol_choice] || { col: '6' }) %>
        <% render_input.call(f, :data_validated, field_opts[:data_validated] || { type: :toggle, col: '6' }) %> <%# NEW: Added render for data_validated %>
        <% render_input.call(f, :withdrawal_category, field_opts[:withdrawal_category] || { col: '6' }) %>
        <% render_input.call(f, :withdrawal_reason, field_opts[:withdrawal_reason] || { type: :text_area, rows: 2, col: '12' }) %>
        <% render_input.call(f, :onboarding_meeting_notes, field_opts[:onboarding_meeting_notes] || { type: :text_area, rows: 4, col: '12' }) %> <%# NEW: Added render for onboarding notes %>
      </div>
    </div>

  <% end %>

<% else %>
  <div class="li-section li-grid">
    <h4>Basic information</h4>
    <div class="row gx-3">
      <% render_input.call(nil, :full_name, field_opts[:full_name] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :preferred_name, field_opts[:preferred_name] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :student_number, field_opts[:student_number] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :status, field_opts[:status] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :birthdate, field_opts[:birthdate] || { type: :date, col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :programme, field_opts[:programme] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :curriculum_course_option, field_opts[:curriculum_course_option] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :grade_year, field_opts[:grade_year] || { col: '6' }, false, @learner_info) %>
    </div>
  </div>

  <div class="li-section li-grid">
    <h4>Contact information</h4>
    <div class="row gx-3">
      <% render_input.call(nil, :personal_email, field_opts[:personal_email] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :institutional_email, field_opts[:institutional_email] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :phone_number, field_opts[:phone_number] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :home_address, field_opts[:home_address] || { type: :text_area, rows: 2, col: '12' }, false, @learner_info) %>
      <% render_input.call(nil, :nationality, field_opts[:nationality] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :gender, field_opts[:gender] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :native_language, field_opts[:native_language] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :english_proficiency, field_opts[:english_proficiency] || { type: :toggle, col: '6' }, false, @learner_info) %>
    </div>
  </div>

  <div class="li-section li-grid">
    <h4>Parents / Guardians</h4>
    <div class="row gx-3">
      <% render_input.call(nil, :parent1_full_name, field_opts[:parent1_full_name] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :parent1_email, field_opts[:parent1_email] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :parent1_phone_number, field_opts[:parent1_phone_number] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :parent1_id_information, field_opts[:parent1_id_information] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :parent2_full_name, field_opts[:parent2_full_name] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :parent2_email, field_opts[:parent2_email] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :parent2_phone_number, field_opts[:parent2_phone_number] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :parent2_id_information, field_opts[:parent2_id_information] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :parent2_info_not_to_be_contacted, field_opts[:parent2_info_not_to_be_contacted] || { type: :text_area, rows: 2, col: '12' }, false, @learner_info) %>
    </div>
  </div>

  <% if perm.finance_visible? %>
    <div class="li-section li-grid">
      <h4>Financial / Payments</h4>
      <div class="row gx-3">
        <% render_input.call(nil, :payment_plan, field_opts[:payment_plan] || { col: '6' }, true, @learner_finance) %>
        <% render_input.call(nil, :financial_responsibility, field_opts[:financial_responsibility] || { type: :text_area, rows: 2, col: '12' }, true, @learner_finance) %>
      </div>

      <h5 style="margin-top: 20px; margin-bottom: 10px;">Monthly Fees</h5>
      <div class="row gx-3">
        <% render_input.call(nil, :monthly_fee, field_opts[:monthly_fee] || { col: '3' }, true, @learner_finance) %>
        <% render_input.call(nil, :discount_mf, field_opts[:discount_mf] || { col: '3' }, true, @learner_finance) %>
        <% render_input.call(nil, :scholarship, field_opts[:scholarship] || { col: '3' }, true, @learner_finance) %>
        <% render_input.call(nil, :billable_mf, field_opts[:billable_mf] || { col: '3' }, true, @learner_finance) %>
      </div>

      <h5 style="margin-top: 20px; margin-bottom: 10px;">Admission Fees</h5>
      <div class="row gx-3">
        <% render_input.call(nil, :admission_fee, field_opts[:admission_fee] || { col: '4' }, true, @learner_finance) %>
        <% render_input.call(nil, :discount_af, field_opts[:discount_af] || { col: '4' }, true, @learner_finance) %>
        <% render_input.call(nil, :billable_af, field_opts[:billable_af] || { col: '4' }, true, @learner_finance) %>
      </div>

      <h5 style="margin-top: 20px; margin-bottom: 10px;">Renewal Fees</h5>
      <div class="row gx-3">
        <% render_input.call(nil, :renewal_fee, field_opts[:renewal_fee] || { col: '4' }, true, @learner_finance) %>
        <% render_input.call(nil, :discount_rf, field_opts[:discount_rf] || { col: '4' }, true, @learner_finance) %>
        <% render_input.call(nil, :billable_rf, field_opts[:billable_rf] || { col: '4' }, true, @learner_finance) %>
      </div>
    </div>
  <% end %>

  <div class="li-section li-grid">
    <h4>School / Previous education</h4>
    <div class="row gx-3">
      <% render_input.call(nil, :registering_school_pt_plus, field_opts[:registering_school_pt_plus] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :previous_schooling, field_opts[:previous_schooling] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :previous_school_status, field_opts[:previous_school_status] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :previous_school_name, field_opts[:previous_school_name] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :previous_school_email, field_opts[:previous_school_email] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :previous_school_grade_year, field_opts[:previous_school_grade_year] || { col: '6' }, false, @learner_info) %>
    </div>
  </div>

  <div class="li-section li-grid">
    <h4>Administrative</h4>
    <div class="row gx-3">
      <% render_input.call(nil, :id_information, field_opts[:id_information] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :fiscal_number, field_opts[:fiscal_number] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :start_date, field_opts[:start_date] || { type: :date, col: '3' }, false, @learner_info) %>
      <% render_input.call(nil, :transfer_of_programme_date, field_opts[:transfer_of_programme_date] || { type: :date, col: '3' }, false, @learner_info) %>
      <% render_input.call(nil, :end_date, field_opts[:end_date] || { type: :date, col: '3' }, false, @learner_info) %>
      <% render_input.call(nil, :end_day_communication, field_opts[:end_day_communication] || { col: '3' }, false, @learner_info) %>
      <% render_input.call(nil, :use_of_image_authorisation, field_opts[:use_of_image_authorisation] || { type: :checkbox, col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :emergency_protocol_choice, field_opts[:emergency_protocol_choice] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :data_validated, field_opts[:data_validated] || { type: :toggle, col: '6' }, false, @learner_info) %> <%# NEW: Added render for data_validated %>
      <% render_input.call(nil, :withdrawal_category, field_opts[:withdrawal_category] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :withdrawal_reason, field_opts[:withdrawal_reason] || { type: :text_area, rows: 2, col: '12' }, false, @learner_info) %>
      <% render_input.call(nil, :onboarding_meeting_notes, field_opts[:onboarding_meeting_notes] || { type: :text_area, rows: 4, col: '12' }, false, @learner_info) %> <%# NEW: Added render for onboarding notes %>
    </div>
  </div>
<% end %>

<%# Pricing Confirmation Modal %>
<div class="modal fade" id="pricingConfirmationModal" tabindex="-1" aria-hidden="true" data-curriculum-pricing-target="modal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">⚠️ Change Detected - Pricing Confirmation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" data-curriculum-pricing-target="modalBody">
        <div class="alert alert-info">
          <p class="mb-0">
            <strong>Change Detected:</strong><br>
            <span data-curriculum-pricing-target="changesDetails"></span>
          </p>
        </div>

        <div class="card mb-3">
          <div class="card-header">
            <strong>Pricing Tier Criteria</strong>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <strong>Model:</strong> <span id="pricing-model"></span>
              </div>
              <div class="col-md-3">
                <strong>Country:</strong> <span id="pricing-country"></span>
              </div>
              <div class="col-md-3">
                <strong>Hub:</strong> <span id="pricing-hub"></span>
              </div>
              <div class="col-md-3">
                <strong>Curriculum:</strong> <span id="pricing-curriculum"></span>
              </div>
            </div>
          </div>
        </div>

        <h6 class="mb-3">Financial Changes</h6>

        <%# Monthly Fees Section %>
        <div class="card mb-3">
          <div class="card-header bg-light">
            <strong>Monthly Fees</strong>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Current Monthly Fee</label>
                <div class="form-control-plaintext" data-curriculum-pricing-target="oldMonthly"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">New Monthly Fee</label>
                <div class="form-control-plaintext" data-curriculum-pricing-target="newMonthly"></div>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Discount (%)</label>
                <input type="number" class="form-control" data-curriculum-pricing-target="discountMfInput" data-action="input->curriculum-pricing#calculateBillables" step="0.01" min="0" max="100">
              </div>
              <div class="col-md-6">
                <label class="form-label">Scholarship (%)</label>
                <input type="number" class="form-control" data-curriculum-pricing-target="scholarshipInput" data-action="input->curriculum-pricing#calculateBillables" step="0.01" min="0" max="100">
              </div>
            </div>
            <div class="alert alert-secondary mb-0">
              <strong>Billable Monthly Fee:</strong> <span id="billable-mf"></span>
            </div>
          </div>
        </div>

        <%# Admission Fees Section %>
        <div class="card mb-3">
          <div class="card-header bg-light">
            <strong>Admission Fees</strong>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Current Admission Fee</label>
                <div class="form-control-plaintext" data-curriculum-pricing-target="oldAdmission"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">New Admission Fee</label>
                <div class="form-control-plaintext" data-curriculum-pricing-target="newAdmission"></div>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Discount (%)</label>
                <input type="number" class="form-control" data-curriculum-pricing-target="discountAfInput" data-action="input->curriculum-pricing#calculateBillables" step="0.01" min="0" max="100">
              </div>
            </div>
            <div class="alert alert-secondary mb-0">
              <strong>Billable Admission Fee:</strong> <span id="billable-af"></span>
            </div>
          </div>
        </div>

        <%# Renewal Fees Section %>
        <div class="card mb-3">
          <div class="card-header bg-light">
            <strong>Renewal Fees</strong>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Current Renewal Fee</label>
                <div class="form-control-plaintext" data-curriculum-pricing-target="oldRenewal"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">New Renewal Fee</label>
                <div class="form-control-plaintext" data-curriculum-pricing-target="newRenewal"></div>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Discount (%)</label>
                <input type="number" class="form-control" data-curriculum-pricing-target="discountRfInput" data-action="input->curriculum-pricing#calculateBillables" step="0.01" min="0" max="100">
              </div>
            </div>
            <div class="alert alert-secondary mb-0">
              <strong>Billable Renewal Fee:</strong> <span id="billable-rf"></span>
            </div>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-action="click->curriculum-pricing#cancelChanges">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" data-curriculum-pricing-target="confirmButton" data-action="click->curriculum-pricing#confirmChanges">
          Confirm & Save Changes
        </button>
      </div>
    </div>
  </div>
</div>
<% if @main_hub %>
</div>
<% end %>
<script>
  function setupFinanceCalculations() {
    // Auto-calculate billable fields using percentages
    function calculateBillable(feeId, discountId, scholarshipId, billableId) {
      const feeInput = document.getElementById(feeId);
      const discountInput = document.getElementById(discountId);
      const scholarshipInput = scholarshipId ? document.getElementById(scholarshipId) : null;
      const billableInput = document.getElementById(billableId);
      if (!feeInput || !billableInput) return;

      function calculate() {
        const fee = parseFloat(feeInput.value) || 0;
        let discountTotal = parseFloat(discountInput?.value) || 0;
        if (scholarshipInput) {
          discountTotal += parseFloat(scholarshipInput.value) || 0;
        }
        const discountPercent = discountTotal / 100;
        const billable = fee * (1 - discountPercent);
        billableInput.value = Math.max(0, billable).toFixed(2);
      }

      if (feeInput) feeInput.addEventListener('input', calculate);
      if (discountInput) discountInput.addEventListener('input', calculate);
      if (scholarshipInput) scholarshipInput.addEventListener('input', calculate);

      calculate(); // Initial calculation
    }

    // Setup calculations for each fee type
    calculateBillable(
      'learner_info_learner_finance_attributes_monthly_fee',
      'learner_info_learner_finance_attributes_discount_mf',
      'learner_info_learner_finance_attributes_scholarship',
      'learner_info_learner_finance_attributes_billable_mf'
    );
    calculateBillable(
      'learner_info_learner_finance_attributes_admission_fee',
      'learner_info_learner_finance_attributes_discount_af',
      null,
      'learner_info_learner_finance_attributes_billable_af'
    );
    calculateBillable(
      'learner_info_learner_finance_attributes_renewal_fee',
      'learner_info_learner_finance_attributes_discount_rf',
      null,
      'learner_info_learner_finance_attributes_billable_rf'
    );
  }

  // Handle payment plan change for annual discount
  function setupPaymentPlanHandler() {
    const paymentPlanSelect = document.getElementById('learner_info_learner_finance_attributes_payment_plan');
    const discountMfInput = document.getElementById('learner_info_learner_finance_attributes_discount_mf');

    if (paymentPlanSelect && discountMfInput) {
      paymentPlanSelect.addEventListener('change', function() {
        if (this.value === 'Annually') {
          discountMfInput.value = 3;
          discountMfInput.dispatchEvent(new Event('input'));
        }
      });
      // Initial check
      if (paymentPlanSelect.value === 'Annually') {
        discountMfInput.value = 3;
        discountMfInput.dispatchEvent(new Event('input'));
      }
    }
  }

  function setupGradeYearHandler() {
    const curriculumSelect = document.getElementById('learner_info_curriculum_course_option');
    const gradeSelect = document.getElementById('learner_info_grade_year');
    const gradesPerCurriculum = <%= grades_per_curriculum.to_json.html_safe %>;
    if (curriculumSelect && gradeSelect) {
      curriculumSelect.addEventListener('change', function() {
        const options = gradesPerCurriculum[this.value] || [];
        gradeSelect.innerHTML = '';
        const promptOption = document.createElement('option');
        promptOption.value = '';
        promptOption.text = 'Select Grade/Year';
        gradeSelect.add(promptOption);
        options.forEach(function(opt) {
          const option = document.createElement('option');
          option.value = opt;
          option.text = opt;
          gradeSelect.add(option);
        });
        gradeSelect.value = ''; // Reset to prompt, requiring user to select new value
      });
    }
  }

  // Run on page load
  document.addEventListener('DOMContentLoaded', function() {
    setupFinanceCalculations();
    setupPaymentPlanHandler();
    setupGradeYearHandler();
  });
  // Run on Turbo page loads (if using Turbo)
  document.addEventListener('turbo:load', function() {
    setupFinanceCalculations();
    setupPaymentPlanHandler();
    setupGradeYearHandler();
  });
  // Run immediately if DOM is already loaded
  if (document.readyState === 'loading') {
    // Still loading, wait for DOMContentLoaded
  } else {
    // DOM is already ready
    setupFinanceCalculations();
    setupPaymentPlanHandler();
    setupGradeYearHandler();
  }
</script>
