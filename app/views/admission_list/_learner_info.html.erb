<style>
  .li-section {
    border: 1px solid #000;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 18px;
    background: #fff;
  }
  .li-section h4 { margin-top: 0; margin-bottom: 12px; font-weight: 600;
  }

  .editable-input,
  .editable-input:enabled {
    background-color: #f3f8ff;
    border-color: #cfe4ff;
    color: #111;
  }

  input[disabled].form-control,
  textarea[disabled].form-control,
  select[disabled].form-select {
    background-color: #ffffff;
    border-color: #e0e0e0;
    color: #444;
    opacity: 1;
  }

  input.form-control, textarea.form-control, select.form-select, input[type="date"].form-control {
    border-radius: 4px;
    padding: .375rem .5rem;
  }

  .form-control-plaintext {
    background: transparent;
    color: #212529;
    padding-top: .375rem;
    padding-bottom: .375rem;
  }
</style>


<% edit_mode = params[:edit] == '1' || @learner_info.errors.any? %>
<% perm = @permission || LearnerInfoPermission.new(current_user, @learner_info) %>
<% visible_learner_fields = perm.visible_learner_fields.map(&:to_sym) %>
<% visible_finance_fields = perm.visible_finance_fields.map(&:to_sym) %>
<% editable_attrs = edit_mode ? perm.permitted_attributes.map(&:to_sym) : [] %>
<% finance_editable_attrs = edit_mode ? perm.finance_permitted_attributes.map(&:to_sym) : [] %>

<%# Grade/Year options per curriculum %>
<% grades_per_curriculum = {
  "British Curriculum" => ["UK Year 13", "UK Year 12", "UK Year 11", "UK Year 10", "UK Year 9", "UK Year 8"],
  "American Curriculum" => ["US Year 12", "US Year 11", "US Year 10", "US Year 9", "US Year 8", "US Year 7", "US Year 6", "US Year 5"],
  "Portuguese Curriculum" => ["PT Year 12", "PT Year 11", "PT Year 10", "PT Year 9", "PT Year 8", "PT Year 7"],
  "Own Curriculum" => ["N/A"],
  "ESL Course" => ["N/A"],
  "UP Business" => ["Level 3", "Level 4", "Level 5", "Level 6"],
  "UPx Business" => ["Level 3", "Level 4", "Level 5", "Level 6"],
  "UP Sports Management" => ["Level 3", "Level 4", "Level 5", "Level 6"],
  "UP Sports Exercise" => ["Level 3", "Level 4", "Level 5", "Level 6"],
  "UP Computing" => ["Level 3", "Level 4", "Level 5", "Level 6"]
} %>

<%# Prepare hub options based on programme %>
<% hub_options_by_programme = {
  "Online" => @online_hubs || [],
  "Hybrid" => @hybrid_hubs || []
} %>

<%# Field presentation hints: type, grid column, rows, choices for selects %>
<% field_opts = {
  programme: { type: :select, col: '6', choices: [
    "Hybrid",
    "Online"
  ]},
  hub_id: { type: :select, col: '6', choices: [], prompt: 'Select Hub' },
  preferred_name: { col: '6' },
  full_name: { col: '6' },
  student_number: { col: '6' },
  status: { type: :select, col: '6', choices: [
    "Active",
    "Inactive",
    "Onboarded",
    "Validated",
    "In progress - ok",
    "In progress",
    "In progress conditional",
    "Waitlist",
    "Waitlist - ok",
    "Graduated"
  ]},
  curriculum_course_option: { type: :select, col: '6', choices: [
    "British Curriculum",
    "American Curriculum",
    "Portuguese Curriculum",
    "Own Curriculum",
    "ESL Course",
    "UP Business",
    "UPx Business",
    "UP Sports Management",
    "UP Sports Exercise",
    "UP Computing",
    "UP Business (GENEX)"
  ]},
  grade_year: { type: :select, col: '6', choices: grades_per_curriculum[@learner_info.curriculum_course_option] || [], prompt: 'Select Grade/Year' },
  start_date: { type: :date, col: '3' },
  birthdate: { type: :date, col: '4' },
  transfer_of_programme_date: { type: :date, col: '3' },
  end_date: { type: :date, col: '3' },
  end_day_communication: { col: '3' },
  personal_email: { type: :email, col: '6' },
  institutional_email: { type: :email, col: '6' },
  phone_number: { col: '6' },
  home_address: { type: :text_area, rows: 2, col: '12' },
  nationality: { col: '6' },
  gender: { type: :select, col: '6', choices: ['Male', 'Female', 'Other'] },
  native_language: { col: '6' },
  english_proficiency: { type: :toggle, col: '6' },
  data_validated: { type: :toggle, col: '6' },
  learning_coach: { col: '6' },
  parent1_full_name: { col: '6' },
  parent1_email: { type: :email, col: '6' },
  parent1_phone_number: { col: '6' },
  parent1_id_information: { col: '6' },
  parent2_full_name: { col: '6' },
  parent2_email: { type: :email, col: '6' },
  parent2_phone_number: { col: '6' },
  parent2_id_information: { col: '6' },
  parent2_info_not_to_be_contacted: { type: :text_area, rows: 2, col: '12' },
  registering_school_pt_plus: { col: '6' },
  previous_schooling: { type: :select, col: '6', choices: [
    "Abroad",
    "National Private",
    "National Public",
    "Homeschooled"
  ]},
  previous_school_status: { col: '6' },
  previous_school_name: { col: '6' },
  previous_school_email: { type: :email, col: '6' },
  previous_school_grade_year: { col: '6' },
  id_information: { col: '6' },
  fiscal_number: { col: '6' },
  use_of_image_authorisation: { type: :checkbox, col: '6' },
  emergency_protocol_choice: { col: '6' },
  withdrawal_category: { type: :select, col: '6', choices: [
    "Moved abroad",
    "Balencing Studies",
    "No adaptation - Back to traditional",
    "No adaptation - Back to online",
    "Lack of Support or Guidance",
    "Lack of Social aspects",
    "Accreditation",
    "Expelled",
    "Learning Dificulties",
    "Changed Curriculum",
    "Graduated"
  ], include_blank: true },
  withdrawal_reason: { type: :text_area, rows: 2, col: '12' },
  onboarding_meeting_notes: { type: :text_area, rows: 4, col: '12' },
  notes: { type: :text_area, rows: 4, col: '12' },
  platform_username: { col: '6' },
  platform_password: { col: '6' }
} %>

<% field_opts.merge!({
  has_debt: { type: :toggle, col: '6', label: "Has Debt" },
  payment_plan: { type: :select, col: '6', choices: [
    "N/A",
    "Monthly",
    "Annually",
    "Semi Annual",
    "Quarterly"
  ]},
  financial_responsibility: { type: :select, col: '6', choices: [
    "Parent 1",
    "Parent 2",
    "Learner",
    "Other"
  ]},
  invoice_email: { type: :email, col: '6' },
  monthly_fee: { type: :number, col: '3', step: 1, label: "Monthly Fee (#{@currency_symbol})" },
  discount_mf: { type: :number, col: '3', step: 0.01, min: 0, max: 100, label: "Discount (%)" },
  scholarship: { type: :number, col: '3', step: 0.01, min: 0, max: 100, label: "Scholarship (%)" },
  billable_mf: { type: :number, col: '3', step: 1, readonly: true, label: "Billable Monthly Fee (#{@currency_symbol})" },
  admission_fee: { type: :number, col: '4', step: 1, label: "Admission Fee (#{@currency_symbol})" },
  discount_af: { type: :number, col: '4', step: 0.01, min: 0, max: 100, label: "Discount (%)" },
  billable_af: { type: :number, col: '4', step: 1, readonly: true, label: "Billable Admission Fee (#{@currency_symbol})" },
  renewal_fee: { type: :number, col: '4', step: 1, label: "Renewal Fee (#{@currency_symbol})" },
  discount_rf: { type: :number, col: '4', step: 0.01, min: 0, max: 100, label: "Discount (%)" },
  billable_rf: { type: :number, col: '4', step: 1, readonly: true, label: "Billable Renewal Fee (#{@currency_symbol})" },
  notes: { type: :text_area, rows: 4, col: '12' }
}) %>

<% render_input = lambda do |f, attr, opts = {}, is_finance = false, object = @learner_info| %>
  <% attr_sym = attr.to_sym %>
  <% editable_list = is_finance ? finance_editable_attrs : editable_attrs %>
  <% next unless is_finance ? visible_finance_fields.include?(attr_sym) : visible_learner_fields.include?(attr_sym) %>

  <% label = opts[:label] || attr.to_s.humanize %>
  <% type = opts[:type] || :text %>
  <% col = opts[:col] || '12' %>
  <% value = f ? f.object.send(attr) : object.send(attr) %>

  <% disabled_flag = (!editable_list.include?(attr_sym)) %>

  <% if edit_mode && f %>
    <% input_classes = "form-control" %>
    <% input_classes += " editable-input" unless disabled_flag %>

    <% if attr_sym == :institutional_email %>
      <%= content_tag(:div, class: "mb-3 col-md-#{opts[:col] || 6}") do %>
        <%= f.label(:institutional_email, label) %>
        <%= content_tag(:div, class: "input-group") do %>
          <%= f.text_field(:institutional_email_prefix, value: f.object.institutional_email_prefix, class: input_classes, disabled: disabled_flag, placeholder: "name") %>
          <%= content_tag(:span, "@edubga.com", class: "input-group-text") %>
        <% end %>
      <% end %>
    <% elsif attr_sym == :hub_id %>
      <%# Dynamic hub select with forced blank + online/hybrid hubs only %>
      <% select_classes = disabled_flag ? "form-select" : "form-select editable-input" %>
      <% current_programme = f.object.programme.presence || "Online" %>
      <% hub_choices = hub_options_by_programme[current_programme] || [] %>

      <%# Build options HTML manually to force blank + preserve current value if not in list %>
      <% options_html = "<option value=\"\">#{opts[:prompt] || 'Select Hub'}</option>" %>
      <% options_html += options_for_select(hub_choices, selected: f.object.hub_id) %>

      <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
        <%= f.label(attr, label) %>
        <%= f.select attr,
              options_html.html_safe,
              {},
              class: select_classes,
              disabled: disabled_flag,
              id: 'learner_info_hub_id',
              data: {
                'online-hubs': hub_options_by_programme['Online'].to_json,
                'hybrid-hubs': hub_options_by_programme['Hybrid'].to_json
              } %>
      <% end %>
    <% else %>
      <% case type %>
      <% when :text_area %>
        <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
          <%= f.label(attr, label) %>
          <%= f.text_area(attr, rows: opts[:rows] || 2, class: input_classes, disabled: disabled_flag) %>
        <% end %>
      <% when :select %>
        <% choices = opts[:choices] || [] %>
        <% select_classes = disabled_flag ? "form-select" : "form-select editable-input" %>
        <% stimulus_attrs = {} %>
        <% html_options = stimulus_attrs.merge(class: select_classes, disabled: disabled_flag) %>
        <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
          <%= f.label(attr, label) %>
          <%= f.select(attr, choices, { prompt: opts[:prompt] || opts[:include_blank] || false }, html_options) %>
        <% end %>
      <% when :checkbox %>
        <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
          <%= content_tag(:label, class: "form-check") do %>
            <%= f.check_box(attr, disabled: disabled_flag, class: "form-check-input") %>
            <%= " " %>
            <%= content_tag(:span, label, class: "form-check-label") %>
          <% end %>
        <% end %>
      <% when :toggle %>
        <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
          <%= content_tag(:label, label, class: "toggle-label-top") %>
          <%= content_tag(:div, class: "mt-1 form-check form-switch") do %>
            <%= f.check_box(attr, disabled: disabled_flag, class: "form-check-input", id: "switch_#{attr}") %>
          <% end %>
        <% end %>
      <% when :date %>
        <% date_classes = disabled_flag ? "form-control" : "form-control editable-input" %>
        <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
          <%= f.label(attr, label) %>
          <%= f.date_field(attr, class: date_classes, disabled: disabled_flag) %>
        <% end %>
      <% when :email %>
        <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
          <%= f.label(attr, label) %>
          <%= f.email_field(attr, class: input_classes, disabled: disabled_flag, placeholder: "name@example.com", autocomplete: "email") %>
        <% end %>
      <% when :number %>
        <% readonly_flag = opts[:readonly] || false %>
        <% is_blocked = disabled_flag || readonly_flag %>
        <% number_classes = is_blocked ? "form-control bg-light" : "form-control editable-input" %>
        <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
          <%= f.label(attr, label) %>
          <% if is_blocked %>
            <%= content_tag(:div, class: "input-group") do %>
              <%= f.number_field(attr, class: number_classes, disabled: disabled_flag, readonly: true, step: opts[:step] || 1, min: 0, style: "background-color: #e9ecef; cursor: not-allowed;") %>
            <% end %>
          <% else %>
            <%= f.number_field(attr, class: number_classes, disabled: disabled_flag, readonly: disabled_flag, step: opts[:step] || 1, min: opts[:min] || 0, max: opts[:max], value: value) %>
          <% end %>
        <% end %>
      <% else %>
        <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
          <%= f.label(attr, label) %>
          <%= f.text_field(attr, class: input_classes, disabled: disabled_flag) %>
        <% end %>
      <% end %>
    <% end %>
  <% else %>
    <% # View mode display logic %>
    <% if attr_sym == :hub_id %>
      <% display_value = @learner_info.hub&.name || "-" %>
    <% else %>
      <% display_value = case attr_sym
        when :use_of_image_authorisation then (value.to_s.downcase == 'true' || value.to_s.downcase == 'i consent to the above mentioned conditions'.downcase ? "Yes (Consent Given)" : "No (Consent Denied)")
        when :emergency_protocol_choice then value.presence || "-"
        when :data_validated then value ? "Yes" : "No"
        when TrueClass then "Yes"
        when FalseClass then "No"
        when Date, Time, ActiveSupport::TimeWithZone then (value.present? ? value.strftime("%d-%m-%Y") : "-")
        when type == :number && is_finance && value.present?
          discount_attrs = ['discount_mf', 'scholarship', 'discount_af', 'discount_rf']
          if discount_attrs.include?(attr_sym.to_s)
            "#{number_with_precision(value, precision: 2)}%"
          else
            "#{@currency_symbol} #{number_with_precision(value, precision: 2)}"
          end
        else value.presence || "-"
        end %>
    <% end %>

    <%= content_tag(:div, class: "mb-3 col-md-#{col}") do %>
      <%= label_tag(nil, label, class: "form-label") %>
      <% case type %>
      <% when :text_area %>
        <%= tag.textarea(display_value, rows: opts[:rows] || 2, class: "form-control", disabled: true) %>
      <% when :email %>
        <%= tag.input(value: display_value, type: "email", class: "form-control", disabled: true) %>
      <% else %>
        <%= tag.input(value: display_value, type: "text", class: "form-control", disabled: true, readonly: true) %>
      <% end %>
    <% end %>
  <% end %>
<% end %>

<div class="mb-3 d-flex justify-content-end align-items-start">
  <% if edit_mode %>
    <%# Save/Cancel appear inside form %>
  <% else %>
    <div class="d-flex gap-2">
      <% if perm.update? %>
        <%= link_to 'Edit', admission_path(@learner_info, edit: '1'), class: 'btn btn-primary' %>
      <% end %>
      <%= link_to 'Back to list', admissions_path, class: 'btn btn-secondary' %>
    </div>
  <% end %>
</div>

<% if edit_mode %>
  <%# Build the data attributes hash for Stimulus controller %>
  <% stimulus_data = {} %>
  <% if @main_hub %>
    <% stimulus_data = {
      controller: "curriculum-pricing",
      curriculum_pricing_hub_id_value: @main_hub.id,
      curriculum_pricing_current_curriculum_value: @learner_info.curriculum_course_option,
      curriculum_pricing_current_programme_value: @learner_info.programme,
      curriculum_pricing_learner_info_id_value: @learner_info.id,
      curriculum_pricing_model_value: @main_hub.hub_type == 'Online' ? 'Online' : 'Hybrid',
      curriculum_pricing_country_value: @main_hub.country,
      curriculum_pricing_hub_name_value: @main_hub.name,
      curriculum_pricing_currency_symbol_value: @currency_symbol
    } %>
  <% end %>

  <%= form_with model: @learner_info,
                url: admission_path(@learner_info),
                method: :patch,
                local: true,
                html: {
                  id: 'learner-info-form',
                  data: stimulus_data
                } do |f| %>

    <%= f.hidden_field :learning_coach_id, id: 'hidden-learning-coach-id' %>

    <div class="mb-3 d-flex justify-content-end gap-2">
      <%= f.submit "Save changes", class: "btn btn-primary" %>
      <%= link_to 'Cancel', admission_path(@learner_info), class: 'btn btn-secondary' %>
    </div>

    <div class="li-section li-grid">
      <h4>Basic information</h4>
      <div class="row gx-3">
        <% render_input.call(f, :full_name, field_opts[:full_name] || { col: '6' }) %>
        <% render_input.call(f, :preferred_name, field_opts[:preferred_name] || { col: '6' }) %>
        <% render_input.call(f, :student_number, field_opts[:student_number] || { col: '6' }) %>
        <% render_input.call(f, :status, field_opts[:status] || { col: '6' }) %>
        <% render_input.call(f, :birthdate, field_opts[:birthdate] || { type: :date, col: '6' }) %>
        <% render_input.call(f, :programme, field_opts[:programme] || { col: '6' }) %>
        <div id="learning-coach-field" class="mb-3 col-md-6" style="<%= @learner_info.programme == 'Online' ? '' : 'display: none;' %>">
          <%= f.label :learning_coach_id, "Learning Coach" %>
          <div class="input-group">
            <input type="text"
                  id="learning-coach-display"
                  value="<%= @learner_info.learning_coach&.full_name || '-' %>"
                  class="form-control"
                  disabled>
            <button type="button"
                    class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#learningCoachModal"
                    id="change-coach-btn"
                    <%= 'disabled' unless perm.editable_field?(:learning_coach_id) %>>
              <%= @learner_info.learning_coach ? "Change" : "Select" %> Learning Coach
            </button>
          </div>
        </div>
        <% render_input.call(f, :hub_id, field_opts[:hub_id] || { type: :select, col: '6' }) %>
        <% render_input.call(f, :curriculum_course_option, field_opts[:curriculum_course_option] || { col: '6' }) %>
        <% render_input.call(f, :grade_year, field_opts[:grade_year] || { col: '6' }) %>
      </div>
    </div>

    <div class="li-section li-grid">
      <h4>Contact information</h4>
      <div class="row gx-3">
        <% render_input.call(f, :personal_email, field_opts[:personal_email] || { col: '6' }) %>
        <% render_input.call(f, :institutional_email, field_opts[:institutional_email] || { col: '6' }) %>
        <% render_input.call(f, :phone_number, field_opts[:phone_number] || { col: '6' }) %>
        <% render_input.call(f, :home_address, field_opts[:home_address] || { type: :text_area, rows: 2, col: '12' }) %>
        <% render_input.call(f, :nationality, field_opts[:nationality] || { col: '6' }) %>
        <% render_input.call(f, :gender, field_opts[:gender] || { col: '6' }) %>
        <% render_input.call(f, :native_language, field_opts[:native_language] || { col: '6' }) %>
        <% render_input.call(f, :english_proficiency, field_opts[:english_proficiency] || { type: :toggle, col: '6' }) %>
      </div>
    </div>

    <div class="li-section li-grid">
      <h4>Parents / Guardians</h4>
      <div class="row gx-3">
        <% render_input.call(f, :parent1_full_name, field_opts[:parent1_full_name] || { col: '6' }) %>
        <% render_input.call(f, :parent1_email, field_opts[:parent1_email] || { col: '6' }) %>
        <% render_input.call(f, :parent1_phone_number, field_opts[:parent1_phone_number] || { col: '6' }) %>
        <% render_input.call(f, :parent1_id_information, field_opts[:parent1_id_information] || { col: '6' }) %>
        <% render_input.call(f, :parent2_full_name, field_opts[:parent2_full_name] || { col: '6' }) %>
        <% render_input.call(f, :parent2_email, field_opts[:parent2_email] || { col: '6' }) %>
        <% render_input.call(f, :parent2_phone_number, field_opts[:parent2_phone_number] || { col: '6' }) %>
        <% render_input.call(f, :parent2_id_information, field_opts[:parent2_id_information] || { col: '6' }) %>
        <% render_input.call(f, :parent2_info_not_to_be_contacted, field_opts[:parent2_info_not_to_be_contacted] || { type: :text_area, rows: 2, col: '12' }) %>
      </div>
    </div>

    <% if perm.finance_visible? %>
      <div class="li-section li-grid">
        <h4>Financial / Payments</h4>
        <% if @learner_finance.present? %>
          <%= f.fields_for :learner_finance, @learner_finance do |ff| %>
            <div class="row gx-3">
              <% render_input.call(ff, :payment_plan, field_opts[:payment_plan] || { col: '6' }, true) %>
              <% render_input.call(ff, :has_debt, field_opts[:has_debt] || { type: :toggle, col: '6' }, true) %>
              <% render_input.call(ff, :financial_responsibility, field_opts[:financial_responsibility] || { col: '6' }, true) %>
              <% render_input.call(ff, :invoice_email, field_opts[:invoice_email] || { type: :email, col: '6' }, true) %>
            </div>

            <h5 style="margin-top: 20px; margin-bottom: 10px;">Monthly Fees</h5>
            <div class="row gx-3">
              <% render_input.call(ff, :monthly_fee, field_opts[:monthly_fee] || { col: '3' }, true) %>
              <% render_input.call(ff, :discount_mf, field_opts[:discount_mf] || { col: '3' }, true) %>
              <% render_input.call(ff, :scholarship, field_opts[:scholarship] || { col: '3' }, true) %>
              <% render_input.call(ff, :billable_mf, field_opts[:billable_mf] || { col: '3' }, true) %>
            </div>

            <h5 style="margin-top: 20px; margin-bottom: 10px;">Admission Fees</h5>
            <div class="row gx-3">
              <% render_input.call(ff, :admission_fee, field_opts[:admission_fee] || { col: '4' }, true) %>
              <% render_input.call(ff, :discount_af, field_opts[:discount_af] || { col: '4' }, true) %>
              <% render_input.call(ff, :billable_af, field_opts[:billable_af] || { col: '4' }, true) %>
            </div>

            <h5 style="margin-top: 20px; margin-bottom: 10px;">Renewal Fees</h5>
            <div class="row gx-3">
              <% render_input.call(ff, :renewal_fee, field_opts[:renewal_fee] || { col: '4' }, true) %>
              <% render_input.call(ff, :discount_rf, field_opts[:discount_rf] || { col: '4' }, true) %>
              <% render_input.call(ff, :billable_rf, field_opts[:billable_rf] || { col: '4' }, true) %>
            </div>

            <div class="row gx-3">
              <% render_input.call(ff, :notes, field_opts[:notes] || { type: :text_area, rows: 4, col: '12' }, true) %>
            </div>
          <% end %>
        <% else %>
          <div class="alert alert-warning text-center" style="margin-top: 20px;">
            Financial plan not defined. Please set the learner's hub to define the financial plan.
          </div>
        <% end %>
      </div>
    <% end %>

    <div class="li-section li-grid">
      <h4>School / Previous education</h4>
      <div class="row gx-3">
        <% render_input.call(f, :registering_school_pt_plus, field_opts[:registering_school_pt_plus] || { col: '6' }) %>
        <% render_input.call(f, :previous_schooling, field_opts[:previous_schooling] || { col: '6' }) %>
        <% render_input.call(f, :previous_school_status, field_opts[:previous_school_status] || { col: '6' }) %>
        <% render_input.call(f, :previous_school_name, field_opts[:previous_school_name] || { col: '6' }) %>
        <% render_input.call(f, :previous_school_email, field_opts[:previous_school_email] || { col: '6' }) %>
        <% render_input.call(f, :previous_school_grade_year, field_opts[:previous_school_grade_year] || { col: '6' }) %>
      </div>
    </div>

    <div class="li-section li-grid">
      <h4>Administrative</h4>
      <div class="row gx-3">
        <% render_input.call(f, :id_information, field_opts[:id_information] || { col: '6' }) %>
        <% render_input.call(f, :fiscal_number, field_opts[:fiscal_number] || { col: '6' }) %>
        <% render_input.call(f, :start_date, field_opts[:start_date] || { type: :date, col: '3' }) %>
        <% render_input.call(f, :transfer_of_programme_date, field_opts[:transfer_of_programme_date] || { type: :date, col: '3' }) %>
        <% render_input.call(f, :end_date, field_opts[:end_date] || { type: :date, col: '3' }) %>
        <% render_input.call(f, :end_day_communication, field_opts[:end_day_communication] || { col: '3' }) %>
        <% render_input.call(f, :platform_username, field_opts[:platform_username] || { col: '6' }) %>
        <% render_input.call(f, :platform_password, field_opts[:platform_password] || { col: '6' }) %>
        <% render_input.call(f, :use_of_image_authorisation, field_opts[:use_of_image_authorisation] || { type: :checkbox, col: '6' }) %>
        <% render_input.call(f, :emergency_protocol_choice, field_opts[:emergency_protocol_choice] || { col: '6' }) %>
        <% render_input.call(f, :data_validated, field_opts[:data_validated] || { type: :toggle, col: '6' }) %>
        <% render_input.call(f, :withdrawal_category, field_opts[:withdrawal_category] || { col: '6' }) %>
        <% render_input.call(f, :withdrawal_reason, field_opts[:withdrawal_reason] || { type: :text_area, rows: 2, col: '12' }) %>
        <% render_input.call(f, :onboarding_meeting_notes, field_opts[:onboarding_meeting_notes] || { type: :text_area, rows: 4, col: '12' }) %>
        <% render_input.call(f, :notes, field_opts[:notes] || { type: :text_area, rows: 4, col: '12' }) %>
      </div>
    </div>

    <%# Pricing Confirmation Modal - NOW INSIDE THE FORM %>
    <% if @main_hub %>
      <div class="modal fade" id="pricingConfirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">⚠️ Change Detected - Pricing Confirmation</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-info">
                <p class="mb-0">
                  <strong>Change Detected:</strong><br>
                  <span data-curriculum-pricing-target="changesDetails"></span>
                </p>
              </div>

              <div class="card mb-3">
                <div class="card-header">
                  <strong>Pricing Tier Criteria</strong>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-3">
                      <strong>Model:</strong> <span id="pricing-model"></span>
                    </div>
                    <div class="col-md-3">
                      <strong>Country:</strong> <span id="pricing-country"></span>
                    </div>
                    <div class="col-md-3">
                      <strong>Hub:</strong> <span id="pricing-hub"></span>
                    </div>
                    <div class="col-md-3">
                      <strong>Curriculum:</strong> <span id="pricing-curriculum"></span>
                    </div>
                  </div>
                </div>
              </div>

              <h6 class="mb-3">Financial Changes</h6>

              <%# Monthly Fees Section %>
              <div class="card mb-3">
                <div class="card-header bg-light">
                  <strong>Monthly Fees</strong>
                </div>
                <div class="card-body">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Current Monthly Fee</label>
                      <div class="form-control-plaintext" data-curriculum-pricing-target="oldMonthly"></div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">New Monthly Fee</label>
                      <div class="form-control-plaintext" data-curriculum-pricing-target="newMonthly"></div>
                    </div>
                  </div>
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <label class="form-label">Discount (%)</label>
                      <input type="number" class="form-control" data-curriculum-pricing-target="discountMfInput" onchange="window.curriculumPricingController?.calculateBillables()" step="0.01" min="0" max="100">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Scholarship (%)</label>
                      <input type="number" class="form-control" data-curriculum-pricing-target="scholarshipInput" onchange="window.curriculumPricingController?.calculateBillables()" step="0.01" min="0" max="100">
                    </div>
                  </div>
                  <div class="alert alert-secondary ms-3 mb-0">
                    <strong>Billable Monthly Fee:</strong> <span id="billable-mf"></span>
                  </div>
                </div>
              </div>

              <%# Admission Fees Section %>
              <div class="card mb-3">
                <div class="card-header bg-light">
                  <strong>Admission Fees</strong>
                </div>
                <div class="card-body">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Current Admission Fee</label>
                      <div class="form-control-plaintext" data-curriculum-pricing-target="oldAdmission"></div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">New Admission Fee</label>
                      <div class="form-control-plaintext" data-curriculum-pricing-target="newAdmission"></div>
                    </div>
                  </div>
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <label class="form-label">Discount (%)</label>
                      <input type="number" class="form-control" data-curriculum-pricing-target="discountAfInput" onchange="window.curriculumPricingController?.calculateBillables()" step="0.01" min="0" max="100">
                    </div>
                  </div>
                  <div class="alert alert-secondary ms-3 mb-0">
                    <strong>Billable Admission Fee:</strong> <span id="billable-af"></span>
                  </div>
                </div>
              </div>

              <%# Renewal Fees Section %>
              <div class="card mb-3">
                <div class="card-header bg-light">
                  <strong>Renewal Fees</strong>
                </div>
                <div class="card-body">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Current Renewal Fee</label>
                      <div class="form-control-plaintext" data-curriculum-pricing-target="oldRenewal"></div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">New Renewal Fee</label>
                      <div class="form-control-plaintext" data-curriculum-pricing-target="newRenewal"></div>
                    </div>
                  </div>
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <label class="form-label">Discount (%)</label>
                      <input type="number" class="form-control" data-curriculum-pricing-target="discountRfInput" onchange="window.curriculumPricingController?.calculateBillables()" step="0.01" min="0" max="100">
                    </div>
                  </div>
                  <div class="alert alert-secondary ms-3 mb-0">
                    <strong>Billable Renewal Fee:</strong> <span id="billable-rf"></span>
                  </div>
                </div>
              </div>

            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="pricing-cancel-btn">
                Cancel
              </button>
              <button type="button" class="btn btn-primary" id="pricing-confirm-btn">
                Confirm & Save Changes
              </button>
            </div>
          </div>
        </div>
      </div>
    <% end %>

  <% end %>

<% else %>
  <div class="li-section li-grid">
    <h4>Basic information</h4>
    <div class="row gx-3">
      <% render_input.call(nil, :full_name, field_opts[:full_name] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :preferred_name, field_opts[:preferred_name] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :student_number, field_opts[:student_number] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :status, field_opts[:status] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :birthdate, field_opts[:birthdate] || { type: :date, col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :programme, field_opts[:programme] || { col: '6' }, false, @learner_info) %>
      <div id="learning-coach-field" class="mb-3 col-md-6" style="<%= @learner_info.programme == 'Online' ? '' : 'display: none;' %>">
        <%= label_tag(nil, "Learning Coach", class: "form-label") %>
        <%= tag.input(value: @learner_info.learning_coach&.full_name || "-", type: "text", class: "form-control", disabled: true) %>
      </div>
      <% render_input.call(nil, :hub_id, field_opts[:hub_id] || { type: :select, col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :curriculum_course_option, field_opts[:curriculum_course_option] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :grade_year, field_opts[:grade_year] || { col: '6' }, false, @learner_info) %>
    </div>
  </div>

  <div class="li-section li-grid">
    <h4>Contact information</h4>
    <div class="row gx-3">
      <% render_input.call(nil, :personal_email, field_opts[:personal_email] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :institutional_email, field_opts[:institutional_email] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :phone_number, field_opts[:phone_number] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :home_address, field_opts[:home_address] || { type: :text_area, rows: 2, col: '12' }, false, @learner_info) %>
      <% render_input.call(nil, :nationality, field_opts[:nationality] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :gender, field_opts[:gender] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :native_language, field_opts[:native_language] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :english_proficiency, field_opts[:english_proficiency] || { type: :toggle, col: '6' }, false, @learner_info) %>
    </div>
  </div>

  <div class="li-section li-grid">
    <h4>Parents / Guardians</h4>
    <div class="row gx-3">
      <% render_input.call(nil, :parent1_full_name, field_opts[:parent1_full_name] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :parent1_email, field_opts[:parent1_email] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :parent1_phone_number, field_opts[:parent1_phone_number] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :parent1_id_information, field_opts[:parent1_id_information] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :parent2_full_name, field_opts[:parent2_full_name] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :parent2_email, field_opts[:parent2_email] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :parent2_phone_number, field_opts[:parent2_phone_number] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :parent2_id_information, field_opts[:parent2_id_information] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :parent2_info_not_to_be_contacted, field_opts[:parent2_info_not_to_be_contacted] || { type: :text_area, rows: 2, col: '12' }, false, @learner_info) %>
    </div>
  </div>

  <% if perm.finance_visible? %>
    <div class="li-section li-grid">
      <h4>Financial / Payments</h4>
      <% if @learner_finance.present? %>
        <div class="row gx-3">
          <% render_input.call(nil, :payment_plan, field_opts[:payment_plan] || { col: '6' }, true, @learner_finance) %>
          <% render_input.call(nil, :has_debt, field_opts[:has_debt] || { type: :toggle, col: '6' }, true, @learner_finance) %>
          <% render_input.call(nil, :financial_responsibility, field_opts[:financial_responsibility] || { col: '6' }, true, @learner_finance) %>
          <% render_input.call(nil, :invoice_email, field_opts[:invoice_email] || { type: :email, col: '6' }, true, @learner_finance) %>
        </div>

        <h5 style="margin-top: 20px; margin-bottom: 10px;">Monthly Fees</h5>
        <div class="row gx-3">
          <% render_input.call(nil, :monthly_fee, field_opts[:monthly_fee] || { col: '3' }, true, @learner_finance) %>
          <% render_input.call(nil, :discount_mf, field_opts[:discount_mf] || { col: '3' }, true, @learner_finance) %>
          <% render_input.call(nil, :scholarship, field_opts[:scholarship] || { col: '3' }, true, @learner_finance) %>
          <% render_input.call(nil, :billable_mf, field_opts[:billable_mf] || { col: '3' }, true, @learner_finance) %>
        </div>

        <h5 style="margin-top: 20px; margin-bottom: 10px;">Admission Fees</h5>
        <div class="row gx-3">
          <% render_input.call(nil, :admission_fee, field_opts[:admission_fee] || { col: '4' }, true, @learner_finance) %>
          <% render_input.call(nil, :discount_af, field_opts[:discount_af] || { col: '4' }, true, @learner_finance) %>
          <% render_input.call(nil, :billable_af, field_opts[:billable_af] || { col: '4' }, true, @learner_finance) %>
        </div>

        <h5 style="margin-top: 20px; margin-bottom: 10px;">Renewal Fees</h5>
        <div class="row gx-3">
          <% render_input.call(nil, :renewal_fee, field_opts[:renewal_fee] || { col: '4' }, true, @learner_finance) %>
          <% render_input.call(nil, :discount_rf, field_opts[:discount_rf] || { col: '4' }, true, @learner_finance) %>
          <% render_input.call(nil, :billable_rf, field_opts[:billable_rf] || { col: '4' }, true, @learner_finance) %>
        </div>

        <div class="row gx-3">
          <% render_input.call(nil, :notes, field_opts[:notes] || { type: :text_area, rows: 4, col: '12' }, true, @learner_finance) %>
        </div>
      <% else %>
        <div class="alert alert-warning text-center" style="margin-top: 20px;">
          Financial plan not defined. Please set the learner's hub to define the financial plan.
        </div>
      <% end %>
    </div>
  <% end %>

  <div class="li-section li-grid">
    <h4>School / Previous education</h4>
    <div class="row gx-3">
      <% render_input.call(nil, :registering_school_pt_plus, field_opts[:registering_school_pt_plus] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :previous_schooling, field_opts[:previous_schooling] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :previous_school_status, field_opts[:previous_school_status] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :previous_school_name, field_opts[:previous_school_name] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :previous_school_email, field_opts[:previous_school_email] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :previous_school_grade_year, field_opts[:previous_school_grade_year] || { col: '6' }, false, @learner_info) %>
    </div>
  </div>

  <div class="li-section li-grid">
    <h4>Administrative</h4>
    <div class="row gx-3">
      <% render_input.call(nil, :id_information, field_opts[:id_information] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :fiscal_number, field_opts[:fiscal_number] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :start_date, field_opts[:start_date] || { type: :date, col: '3' }, false, @learner_info) %>
      <% render_input.call(nil, :transfer_of_programme_date, field_opts[:transfer_of_programme_date] || { type: :date, col: '3' }, false, @learner_info) %>
      <% render_input.call(nil, :end_date, field_opts[:end_date] || { type: :date, col: '3' }, false, @learner_info) %>
      <% render_input.call(nil, :end_day_communication, field_opts[:end_day_communication] || { col: '3' }, false, @learner_info) %>
      <% render_input.call(nil, :platform_username, field_opts[:platform_username] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :platform_password, field_opts[:platform_password] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :use_of_image_authorisation, field_opts[:use_of_image_authorisation] || { type: :checkbox, col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :emergency_protocol_choice, field_opts[:emergency_protocol_choice] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :data_validated, field_opts[:data_validated] || { type: :toggle, col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :withdrawal_category, field_opts[:withdrawal_category] || { col: '6' }, false, @learner_info) %>
      <% render_input.call(nil, :withdrawal_reason, field_opts[:withdrawal_reason] || { type: :text_area, rows: 2, col: '12' }, false, @learner_info) %>
      <% render_input.call(nil, :onboarding_meeting_notes, field_opts[:onboarding_meeting_notes] || { type: :text_area, rows: 4, col: '12' }, false, @learner_info) %>
      <% render_input.call(nil, :notes, field_opts[:notes] || { type: :text_area, rows: 4, col: '12' }, false, @learner_info) %>
    </div>
  </div>
<% end %>

<script>
  // Store controller reference globally when it connects
  document.addEventListener('stimulus:connect', function(event) {
    if (event.detail.controller.identifier === 'curriculum-pricing') {
      window.curriculumPricingController = event.detail.controller;
    }
  });
</script>

<%# Start Date Year Warning Modal %>
<div class="modal fade" id="startDateWarningModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">⚠️ Start Date Year Warning</h5>
      </div>
      <div class="modal-body">
        <p>The start date you selected is for <strong id="selected-year-display"></strong>, not the current year (<%= Date.today.year %>).</p>
        <p class="mb-0"><strong>Did you update the pricing accordingly?</strong></p>
        <p class="text-muted small">Different years may have different pricing tiers. Please ensure the financial information is correct for the selected year.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="start-date-go-back-btn">
          No, Go Back & Fix
        </button>
        <button type="button" class="btn btn-warning" id="start-date-confirm-btn">
          Yes, Save Anyway
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Learning Coach Selection  -->
<% if @sorted_coaches %>
  <div class="modal fade" id="learningCoachModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Select Learning Coach</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Select</th>
                <th>Name</th>
                <th>Email</th>
                <th>Hub</th>
                <th># LC in Hub</th>
                <th># Kids in Hub</th>
                <th># Remote Learners</th>
                <th>Ratio</th>
              </tr>
            </thead>
            <tbody>
              <% if @sorted_coaches.empty? %>
                <tr><td colspan="8">No suggested learning coaches available.</td></tr>
              <% else %>
                <% @sorted_coaches.each do |data| %>
                  <% coach = data[:coach] %>
                  <tr>
                    <td>
                      <input type="radio"
                            class="lc-radio"
                            name="temp_learning_coach_id"
                            value="<%= coach.id %>"
                            <%= 'checked' if @learner_info.learning_coach_id == coach.id %>>
                    </td>
                    <td><%= coach.full_name %></td>
                    <td><%= coach.email %></td>
                    <td><%= data[:main_hub].name %></td>
                    <td><%= data[:lc_count] %></td>
                    <td><%= data[:kids_count] %></td>
                    <td><%= data[:remote_count] %></td>
                    <td><%= number_with_precision(data[:ratio], precision: 2) %></td>
                  </tr>
                <% end %>
              <% end %>

              <tr class="table-warning"> <td>
                  <input type="radio"
                        name="temp_learning_coach_id"
                        id="other_coach_radio"
                        value=""
                        class="lc-radio">
                </td>
                <td colspan="8">
                  <div class="d-flex align-items-center">
                    <strong class="me-3">Other:</strong>

                    <select class="form-select" id="other_coach_select" style="max-width: 900px;">
                      <option value="" selected disabled>Select a different coach...</option>
                      <% @all_coaches.each do |coach| %>
                        <option value="<%= coach.id %>">
                          <%= coach.full_name %> (<%= coach.email %>)
                        </option>
                      <% end %>
                    </select>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirm-coach-btn">Confirm Selection</button>
        </div>
      </div>
    </div>
  </div>
<% end %>

<script>
  function setupFinanceCalculations() {
    // Auto-calculate billable fields using percentages
    function calculateBillable(feeId, discountId, scholarshipId, billableId) {
      const feeInput = document.getElementById(feeId);
      const discountInput = document.getElementById(discountId);
      const scholarshipInput = scholarshipId ? document.getElementById(scholarshipId) : null;
      const billableInput = document.getElementById(billableId);
      if (!feeInput || !billableInput) return;

      function calculate() {
        const fee = parseFloat(feeInput.value) || 0;
        let discountTotal = parseFloat(discountInput?.value) || 0;
        if (scholarshipInput) {
          discountTotal += parseFloat(scholarshipInput.value) || 0;
        }
        const discountPercent = discountTotal / 100;
        const billable = fee * (1 - discountPercent);
        billableInput.value = Math.max(0, billable).toFixed(2);
      }

      if (feeInput) feeInput.addEventListener('input', calculate);
      if (discountInput) discountInput.addEventListener('input', calculate);
      if (scholarshipInput) scholarshipInput.addEventListener('input', calculate);

      calculate(); // Initial calculation
    }

    // Setup calculations for each fee type
    calculateBillable(
      'learner_info_learner_finance_attributes_monthly_fee',
      'learner_info_learner_finance_attributes_discount_mf',
      'learner_info_learner_finance_attributes_scholarship',
      'learner_info_learner_finance_attributes_billable_mf'
    );
    calculateBillable(
      'learner_info_learner_finance_attributes_admission_fee',
      'learner_info_learner_finance_attributes_discount_af',
      null,
      'learner_info_learner_finance_attributes_billable_af'
    );
    calculateBillable(
      'learner_info_learner_finance_attributes_renewal_fee',
      'learner_info_learner_finance_attributes_discount_rf',
      null,
      'learner_info_learner_finance_attributes_billable_rf'
    );
  }

  // Handle payment plan change for annual discount
  function setupPaymentPlanHandler() {
    const paymentPlanSelect = document.getElementById('learner_info_learner_finance_attributes_payment_plan');
    const discountMfInput = document.getElementById('learner_info_learner_finance_attributes_discount_mf');

    if (paymentPlanSelect && discountMfInput) {
      paymentPlanSelect.addEventListener('change', function() {
        if (this.value === 'Annually') {
          discountMfInput.value = 3;
          discountMfInput.dispatchEvent(new Event('input'));
        }
      });
      // Initial check
      if (paymentPlanSelect.value === 'Annually') {
        discountMfInput.value = 3;
        discountMfInput.dispatchEvent(new Event('input'));
      }
    }
  }

  function setupGradeYearHandler() {
    const curriculumSelect = document.getElementById('learner_info_curriculum_course_option');
    const gradeSelect = document.getElementById('learner_info_grade_year');
    const gradesPerCurriculum = <%= grades_per_curriculum.to_json.html_safe %>;
    if (curriculumSelect && gradeSelect) {
      curriculumSelect.addEventListener('change', function() {
        const options = gradesPerCurriculum[this.value] || [];
        gradeSelect.innerHTML = '';
        const promptOption = document.createElement('option');
        promptOption.value = '';
        promptOption.text = 'Select Grade/Year';
        gradeSelect.add(promptOption);
        options.forEach(function(opt) {
          const option = document.createElement('option');
          option.value = opt;
          option.text = opt;
          gradeSelect.add(option);
        });
        gradeSelect.value = ''; // Reset to prompt, requiring user to select new value
      });
    }
  }

  function setupLearningCoachSelection() {
    const modal = document.getElementById('learningCoachModal');
    const confirmBtn = document.getElementById('confirm-coach-btn');
    const hiddenField = document.getElementById('hidden-learning-coach-id');
    const displayField = document.getElementById('learning-coach-display');
    const changeBtn = document.getElementById('change-coach-btn');

    // --- NEW ELEMENTS FOR "OTHER" LOGIC ---
    const otherRadio = document.getElementById('other_coach_radio');
    const otherSelect = document.getElementById('other_coach_select');
    const standardRadios = document.querySelectorAll('.lc-radio:not(#other_coach_radio)');

    if (!modal || !confirmBtn || !hiddenField) return;

    // 1. SYNC LOGIC: Handle Dropdown vs Radio interactions
    if (otherSelect && otherRadio) {
      // When dropdown changes, select the radio and update its value
      otherSelect.addEventListener('change', function() {
        if (this.value) {
          otherRadio.checked = true;
          otherRadio.value = this.value; // Set radio value to the Coach ID
        }
      });

      // If user clicks the empty "Other" radio, focus the dropdown
      otherRadio.addEventListener('click', function() {
        if (otherSelect.value === "") {
          otherSelect.focus();
        }
      });
    }

    // If a standard radio is clicked, reset the dropdown
    if (standardRadios.length > 0 && otherSelect) {
      standardRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          otherSelect.value = "";
          otherRadio.value = ""; // Clear value so it doesn't hold old data
        });
      });
    }

    // 2. CONFIRM LOGIC
    confirmBtn.addEventListener('click', function() {
      const selectedRadio = modal.querySelector('input[name="temp_learning_coach_id"]:checked');

      if (selectedRadio) {
        const coachId = selectedRadio.value;
        let coachName = '';

        // Check if the user selected the "Other" radio
        if (selectedRadio.id === 'other_coach_radio' && otherSelect) {
           // Get text from the selected dropdown option
           const selectedOption = otherSelect.options[otherSelect.selectedIndex];
           // Remove the email part if you only want the name, or keep it all.
           // Assuming format: "Name (email@test.com)" -> split to get just Name
           coachName = selectedOption.text.split('(')[0].trim();
        } else {
           // Standard logic: Get text from the 2nd column of the row
           coachName = selectedRadio.closest('tr').querySelector('td:nth-child(2)').textContent.trim();
        }

        // Validate that an ID is actually present (e.g. if they clicked "Other" but didn't pick from dropdown)
        if (!coachId) {
            alert('Please select a valid coach from the list.');
            return;
        }

        // Update hidden field
        hiddenField.value = coachId;

        // Update display
        displayField.value = coachName;

        // Update button text
        changeBtn.textContent = 'Change Learning Coach';

        // Clear any validation errors
        if (displayField) {
          displayField.classList.remove('is-invalid');
          const inputGroup = displayField.parentElement;
          const errorMsg = inputGroup.parentElement.querySelector('.invalid-feedback');
          if (errorMsg) errorMsg.remove();

          // Reset button styling
          if (changeBtn) {
            changeBtn.classList.remove('btn-danger');
            changeBtn.classList.add('btn-primary');
          }
        }

        // Close modal
        bootstrap.Modal.getInstance(modal).hide();
      } else {
        alert('Please select a Learning Coach.');
      }
    });

    // Optional: Re-open modal with current selection
    if (changeBtn) {
      changeBtn.addEventListener('click', function() {
        // Pre-select current coach
        const currentId = hiddenField.value;
        if (currentId) {
          // Check if it's a standard radio
          let radio = modal.querySelector(`.lc-radio[value="${currentId}"]`);

          // If not found in standard list, it might be in the "Other" list
          if (!radio && otherSelect) {
             // Check if the ID exists in the dropdown
             const option = otherSelect.querySelector(`option[value="${currentId}"]`);
             if (option) {
               otherSelect.value = currentId; // Set dropdown
               otherRadio.value = currentId;  // Set radio value
               otherRadio.checked = true;     // Check radio
               return; // Exit
             }
          }

          // If found in standard list
          if (radio) radio.checked = true;
        }
      });
    }
  }

  function setupProgrammeHubHandler() {
    const programmeSelect = document.getElementById('learner_info_programme');
    const hubSelect = document.getElementById('learner_info_hub_id');
    const lcField = document.getElementById('learning-coach-field');
    const form = document.getElementById('learner-info-form');

    if (!programmeSelect || !hubSelect || !form) return;

    const onlineHubs = JSON.parse(hubSelect.dataset.onlineHubs || '[]');
    const hybridHubs = JSON.parse(hubSelect.dataset.hybridHubs || '[]');
    const originalProgramme = programmeSelect.value;

    // Update hubs + show/hide LC field
    programmeSelect.addEventListener('change', function() {
      const selectedProgramme = this.value;
      const hubs = selectedProgramme === 'Online' ? onlineHubs : hybridHubs;

      // Update hub options
      hubSelect.innerHTML = '';
      const promptOption = document.createElement('option');
      promptOption.value = '';
      promptOption.text = 'Select Hub';
      hubSelect.add(promptOption);
      hubs.forEach(hub => {
        const opt = document.createElement('option');
        opt.value = hub[1];
        opt.text = hub[0];
        hubSelect.add(opt);
      });

      if (selectedProgramme !== originalProgramme) {
        hubSelect.value = '';
      }

      // Show/hide Learning Coach field
      if (lcField) {
        lcField.style.display = selectedProgramme === 'Online' ? 'block' : 'none';
      }
    });
  }

  function setupInvoiceEmailHandler() {
    const financialResponsibilitySelect = document.getElementById('learner_info_learner_finance_attributes_financial_responsibility');
    const invoiceEmailInput = document.getElementById('learner_info_learner_finance_attributes_invoice_email');

    if (!financialResponsibilitySelect || !invoiceEmailInput) return;

    // Get references to email input fields
    const parent1Input = document.getElementById('learner_info_parent1_email');
    const parent2Input = document.getElementById('learner_info_parent2_email');
    const personalInput = document.getElementById('learner_info_personal_email');

    // Check if invoice_email is in the editable list (has editable-input class initially)
    const isInvoiceEmailEditable = invoiceEmailInput.classList.contains('editable-input') ||
                                    !invoiceEmailInput.hasAttribute('disabled');

    function getEmailValues() {
      return {
        parent1: parent1Input?.value || '',
        parent2: parent2Input?.value || '',
        personal: personalInput?.value || ''
      };
    }

    function updateInvoiceEmail() {
      if (!isInvoiceEmailEditable) return; // User doesn't have permission to edit this field at all

      const responsibility = financialResponsibilitySelect.value;
      const emails = getEmailValues();

      switch(responsibility) {
        case 'Parent 1':
          invoiceEmailInput.value = emails.parent1;
          invoiceEmailInput.readOnly = true;
          invoiceEmailInput.classList.remove('editable-input');
          invoiceEmailInput.classList.add('bg-light');
          invoiceEmailInput.style.cursor = 'not-allowed';
          break;
        case 'Parent 2':
          invoiceEmailInput.value = emails.parent2;
          invoiceEmailInput.readOnly = true;
          invoiceEmailInput.classList.remove('editable-input');
          invoiceEmailInput.classList.add('bg-light');
          invoiceEmailInput.style.cursor = 'not-allowed';
          break;
        case 'Learner':
          invoiceEmailInput.value = emails.personal;
          invoiceEmailInput.readOnly = true;
          invoiceEmailInput.classList.remove('editable-input');
          invoiceEmailInput.classList.add('bg-light');
          invoiceEmailInput.style.cursor = 'not-allowed';
          break;
        case 'Other':
          invoiceEmailInput.readOnly = false;
          invoiceEmailInput.classList.add('editable-input');
          invoiceEmailInput.classList.remove('bg-light');
          invoiceEmailInput.style.cursor = 'text';
          // Keep current value when switching to Other, unless it's empty
          if (!invoiceEmailInput.value) {
            invoiceEmailInput.value = '';
          }
          break;
        default:
          // No selection yet
          invoiceEmailInput.readOnly = false;
          invoiceEmailInput.classList.add('editable-input');
          invoiceEmailInput.classList.remove('bg-light');
          invoiceEmailInput.style.cursor = 'text';
      }
    }

    // Listen for changes to financial responsibility
    financialResponsibilitySelect.addEventListener('change', updateInvoiceEmail);

    // Listen for changes to parent/learner emails and update invoice email in real-time
    if (parent1Input) {
      parent1Input.addEventListener('input', function() {
        if (financialResponsibilitySelect.value === 'Parent 1') {
          invoiceEmailInput.value = this.value;
        }
      });
    }

    if (parent2Input) {
      parent2Input.addEventListener('input', function() {
        if (financialResponsibilitySelect.value === 'Parent 2') {
          invoiceEmailInput.value = this.value;
        }
      });
    }

    if (personalInput) {
      personalInput.addEventListener('input', function() {
        if (financialResponsibilitySelect.value === 'Learner') {
          invoiceEmailInput.value = this.value;
        }
      });
    }

    // Initialize on page load
    updateInvoiceEmail();
  }

  // --- Unified form checks: pricing & start-date ---
  function setupFormChecks() {
    const form = document.getElementById('learner-info-form');
    if (!form) return;

    // Elements for start-date modal/check
    const startDateInput = document.getElementById('learner_info_start_date');
    const startModalElement = document.getElementById('startDateWarningModal');
    const startConfirmBtn = document.getElementById('start-date-confirm-btn');
    const startGoBackBtn = document.getElementById('start-date-go-back-btn');

    // Elements for pricing modal/check
    const pricingModalElement = document.getElementById('pricingConfirmationModal');
    const pricingConfirmBtn = document.getElementById('pricing-confirm-btn');
    const pricingCancelBtn = document.getElementById('pricing-cancel-btn');

    // Pricing "changes details" target in modal
    const pricingChangesDetails = document.querySelector('[data-curriculum-pricing-target="changesDetails"]');

    // Flags so we don't loop
    let pricingConfirmed = false;
    let startConfirmed = false;

    const currentYear = new Date().getFullYear();

    function checkStartDateNeeded() {
      if (!startDateInput) return false;
      const val = startDateInput.value;
      if (!val) return false;
      return new Date(val).getFullYear() !== currentYear;
    }

    function updateStartModalYear() {
      if (!startDateInput || !startModalElement) return;
      const val = startDateInput.value;
      const display = startModalElement.querySelector('#selected-year-display');
      if (display && val) display.textContent = new Date(val).getFullYear();
    }

    // Determine whether pricing confirmation is required.
    function checkPricingNeeded() {
      if (!pricingModalElement) return false;

      // If your Stimulus controller exposes a hasChanges() function, prefer it.
      if (window.curriculumPricingController && typeof window.curriculumPricingController.hasChanges === 'function') {
        try {
          return !!window.curriculumPricingController.hasChanges();
        } catch (err) {
          // fall through to other heuristics
        }
      }

      // Fallback: check whether the changesDetails target has content
      if (pricingChangesDetails) {
        return pricingChangesDetails.textContent.trim().length > 0;
      }

      return false;
    }

    // Show a bootstrap modal instance
    function showModal(el) {
      if (!el) return null;
      const inst = new bootstrap.Modal(el);
      inst.show();
      return inst;
    }

    // Hide & fully dispose modal + cleanup backdrop/body
    function cleanupModal(el) {
      if (!el) return;
      const inst = bootstrap.Modal.getInstance(el);
      if (inst) inst.dispose();
      document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
      el.classList.remove('show');
      el.style.display = 'none';
    }

    // Submit listener: show modals in sequence as needed.
    form.addEventListener('submit', function(e) {
      // If both checks are already confirmed, allow submit
      if (pricingConfirmed && startConfirmed) {
        return; // let native submit proceed
      }

      // Priority: pricing first (you can swap order if you prefer start-date first)
      if (!pricingConfirmed && checkPricingNeeded()) {
        e.preventDefault();
        e.stopImmediatePropagation();
        // show pricing modal
        showModal(pricingModalElement);
        return;
      }

      // Next: start date
      if (!startConfirmed && checkStartDateNeeded()) {
        e.preventDefault();
        e.stopImmediatePropagation();
        updateStartModalYear();
        showModal(startModalElement);
        return;
      }

      // else nothing to block -> allow submit
    });

    // Pricing Confirmed -> either show next check or final submit
    if (pricingConfirmBtn) {
      pricingConfirmBtn.addEventListener('click', function() {
        // Prevent Turbo-restore weirdness if you had that issue previously
        document.documentElement.setAttribute('data-turbo-restore', 'false');

        cleanupModal(pricingModalElement);
        pricingConfirmed = true;

        // If start date check still required, show it now
        if (!startConfirmed && checkStartDateNeeded()) {
          updateStartModalYear();
          showModal(startModalElement);
          return;
        }

        // Otherwise final submit (bypass submit listener to avoid re-run)
        try {
          form.submit();
        } catch (err) {
          if (typeof form.requestSubmit === 'function') form.requestSubmit();
          else {
            const submitBtn = form.querySelector('button[type="submit"], input[type="submit"]');
            if (submitBtn) submitBtn.click();
          }
        }
      });
    }

    // Pricing Cancel -> just hide modal and leave form blocked for edits
    if (pricingCancelBtn) {
      pricingCancelBtn.addEventListener('click', function() {
        cleanupModal(pricingModalElement);
      });
    }

    // Start date Confirmed -> either show pricing (if still needed) or submit
    if (startConfirmBtn) {
      startConfirmBtn.addEventListener('click', function() {
        document.documentElement.setAttribute('data-turbo-restore', 'false');

        cleanupModal(startModalElement);
        startConfirmed = true;

        // If pricing still needs confirming, show pricing modal
        if (!pricingConfirmed && checkPricingNeeded()) {
          showModal(pricingModalElement);
          return;
        }

        // Otherwise final submit
        try {
          form.submit();
        } catch (err) {
          if (typeof form.requestSubmit === 'function') form.requestSubmit();
          else {
            const submitBtn = form.querySelector('button[type="submit"], input[type="submit"]');
            if (submitBtn) submitBtn.click();
          }
        }
      });
    }

    // Start date Go Back -> hide and let user fix start date
    if (startGoBackBtn) {
      startGoBackBtn.addEventListener('click', function() {
        cleanupModal(startModalElement);
      });
    }
  }

  // Run on page load
  document.addEventListener('DOMContentLoaded', function() {
    setupFinanceCalculations();
    setupPaymentPlanHandler();
    setupGradeYearHandler();
    setupProgrammeHubHandler();
    setupLearningCoachSelection();
    setupInvoiceEmailHandler();
    setupFormChecks(); // <-- unified checks
  });
  // Run on Turbo page loads (if using Turbo)
  document.addEventListener('turbo:load', function() {
    setupFinanceCalculations();
    setupPaymentPlanHandler();
    setupGradeYearHandler();
    setupProgrammeHubHandler();
    setupLearningCoachSelection();
    setupInvoiceEmailHandler();
    setupFormChecks(); // <-- unified checks
  });
  // Run immediately if DOM is already loaded
  if (document.readyState === 'loading') {
    // Still loading, wait for DOMContentLoaded
  } else {
    // DOM is already ready
    setupFinanceCalculations();
    setupPaymentPlanHandler();
    setupGradeYearHandler();
    setupProgrammeHubHandler();
    setupInvoiceEmailHandler();
    setupFormChecks(); // <-- unified checks
  }
</script>
