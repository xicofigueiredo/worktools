<%
  # Define field categories exactly like in show view
  field_categories = {
    'Basic Information' => [
      :full_name, :preferred_name, :student_number, :start_date, :birthdate,
      :programme, :curriculum_course_option, :grade_year,
      :transfer_of_programme_date, :end_date, :end_day_communication
    ],
    'Contact Information' => [
      :personal_email, :institutional_email, :phone_number, :home_address,
      :nationality, :gender, :native_language, :english_proficiency
    ],
    'Parents / Guardians' => [
      :parent1_full_name, :parent1_email, :parent1_phone_number, :parent1_id_information,
      :parent2_full_name, :parent2_email, :parent2_phone_number, :parent2_id_information,
      :parent2_info_not_to_be_contacted
    ],
    'School / Previous Education' => [
      :registering_school_pt_plus, :previous_schooling, :previous_school_status,
      :previous_school_name, :previous_school_email
    ],
    'Administrative' => [
      :id_information, :fiscal_number, :use_of_image_authorisation,
      :emergency_protocol_choice, :withdrawal_category, :withdrawal_reason
    ]
  }

  # Filter to only show fields the user has permission to see
  visible_categories = field_categories.map do |category_name, fields|
    visible_fields_in_category = fields.select { |f| @visible_learner_fields.include?(f) }
    [category_name, visible_fields_in_category] if visible_fields_in_category.any?
  end.compact.to_h

  if @permission.finance_visible?
    finance_fields = @visible_finance_fields
    if finance_fields.any?
      visible_categories['Financial / Payments'] = finance_fields
    end
  end
%>

<style>
  .li-section {
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 16px;
    background: #fff;
  }

  .li-section h4 {
    margin-top: 0;
    margin-bottom: 12px;
    font-weight: 600;
  }

  .modal-header-custom {
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
    border-bottom: 1px solid #dee2e6;
    padding: 20px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 12px 12px 0 0;
  }

  .modal-body-custom {
    padding: 24px;
  }

  .modal-footer-custom {
    position: sticky;
    bottom: 0;
    background: white;
    z-index: 10;
    border-top: 1px solid #dee2e6;
    padding: 16px 24px;
    border-radius: 0 0 12px 12px;
  }

  .filter-select-box {
    border: 1px solid #ced4da;
    border-radius: 6px;
    padding: 8px;
    max-height: 150px;
    overflow-y: auto;
    background: white;
  }

  .filter-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .filter-option:hover {
    background: #f8f9fa;
  }

  .filter-option input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
  }

  .filter-option label {
    cursor: pointer;
    margin: 0;
    font-size: 0.9rem;
    flex: 1;
  }
</style>

<div class="modal-header-custom">
  <h2 style="margin: 0; font-size: 1.5rem; font-weight: 600;">Export Learners to CSV</h2>
  <button type="button"
          onclick="closeExportModal()"
          style="background: none; border: none; font-size: 28px; color: #666; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px;"
          onmouseover="this.style.background='#f0f0f0'"
          onmouseout="this.style.background='none'"
          aria-label="Close">
    Ã—
  </button>
</div>

<div class="modal-body-custom">
  <%= form_with url: export_admissions_path, method: :post, id: 'exportForm', data: { turbo: false } do |f| %>

    <!-- Filters Section -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
      <h3 style="margin-top: 0; font-size: 1.1rem; margin-bottom: 16px;">Filter Learners to Export</h3>
      <p style="color: #666; font-size: 0.9rem; margin-bottom: 16px;">
        Select multiple options from each filter. Leave all unchecked to export all learners.
      </p>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">

        <!-- Status Filter -->
        <div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label style="font-weight: 600; font-size: 0.95rem;">Status</label>
            <button type="button"
                    onclick="toggleFilterCategory('status')"
                    style="padding: 2px 8px; font-size: 0.8rem; border-radius: 4px; background: #e9ecef; border: 1px solid #ced4da; cursor: pointer;">
              Select All
            </button>
          </div>
          <div class="filter-select-box">
            <% @statuses.each do |status| %>
              <div class="filter-option">
                <%= check_box_tag 'status[]', status, false, id: "status_#{status.parameterize}", data: { filter_category: 'status' } %>
                <%= label_tag "status_#{status.parameterize}", status %>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Hub Filter -->
        <div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label style="font-weight: 600; font-size: 0.95rem;">Hub</label>
            <button type="button"
                    onclick="toggleFilterCategory('hub')"
                    style="padding: 2px 8px; font-size: 0.8rem; border-radius: 4px; background: #e9ecef; border: 1px solid #ced4da; cursor: pointer;">
              Select All
            </button>
          </div>
          <div class="filter-select-box">
            <% @hubs.each do |hub| %>
              <div class="filter-option">
                <%= check_box_tag 'hub[]', hub, false, id: "hub_#{hub.parameterize}", data: { filter_category: 'hub' } %>
                <%= label_tag "hub_#{hub.parameterize}", hub %>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Programme Filter -->
        <div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label style="font-weight: 600; font-size: 0.95rem;">Programme</label>
            <button type="button"
                    onclick="toggleFilterCategory('programme')"
                    style="padding: 2px 8px; font-size: 0.8rem; border-radius: 4px; background: #e9ecef; border: 1px solid #ced4da; cursor: pointer;">
              Select All
            </button>
          </div>
          <div class="filter-select-box">
            <% @programmes.each do |programme| %>
              <div class="filter-option">
                <%= check_box_tag 'programme[]', programme, false, id: "programme_#{programme.parameterize}", data: { filter_category: 'programme' } %>
                <%= label_tag "programme_#{programme.parameterize}", programme %>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Curriculum Filter -->
        <div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label style="font-weight: 600; font-size: 0.95rem;">Curriculum</label>
            <button type="button"
                    onclick="toggleFilterCategory('curriculum')"
                    style="padding: 2px 8px; font-size: 0.8rem; border-radius: 4px; background: #e9ecef; border: 1px solid #ced4da; cursor: pointer;">
              Select All
            </button>
          </div>
          <div class="filter-select-box">
            <% @curricula.each do |curriculum| %>
              <div class="filter-option">
                <%= check_box_tag 'curriculum[]', curriculum, false, id: "curriculum_#{curriculum.parameterize}", data: { filter_category: 'curriculum' } %>
                <%= label_tag "curriculum_#{curriculum.parameterize}", curriculum %>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Grade/Year Filter -->
        <div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <label style="font-weight: 600; font-size: 0.95rem;">Grade / Year</label>
            <button type="button"
                    onclick="toggleFilterCategory('grade_year')"
                    style="padding: 2px 8px; font-size: 0.8rem; border-radius: 4px; background: #e9ecef; border: 1px solid #ced4da; cursor: pointer;">
              Select All
            </button>
          </div>
          <div class="filter-select-box">
            <% @grades.each do |grade| %>
              <div class="filter-option">
                <%= check_box_tag 'grade_year[]', grade, false, id: "grade_year_#{grade.parameterize}", data: { filter_category: 'grade_year' } %>
                <%= label_tag "grade_year_#{grade.parameterize}", grade %>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Age Filter -->
        <div style="grid-column: span 2;">
          <label style="font-weight: 600; font-size: 0.95rem; display: block; margin-bottom: 8px;">Export Age Range</label>
          <div style="display: flex; align-items: center; gap: 12px; background: white; padding: 10px; border-radius: 6px; border: 1px solid #ced4da;">
            <div style="flex: 1;">
              <span style="font-size: 0.8rem; color: #666; display: block;">Min Age</span>
              <%= number_field_tag :age_min, params[:age_min], min: @db_min_age, max: @db_max_age, style: "width: 100%; border: none; outline: none;" %>
            </div>
            <div style="color: #ccc;">|</div>
            <div style="flex: 1;">
              <span style="font-size: 0.8rem; color: #666; display: block;">Max Age</span>
              <%= number_field_tag :age_max, params[:age_max], min: @db_min_age, max: @db_max_age, style: "width: 100%; border: none; outline: none;" %>
            </div>
          </div>
          <p style="font-size: 0.75rem; color: #888; margin-top: 4px;">Adjust range if you only want a specific age group in the CSV.</p>
        </div>

      </div>
    </div>

    <!-- Global select/deselect buttons for fields -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0; font-size: 1.1rem;">Select Fields to Export</h3>
      <div style="display: flex; gap: 8px;">
        <button type="button" onclick="selectAllFields()"
                style="padding: 8px 16px; border-radius: 6px; background: #0d6efd; color: white; border: none; cursor: pointer; font-weight: 500;">
          Select All Fields
        </button>
        <button type="button" onclick="deselectAllFields()"
                style="padding: 8px 16px; border-radius: 6px; background: #6c757d; color: white; border: none; cursor: pointer; font-weight: 500;">
          Deselect All Fields
        </button>
      </div>
    </div>

    <!-- Field selection by category -->
    <div style="display: flex; flex-direction: column; gap: 16px;">
      <% visible_categories.each do |category_name, fields| %>
        <% category_id = category_name.parameterize.underscore %>

        <div class="li-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h4 style="margin: 0; font-weight: 600;"><%= category_name %></h4>
            <div style="display: flex; gap: 8px;">
              <button type="button"
                      onclick="selectCategory('<%= category_id %>')"
                      style="padding: 5px 12px; border-radius: 4px; background: #e9ecef; border: 1px solid #ced4da; cursor: pointer; font-size: 0.875rem;">
                Select All
              </button>
              <button type="button"
                      onclick="deselectCategory('<%= category_id %>')"
                      style="padding: 5px 12px; border-radius: 4px; background: #e9ecef; border: 1px solid #ced4da; cursor: pointer; font-size: 0.875rem;">
                Deselect All
              </button>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px;">
            <% fields.each do |field| %>
              <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 6px; cursor: pointer; background: #f8f9fa; transition: background 0.2s;"
                     onmouseover="this.style.background='#e9ecef'"
                     onmouseout="this.style.background='#f8f9fa'">
                <%= check_box_tag 'fields[]', field, true,
                    class: 'field-checkbox',
                    data: { category: category_id },
                    style: 'width: 18px; height: 18px; cursor: pointer;' %>
                <span style="font-size: 0.9rem;"><%= field.to_s.humanize %></span>
              </label>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<div class="modal-footer-custom">
  <div style="display: flex; gap: 12px; justify-content: space-between; align-items: center;">
    <div style="color: #666; font-size: 0.9rem;">
      <i class="fa fa-info-circle" aria-hidden="true"></i>
      Only fields you have permission to view are shown
    </div>
    <div style="display: flex; gap: 12px;">
      <button type="button"
              onclick="closeExportModal()"
              style="padding: 10px 24px; border-radius: 6px; background: #6c757d; color: white; border: none; cursor: pointer; font-weight: 500;">
        Cancel
      </button>
      <button type="button"
              onclick="submitExport()"
              style="padding: 10px 24px; border-radius: 6px; background: #28a745; color: white; border: none; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 8px;">
        <i class="fa fa-download" aria-hidden="true"></i>
        Download CSV
      </button>
    </div>
  </div>
</div>
