<%#
  Locals:
  - year: Integer
  - holidays_by_date: Hash { Date => [PublicHoliday] }
  - blocked_by_date: Hash { Date => [BlockedPeriod] }
  - mandatory_leaves: Array [MandatoryLeave]
  - visits_by_date: Hash (Optional)
  - read_only: Boolean (default: true)
  - allow_creation: Boolean (default: false)
%>

<% is_hr_or_admin = current_user.email == 'humanresources@bravegenerationacademy.com' || current_user.role == 'admin' %>
<% creation_enabled = local_assigns[:allow_creation] == true %>
<% visits_by_date = local_assigns[:visits_by_date] || {} %>

<div class="row">
  <% (1..12).each do |month| %>
    <div class="col-md-4 mb-3">
      <div class="card month-card h-100 border-0 shadow-sm">
        <div class="card-header bg-white border-bottom py-2">
          <h6 class="mb-0 fw-bold text-uppercase text-dark"><%= Date::MONTHNAMES[month] %></h6>
        </div>
        <div class="card-body p-0">
          <table class="table table-bordered table-sm mb-0 calendar-table">
            <thead class="table-light text-center small text-muted">
               <tr><th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th></tr>
            </thead>
            <tbody>
              <%
                 first = Date.new(year, month, 1)
                 last = first.end_of_month
                 week = 0
                 start_offset = first.wday
              %>

              <% while week * 7 - start_offset < last.day %>
                <tr>
                  <% (0..6).each do |wday| %>
                    <% day_num = week * 7 + wday - start_offset + 1 %>

                    <% if day_num < 1 || day_num > last.day %>
                      <td class="bg-light border-0"></td>
                    <% else %>
                      <% date = Date.new(year, month, day_num) %>
                      <% classes = [] %>
                      <% popover_items = [] %>

                      <%# --- Holidays --- %>
                      <% if events = holidays_by_date[date] %>
                        <% classes << 'holiday' %>
                        <% events.each do |h| %>
                          <% delete_btn = (!read_only && is_hr_or_admin) ? button_to('<i class="fas fa-trash-alt"></i>'.html_safe, public_holiday_path(h), method: :delete, form: { style: 'display:inline-block;' }, class: "btn btn-link text-danger p-0 ms-2 align-baseline", style: "text-decoration: none;", data: { turbo_confirm: "Delete #{h.name}?" }) : "" %>
                          <% popover_items << "<div class='mb-1 pb-1 border-bottom small d-flex justify-content-between align-items-center'><span><strong>#{h.name}</strong></span> #{delete_btn}</div>" %>
                        <% end %>
                      <% end %>

                      <%# --- Mandatory --- %>
                      <% active_mand = mandatory_leaves.select { |m| date >= m.start_date && date <= m.end_date } %>
                      <% if active_mand.any? %>
                        <% classes << 'mandatory' %>
                        <% active_mand.each do |m| %>
                           <% delete_btn = (!read_only && is_hr_or_admin) ? button_to('<i class="fas fa-trash-alt"></i>'.html_safe, mandatory_leafe_path(m), method: :delete, form: { style: 'display:inline-block;' }, class: "btn btn-link text-danger p-0 ms-2 align-baseline", style: "text-decoration: none;", data: { turbo_confirm: "Delete #{m.name}?" }) : "" %>
                           <% popover_items << "<div class='mb-1 pb-1 border-bottom small text-primary d-flex justify-content-between align-items-center'><span><strong>#{m.name}</strong></span> #{delete_btn}</div>" %>
                        <% end %>
                      <% end %>

                      <%# --- Blocked --- %>
                      <% if blocks = blocked_by_date[date] %>
                        <% classes << 'blocked' %>
                        <% blocks.each do |b| %>
                          <% label = if b.user_id then "User" elsif b.department_id then "Dept" elsif b.hub_id then "Hub" else "Global" end %>
                          <% can_delete_block = is_hr_or_admin || (b.respond_to?(:creator_id) && b.creator_id == current_user.id) %>
                          <% delete_btn = (!read_only && can_delete_block) ? button_to('<i class="fas fa-trash-alt"></i>'.html_safe, blocked_period_path(b), method: :delete, form: { style: 'display:inline-block;' }, class: "btn btn-link text-danger p-0 ms-2 align-baseline", style: "text-decoration: none;", data: { turbo_confirm: "Delete this block?" }) : "" %>
                          <% popover_items << "<div class='mb-1 pb-1 border-bottom small text-danger d-flex justify-content-between align-items-center'><span><strong>Blocked (#{label})</strong></span> #{delete_btn}</div>" %>
                        <% end %>
                      <% end %>

                      <%# --- Visits / Trials (SORTED CHRONOLOGICALLY) --- %>
                      <% visits = visits_by_date[date] %>
                      <% if visits %>
                        <% classes << 'has-visits' if visits.any? %>

                        <%# The service already handles sorting and formatting %>
                        <% visits.each do |v| %>
                          <%
                              # Access the pre-formatted time and labels from the hash
                              display_time = v[:time].split(' - ').first # Gets just the start time for the small label
                              type_label   = v[:type]

                              # v is already the 'visit_data' hash we need for the modal
                              visit_json = v.to_json
                          %>
                          <% info_btn = "<button class='btn btn-link p-0 ms-2 text-dark' data-visit='#{ERB::Util.html_escape(visit_json)}' onclick='openVisitModal(this.getAttribute(\"data-visit\")); event.stopPropagation();'><i class='fas fa-info-circle'></i></button>" %>

                          <% popover_items << "<div class='mb-1 pb-1 border-bottom small text-dark d-flex justify-content-between align-items-center'><span><strong>#{display_time} #{type_label}</strong>: #{v[:learner_name]}</span> #{info_btn}</div>" %>
                        <% end %>
                      <% end %>

                      <% if (wday == 0 || wday == 6) && classes.empty? %><% classes << 'weekend' %><% end %>

                      <% if creation_enabled %>
                        <% add_btn = "<div class='mt-2 text-center'><button class='btn btn-xs btn-outline-primary w-100' onclick='openHubBlockModal(\"#{date}\");'>+ Add Block Here</button></div>" %>
                        <% popover_items << add_btn %>
                      <% end %>

                      <%# Styles %>
                      <%
                         style_list = []
                         style_list << "cursor: pointer;" if (creation_enabled || popover_items.any?)
                      %>

                      <td class="<%= classes.join(' ') %> position-relative text-center align-middle"
                          style="<%= style_list.join(' ') %>"
                          <% if popover_items.any? %>
                            data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true" data-bs-trigger="click"
                            title="<div class='text-center small fw-bold'><%= date.strftime('%a, %b %d') %></div>"
                            data-bs-content="<%= ERB::Util.html_escape(popover_items.join) %>"
                          <% end %>>
                        <%= day_num %>
                      </td>
                    <% end %>
                  <% end %>
                </tr>
                <% week += 1 %>
              <% end %>
              <% (week...6).each do %><tr><td colspan="7" class="bg-light border-0" style="height: 48px;"></td></tr><% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% end %>
</div>
