<div class="container-fluid h-100">
  <div class="row h-100">
    <!-- Sidebar for chat history -->
    <div class="col-md-3 bg-light border-end h-100 d-flex flex-column">
      <div class="p-3 border-bottom">
        <h5 class="mb-3">AI Tutor Chat</h5>

        <!-- Subject Selection -->
        <%= form_with url: chats_path, method: :post, local: true, class: "mb-3" do |form| %>
          <div class="mb-2">
            <%= form.select :subject_id,
                options_from_collection_for_select(@subjects, :id, :name),
                { prompt: "Select a subject to start chatting..." },
                { class: "form-select", onchange: "this.form.submit();" } %>
          </div>
        <% end %>
      </div>

      <!-- Chat History -->
      <div class="flex-grow-1 overflow-auto">
        <div class="p-3">
          <h6 class="text-muted mb-3">Recent Chats</h6>
          <% if @chats.any? %>
            <% @chats.each do |chat| %>
              <div class="card mb-2 <%= 'border-primary' if chat == @current_chat %>">
                <div class="card-body p-2">
                  <%= link_to chat, class: "text-decoration-none" do %>
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <h6 class="card-title mb-1 text-truncate">
                          <i class="fas fa-graduation-cap me-1"></i>
                          <%= chat.subject.name %>
                        </h6>
                        <small class="text-muted">
                          <%= pluralize(chat.chat_messages.count, 'message') %>
                        </small>
                      </div>
                      <small class="text-muted">
                        <%= time_ago_in_words(chat.updated_at) %> ago
                      </small>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted">No chat history yet. Select a subject above to start your first conversation!</p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Main chat area -->
    <div class="col-md-9 h-100 d-flex flex-column">
      <% if @current_chat %>
        <div class="border-bottom p-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-1">
                <i class="fas fa-robot text-primary me-2"></i>
                <%= @current_chat.subject.name %> Tutor
              </h4>
              <small class="text-muted">AI-powered learning assistant</small>
            </div>
            <div>
              <%= link_to @current_chat, method: :delete,
                  confirm: "Are you sure you want to delete this chat?",
                  class: "btn btn-outline-danger btn-sm" do %>
                <i class="fas fa-trash"></i> Delete Chat
              <% end %>
            </div>
          </div>
        </div>

        <!-- Redirect to the specific chat page -->
        <script>
          window.location.href = '<%= chat_path(@current_chat) %>';
        </script>
      <% else %>
        <div class="d-flex align-items-center justify-content-center h-100">
          <div class="text-center">
            <i class="fas fa-comments fa-4x text-muted mb-3"></i>
            <h3 class="text-muted mb-3">Welcome to AI Tutor</h3>
            <p class="text-muted">
              Select a subject from the sidebar to start a personalized learning conversation.
              <br>
              The AI tutor will adapt to your learning style and progress.
            </p>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
