<div class="container-fluid" style="height: 100vh; overflow: hidden;">
  <div class="row" style="height: 100vh;">
    <!-- Sidebar for chat history -->
    <div class="col-md-3 bg-light border-end d-flex flex-column" style="height: 100vh;">
      <div class="p-3 border-bottom">
        <h5 class="mb-3">
          <%= link_to chats_path, class: "text-decoration-none" do %>
            <i class="fas fa-arrow-left me-2"></i>AI Tutor Chat
          <% end %>
        </h5>

        <!-- Subject Selection -->
        <%= form_with url: chats_path, method: :post, local: true, class: "mb-3" do |form| %>
          <div class="mb-2">
            <%= form.select :subject_id,
                options_from_collection_for_select(@subjects, :id, :name, @chat.subject.id),
                { prompt: "Switch to another subject..." },
                { class: "form-select", onchange: "this.form.submit();" } %>
          </div>
        <% end %>
      </div>

      <!-- User's Chat History -->
      <div class="flex-grow-1 overflow-auto">
        <div class="p-3">
          <h6 class="text-muted mb-3">Your Chats</h6>
          <% current_user.chats.includes(:subject).order(updated_at: :desc).each do |chat| %>
            <div class="card mb-2 <%= 'border-primary bg-primary bg-opacity-10' if chat == @chat %>">
              <div class="card-body p-2">
                <%= link_to chat, class: "text-decoration-none" do %>
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="card-title mb-1 text-truncate">
                        <i class="fas fa-graduation-cap me-1"></i>
                        <%= chat.subject.name %>
                      </h6>
                      <small class="text-muted">
                        <%= pluralize(chat.chat_messages.count, 'message') %>
                      </small>
                    </div>
                    <small class="text-muted">
                      <%= time_ago_in_words(chat.updated_at) %> ago
                    </small>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Main chat area -->
    <div class="col-md-9 d-flex flex-column" style="height: 100vh; position: relative;">
      <!-- Chat header - Fixed height -->
      <div class="border-bottom p-3" style="flex-shrink: 0;">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h4 class="mb-1">
              <i class="fas fa-robot text-primary me-2"></i>
              <%= @chat.subject.name %> Tutor
            </h4>
            <small class="text-muted">
              Personalized AI assistant for <%= current_user.full_name %>
            </small>
          </div>
          <div>
            <%= link_to @chat, method: :delete,
                confirm: "Are you sure you want to delete this chat?",
                class: "btn btn-outline-danger btn-sm" do %>
              <i class="fas fa-trash"></i> Delete
            <% end %>
          </div>
        </div>
      </div>

      <!-- Messages area - Flexible height with bottom padding for fixed input -->
      <div id="chat-messages" class="flex-grow-1 overflow-auto p-3" style="min-height: 0; padding-bottom: 100px !important;">
        <% if @messages.any? %>
          <% @messages.each do |message| %>
            <div class="message-container mb-3 <%= message.user_message? ? 'user-message' : 'assistant-message' %>">
              <div class="d-flex <%= message.user_message? ? 'justify-content-end' : 'justify-content-start' %>">
                <div class="message-bubble <%= message.user_message? ? 'bg-primary text-white' : 'bg-light' %> rounded p-3 shadow-sm"
                     style="max-width: 75%;">
                  <% if message.assistant_message? %>
                    <div class="d-flex align-items-center mb-2">
                      <i class="fas fa-robot text-primary me-2"></i>
                      <strong class="text-primary">AI Tutor</strong>
                    </div>
                  <% else %>
                    <div class="d-flex align-items-center mb-2">
                      <i class="fas fa-user text-white me-2"></i>
                      <strong>You</strong>
                    </div>
                  <% end %>
                  <div class="message-content">
                    <%= simple_format(message.content) %>
                  </div>
                  <small class="<%= message.user_message? ? 'text-white-50' : 'text-muted' %> d-block mt-2">
                    <%= message.created_at.strftime('%H:%M') %>
                  </small>
                </div>
              </div>
            </div>
          <% end %>
        <% else %>
          <div class="text-center text-muted my-5">
            <i class="fas fa-comments fa-3x mb-3"></i>
            <h5>Start your conversation</h5>
            <p>Ask me anything about <%= @chat.subject.name %>!</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Message input - Fixed to bottom of screen -->
<div id="message-input-container" style="position: fixed; bottom: 0; right: 0; width: 75%; background-color: white; border-top: 1px solid #dee2e6; padding: 15px; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
  <%= form_with url: send_message_chat_path(@chat), method: :post,
      local: false,
      id: "message-form",
      data: { turbo: false } do |form| %>
    <div class="input-group">
      <%= form.text_field :message,
          placeholder: "Type your question about #{@chat.subject.name}...",
          class: "form-control",
          id: "message-input",
          autocomplete: "off" %>
      <%= form.submit "Send",
          class: "btn btn-primary",
          id: "send-button" %>
    </div>
  <% end %>
</div>

<!-- Custom CSS -->
<style>
  .message-container {
    animation: fadeInUp 0.3s ease-out;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .message-bubble {
    position: relative;
    word-wrap: break-word;
  }

  .user-message .message-bubble::after {
    content: '';
    position: absolute;
    right: -8px;
    top: 10px;
    width: 0;
    height: 0;
    border: 8px solid transparent;
    border-left-color: var(--bs-primary);
  }

  .assistant-message .message-bubble::after {
    content: '';
    position: absolute;
    left: -8px;
    top: 10px;
    width: 0;
    height: 0;
    border: 8px solid transparent;
    border-right-color: var(--bs-light);
  }

  #chat-messages {
    scroll-behavior: smooth;
  }

  /* Fixed input container styles */
  #message-input-container {
    transition: all 0.3s ease;
  }

  #message-input-container:hover {
    box-shadow: 0 -4px 15px rgba(0,0,0,0.15);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    #message-input-container {
      width: 100% !important;
      left: 0 !important;
      right: 0 !important;
    }

    #chat-messages {
      padding-bottom: 120px !important;
    }
  }

  @media (min-width: 769px) {
    #message-input-container {
      width: 75% !important;
    }
  }

  /* Focus styles */
  #message-input:focus {
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    border-color: #86b7fe;
  }

  /* Send button hover effect */
  #send-button:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.3);
  }

  #send-button:active {
    transform: translateY(0);
  }
</style>

<!-- JavaScript for real-time messaging -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const messageForm = document.getElementById('message-form');
  const messageInput = document.getElementById('message-input');
  const sendButton = document.getElementById('send-button');
  const chatMessages = document.getElementById('chat-messages');

  // Auto-focus on message input
  messageInput.focus();

  // Scroll to bottom of messages
  function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Initial scroll to bottom
  scrollToBottom();

  // Handle form submission
  messageForm.addEventListener('submit', function(e) {
    e.preventDefault();

    const message = messageInput.value.trim();
    if (!message) return;

    // Disable form while processing
    messageInput.disabled = true;
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

    // Add user message to chat immediately
    addMessageToChat('user', message);
    messageInput.value = '';

    // Add typing indicator
    addTypingIndicator();

    // Send AJAX request
    fetch(messageForm.action, {
      method: 'POST',
      body: new FormData(messageForm),
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      // Remove typing indicator
      removeTypingIndicator();

      if (data.success) {
        // Add assistant response
        addMessageToChat('assistant', data.assistant_response);
      } else {
        addMessageToChat('assistant', data.error || 'Sorry, there was an error processing your message.');
      }
    })
    .catch(error => {
      removeTypingIndicator();
      console.error('Error:', error);
      addMessageToChat('assistant', 'Sorry, there was a connection error. Please try again.');
    })
    .finally(() => {
      // Re-enable form
      messageInput.disabled = false;
      sendButton.disabled = false;
      sendButton.innerHTML = 'Send';
      messageInput.focus();
    });
  });

  // Enter key to send message
  messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      messageForm.dispatchEvent(new Event('submit'));
    }
  });

  // Handle input focus when clicking anywhere in the input container
  document.getElementById('message-input-container').addEventListener('click', function(e) {
    if (e.target !== messageInput && e.target !== sendButton) {
      messageInput.focus();
    }
  });

  function addMessageToChat(role, content) {
    const messageContainer = document.createElement('div');
    messageContainer.className = `message-container mb-3 ${role}-message`;

    const timestamp = new Date().toLocaleTimeString('en-US', {
      hour12: false,
      hour: '2-digit',
      minute: '2-digit'
    });

    messageContainer.innerHTML = `
      <div class="d-flex ${role === 'user' ? 'justify-content-end' : 'justify-content-start'}">
        <div class="message-bubble ${role === 'user' ? 'bg-primary text-white' : 'bg-light'} rounded p-3 shadow-sm"
             style="max-width: 75%;">
          <div class="d-flex align-items-center mb-2">
            <i class="fas fa-${role === 'user' ? 'user' : 'robot'} ${role === 'user' ? 'text-white' : 'text-primary'} me-2"></i>
            <strong class="${role === 'user' ? '' : 'text-primary'}">${role === 'user' ? 'You' : 'AI Tutor'}</strong>
          </div>
          <div class="message-content">
            ${content.replace(/\n/g, '<br>')}
          </div>
          <small class="${role === 'user' ? 'text-white-50' : 'text-muted'} d-block mt-2">
            ${timestamp}
          </small>
        </div>
      </div>
    `;

    chatMessages.appendChild(messageContainer);

    // Smooth scroll to bottom
    setTimeout(() => {
      scrollToBottom();
    }, 100);
  }

  function addTypingIndicator() {
    const typingIndicator = document.createElement('div');
    typingIndicator.id = 'typing-indicator';
    typingIndicator.className = 'message-container mb-3 assistant-message';
    typingIndicator.innerHTML = `
      <div class="d-flex justify-content-start">
        <div class="message-bubble bg-light rounded p-3 shadow-sm">
          <div class="d-flex align-items-center mb-2">
            <i class="fas fa-robot text-primary me-2"></i>
            <strong class="text-primary">AI Tutor</strong>
          </div>
          <div class="typing-animation">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>
    `;

    chatMessages.appendChild(typingIndicator);
    setTimeout(() => {
      scrollToBottom();
    }, 100);
  }

  function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
      typingIndicator.remove();
    }
  }
});
</script>

<!-- Typing animation CSS -->
<style>
.typing-animation {
  display: flex;
  align-items: center;
  gap: 4px;
}

.typing-animation span {
  height: 8px;
  width: 8px;
  background-color: #6c757d;
  border-radius: 50%;
  animation: typing 1.4s infinite ease-in-out;
}

.typing-animation span:nth-child(1) {
  animation-delay: -0.32s;
}

.typing-animation span:nth-child(2) {
  animation-delay: -0.16s;
}

@keyframes typing {
  0%, 80%, 100% {
    transform: scale(0);
  }
  40% {
    transform: scale(1);
  }
}
</style>
