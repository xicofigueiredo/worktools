<div class="hub-container px-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="mb-0"><%= @hub.name %> Calendar</h3>
      <div class="text-muted small">Viewing events for <%= @year %></div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-warning" onclick="openHubBlockModal('<%= Date.current %>')">
        <i class="fas fa-plus"></i> Add Blocked Period
      </button>

      <div class="btn-group">
        <%= link_to calendar_hub_path(@hub, year: @prev_year), class: 'btn btn-outline-secondary' do %>
          <i class="fas fa-chevron-left"></i> <%= @prev_year %>
        <% end %>

        <%= link_to hub_path(@hub), class: 'btn btn-primary' do %>
          <i class="fas fa-columns"></i> Hub Dashboard
        <% end %>

        <%= link_to calendar_hub_path(@hub, year: @next_year), class: 'btn btn-outline-secondary' do %>
          <%= @next_year %> <i class="fas fa-chevron-right"></i>
        <% end %>
      </div>
    </div>
  </div>

  <div class="mb-3 pb-2 border-bottom">
    <div class="d-flex gap-3">
      <div class="legend-item"><div class="legend-box holiday"></div> <span class="small">Public Holiday</span></div>
      <div class="legend-item"><div class="legend-box mandatory"></div> <span class="small">Mandatory Leave</span></div>
      <div class="legend-item"><div class="legend-box blocked"></div> <span class="small">Blocked Period</span></div>
    </div>
  </div>

  <%= render partial: "shared/calendar_grid", locals: {
        year: @year,
        holidays_by_date: @holidays_by_date,
        blocked_by_date: @blocked_by_date,
        mandatory_leaves: @mandatory_leaves,
        read_only: false,
        allow_creation: true
      } %>
</div>

<div class="modal fade" id="createHubBlockModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Schedule Blocked Period</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <%= form_with(model: @new_blocked_period, url: blocked_periods_path, local: true) do |f| %>
        <div class="modal-body">
          <div class="alert alert-info small mb-3">
            <i class="fas fa-info-circle"></i> This will block the period for <strong><%= @hub.name %></strong> only.
          </div>

          <%= f.hidden_field :hub_id, value: @hub.id %>

          <div class="row g-2">
            <div class="col-6">
              <%= f.label :start_date, class: "form-label" %>
              <%= f.date_field :start_date, class: "form-control", id: "modalStartDate", required: true %>
            </div>
            <div class="col-6">
              <%= f.label :end_date, class: "form-label" %>
              <%= f.date_field :end_date, class: "form-control", id: "modalEndDate", required: true %>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Create Block</button>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  function openHubBlockModal(dateStr) {
    var modalEl = document.getElementById('createHubBlockModal');
    if (!modalEl) return;

    // Pre-fill dates
    document.getElementById('modalStartDate').value = dateStr;
    document.getElementById('modalEndDate').value = dateStr;

    // Show Modal
    var modal = new bootstrap.Modal(modalEl);
    modal.show();
  }

  document.addEventListener('turbo:load', function () {
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (el) {
      return new bootstrap.Popover(el, { sanitize: false, container: 'body', trigger: 'click' });
    });

    document.addEventListener('click', function (e) {
      popoverList.forEach(function (popover) {
        if (popover.tip && popover.tip.classList.contains('show')) {
          // Close if click is outside popover AND outside the triggering element
          if (!popover._element.contains(e.target) && !popover.tip.contains(e.target)) {
            popover.hide();
          }
        }
      });
    });
  });
</script>
