  <%= form_with(model: @sprint_goal, data: { controller: "nested-form", nested_form_target: "form", nested_form_knowledges: @knowledges_subject_names.to_json, nested_form_number_of_timelines: @number_of_timelines, action: "submit->nested-form#submit", sprint_goal_id: @sprint_goal.id, sprint_goal_date: @sprint_goal.sprint.start_date }, local: false, remote: true) do |form| %>
    <input name="authenticity_token" type="hidden" value="<%= form_authenticity_token %>">
    <% if @sprint_goal.errors.any? %>
      <div class="alert alert-danger" role="alert">
        <h4 class="alert-heading">Errors prevented this sprint_goal from being saved:</h4>
        <ul>
          <% @sprint_goal.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>
    <style>
      .custom-font-size {
        font-size: 13px;
      }
      .ts-optgroup-header {
        font-weight: bold;
        font-size: 1.05em;
        padding: 4px 8px 2px 8px;
      }
    </style>
    <div class="py-2">
      <div class="mb-4">
        <h2 class="mb-3">Knowledge Block</h2>
        <div class="card mb-2 shadow-sm" style="border-radius: 10px">
          <div class="px-2">
            <table class="table">
              <thead>
                <tr>
                  <th class="custom-font-size vertical-mid" style="vertical-align: middle;">Subject</th>
                  <th class="custom-font-size" style="vertical-align: middle;"><%= @sprint_goal.sprint.name %> Goal</th>
                  <th class="custom-font-size" style="vertical-align: middle;">Exam Season</th>
                  <th class="custom-font-size" style="vertical-align: middle;">50% Mock</th>
                  <th class="custom-font-size" style="vertical-align: middle;">100% Mock</th>
                  <th class="custom-font-size" style="vertical-align: middle;">What difficulties do you expect to encounter with this target?</th>
                  <th class="custom-font-size" style="vertical-align: middle;">Explain your plan to achieve your goal in 3 steps or more.</th>
                  <th></th>
                </tr>
              </thead>
              <tbody data-nested-form-target="knowledgesContainer">
                <% count = 0 %>
                <% max = @number_of_timelines%>

                <%= form.fields_for :knowledges,  @sprint_goal.knowledges do |knowledge_form| %>
                  <tr>
                    <% if knowledge_form.object.subject_name.blank? && count < max %>
                      <% knowledge_form.object.subject_name = personalized_timelines[count].personalized_name%>
                      <% count += 1 %>
                    <% end %>
                    <td class="custom-font-size" data-subject-cell>
                      <p><%= knowledge_form.object.subject_name %></p>
                      <%# <%= knowledge_form.text_field :subject_name, class: 'form-control', value: knowledge_form.object.subject_name, readonly: true  %>
                    </td>
                    <td class="custom-font-size">
                      <% sprint_deadline = @sprint_deadlines.find { |sprint_deadline| sprint_deadline[:timeline].subject.name == knowledge_form.object.subject_name } %>
                      <% if sprint_deadline %>
                        <%= sprint_deadline[:topic].name %>
                      <% else %>
                        N/A
                      <% end %>
                    </td>
                    <td class="custom-font-size">
                      <% if knowledge_form.object.exam_season %>
                        <p><%= knowledge_form.object.exam_season %></p>
                      <% else %>
                        N/A
                      <% end %>
                    </td>
                    <td class="custom-font-size">
                      <% if knowledge_form.object.mock50.present? && knowledge_form.object.mock50.is_a?(Date) %>
                        <p><%= knowledge_form.object.mock50 %></p>
                      <% else %>
                        N/A
                      <% end %>
                    </td>
                    <td class="custom-font-size">
                      <% if knowledge_form.object.mock100.present? && knowledge_form.object.mock100.is_a?(Date) %>
                        <p><%= knowledge_form.object.mock100 %></p>
                      <% else %>
                        N/A
                      <% end %>
                    </td>
                    <td class="custom-font-size">
                      <%= knowledge_form.text_area :difficulties, class: 'form-control' %>
                    </td>
                    <td class="custom-font-size">
                      <%= knowledge_form.text_area :plan, class: 'form-control' %>
                    </td>
                    <td style="vertical-align: middle"><button class="btn btn-danger text-white" style="border-radius: 10px;" data-action="click->nested-form#removeRow" data-knowledge-id="<%= knowledge_form.object.id %>" data-kind="knowledges"><i class="fa-solid fa-trash"></i></button></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
            <div class="d-flex justify-content-center mb-3">
              <% if @sprint_goal.knowledges.count >= @number_of_timelines %>
                <button disabled class="btn btn-primary" data-action="click->nested-form#addRow" data-kind="knowledges" data-knowledge-add-btn style='border-radius: 10px;'>Add</button>
              <% else %>
                <button class="btn btn-primary" data-action="click->nested-form#addRow" data-kind="knowledges" data-knowledge-add-btn style='border-radius: 10px;'>Add</button>
              <% end %>

            </div>
            <template data-nested-form-target="template" data-kind="knowledges">
              <%= form.fields_for :knowledges, Knowledge.new, child_index: "TEMPLATE_INDEX" do |knowledge_form| %>
                <tr>
                  <td>
                    <div data-subject-cell>
                      <select name="Timeline Select" id="Timeline Select" class="form-select" data-action="change->nested-form#createKnowledge">
                        <option value="" disabled selected>Select timeline</option>
                        <% current_user.timelines.where(hidden: false).each do |timeline| %>
                          <% exam_date = timeline.exam_date&.date %>

                          <% matched_sprint_goal = @sprint_deadlines.find do |sprint_goal|
                              sprint_goal[:timeline].subject.name == (timeline.subject.name.presence || timeline.personalized_name)
                            end %>

                          <% sprint_goal = matched_sprint_goal ? (matched_sprint_goal[:topic] ? matched_sprint_goal[:topic][:name] : 'No goal found') : 'No goal found' %>

                          <option value="<%= [timeline.subject.name.presence || timeline.personalized_name, exam_date, timeline.mock50, timeline.mock100, sprint_goal].join('||') %>">
                            <%= timeline.subject.name.presence || timeline.personalized_name %>
                          </option>
                        <% end %>
                      </select>
                    </div>
                    <%= knowledge_form.hidden_field :subject_name, disabled: true %>
                  </td>
                  <td>
                    <div data-sprint-goal-cell>
                    </div>
                  </td>
                  <td>
                    <div data-exam-season-cell>
                    </div>
                    <%= knowledge_form.hidden_field :exam_season, class: 'form-control', disabled: true  %>
                  </td>
                  <td>
                    <div data-mock50-cell>
                    </div>
                    <%= knowledge_form.hidden_field :mock50, class: 'form-control', disabled: true  %>
                  </td>
                  <td>
                    <div data-mock100-cell>
                    </div>
                    <%= knowledge_form.hidden_field :mock100, class: 'form-control', disabled: true  %>
                  </td>
                  <td><%= knowledge_form.text_area :difficulties, class: 'form-control',  disabled: true  %></td>
                  <td><%= knowledge_form.text_area :plan, class: 'form-control',  disabled: true  %></td>
                  <td style="vertical-align: middle"><button class="btn btn-danger text-white" style="border-radius: 10px;" data-action="click->nested-form#removeRow" data-kind="knowledges"><i class="fa-solid fa-trash"></i></button></td>
                </tr>
              <% end %>
            </template>
          </div>
        </div>
      </div>
    </div>
    <%# Skills Block %>
    <div class="py-2">
        <div class="mb-4">
          <h2 class="mb-3">Skills Block</h2>
          <div class="card mb-2 shadow-sm" style="border-radius: 10px">
            <div class="px-2">
              <table class="table">
                <thead>
                  <tr>
                    <th class="custom-font-size" style="vertical-align: middle;">
                      What extracurricular activities or MOOCs will you get involved in?
                    </th>
                    <th class="custom-font-size" style="vertical-align: middle;">
                      What are your goals for this activity? Make them SMART (Specific, Measurable, Attainable, Relevant, Time-constrained)
                    </th>
                    <th class="custom-font-size" style="vertical-align: middle;">
                      What difficulties do you expect to encounter with this target?
                    </th>
                    <th class="custom-font-size" style="vertical-align: middle;">
                      Explain your plan to achieve your goal in 3 steps or more. (Include how you plan to overcome your difficulties)
                    </th>
                    <th class="custom-font-size" style="vertical-align: middle;">Category</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody data-nested-form-target="skillsContainer">
                  <% @sprint_goal.skills.each_with_index do |skill, index| %>
                    <%= form.fields_for :skills, skill, child_index: index do |skill_form| %>
                      <tr>
                        <td><%= skill_form.text_field :extracurricular, class: 'form-control' %></td>
                        <td><%= skill_form.text_area :smartgoals, class: 'form-control' %></td>
                        <td><%= skill_form.text_area :difficulties, class: 'form-control' %></td>
                        <td><%= skill_form.text_area :plan, class: 'form-control' %></td>
                        <td>
                          <%= skill_form.select :categories,
                            grouped_options_for_select(
                              Skill::CATEGORY_GROUPS.transform_values { |cats| cats.map { |c| [c, c] } },
                              skill_form.object.categories
                            ),
                            {},
                            { multiple: true, class: "form-select category-multiselect", data: { behavior: "category-multiselect" } }
                          %>
                        </td>
                        <td style="vertical-align: middle">
                          <button class="btn btn-danger text-white" style="border-radius: 10px;" data-action="click->nested-form#removeRow" data-skill-id="<%= skill.id %>" data-kind="skills">
                            <i class="fa-solid fa-trash"></i>
                          </button>
                        </td>
                      </tr>
                    <% end %>
                  <% end %>
                </tbody>
              </table>
              <div class="d-flex justify-content-center mb-3">
                <button class="btn btn-primary" data-action="click->nested-form#addRow" data-kind="skills" style='border-radius: 10px;'>Add</button>
              </div>
              <template data-nested-form-target="template" data-kind="skills">
                <%= form.fields_for :skills, Skill.new, child_index: "TEMPLATE_INDEX" do |skill_form| %>
                  <tr>
                    <td><%= skill_form.text_field :extracurricular, class: 'form-control' %></td>
                    <td><%= skill_form.text_area :smartgoals, class: 'form-control' %></td>
                    <td><%= skill_form.text_area :difficulties, class: 'form-control' %></td>
                    <td><%= skill_form.text_area :plan, class: 'form-control' %></td>
                    <td>
                      <%= skill_form.select :categories,
                        grouped_options_for_select(
                          Skill::CATEGORY_GROUPS.transform_values { |cats| cats.map { |c| [c, c] } },
                          skill_form.object.categories
                        ),
                        {},
                        { multiple: true, class: "form-select category-multiselect", data: { behavior: "category-multiselect" } }
                      %>
                    </td>
                    <td style="vertical-align: middle">
                      <button class="btn btn-danger text-white" style="border-radius: 10px;" data-action="click->nested-form#removeRow">
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                <% end %>
              </template>
            </div>
          </div>
        </div>
    </div>
    <%# Community Block %>
    <div class="py-2">
      <div class="mb-4">
        <h2 class="mb-3">Community Block</h2>
        <div class="card mb-2 shadow-sm" style="border-radius: 10px">
          <div class="px-2">
              <table class="table">
                <thead>
                  <tr>
                    <th class="custom-font-size">Category</th>
                    <th class="custom-font-size">How do you plan to get involved in your community, are there any BGA Clubs, Hub Projects, or Volunteering that you want to get involved in?</th>
                    <th class="custom-font-size">What are your goals for this activity? Make them SMART (Specific, Measurable, Attainable, Relevant, Time-constrained)</th>
                    <th class="custom-font-size">What difficulties do you expect to encounter with this target?</th>
                    <th class="custom-font-size">Explain your plan to achieve your goal in 3 steps or more. (Include how you plan to overcome your difficulties)</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody data-nested-form-target="communitiesContainer">
                  <% @sprint_goal.communities.each_with_index do |community, index| %>
                    <%= form.fields_for :communities, community, child_index: index do |community_form| %>
                      <tr>
                        <td>
                          <% Community::CATEGORIES.each do |cat| %>
                            <div class="form-check">
                              <%= community_form.check_box :categories, { multiple: true, class: "form-check-input" }, cat, nil %>
                              <%= community_form.label :categories, cat.titleize, value: cat, class: "form-check-label" %>
                            </div>
                          <% end %>
                        </td>
                        <td><%= community_form.text_field :involved, class: 'form-control' %></td>
                        <td><%= community_form.text_area :smartgoals, class: 'form-control' %></td>
                        <td><%= community_form.text_area :difficulties, class: 'form-control' %></td>
                        <td><%= community_form.text_area :plan, class: 'form-control' %></td>
                        <td style="vertical-align: middle">
                          <button class="btn btn-danger text-white" style="border-radius: 10px;" data-action="click->nested-form#removeRow" data-community-id="<%= community.id %>" data-kind="communities">
                            <i class="fa-solid fa-trash"></i>
                          </button>
                        </td>
                      </tr>
                    <% end %>
                  <% end %>
                </tbody>
              </table>
              <div class="d-flex justify-content-center mb-3">
                <button class="btn btn-primary" data-action="click->nested-form#addRow" data-kind="communities" style='border-radius: 10px;'>Add</button>
              </div>
              <template data-nested-form-target="template" data-kind="communities">
                <%= form.fields_for :communities, Community.new, child_index: "TEMPLATE_INDEX" do |community_form| %>
                  <tr>
                    <td>
                      <% Community::CATEGORIES.each do |cat| %>
                        <div class="form-check">
                          <%= community_form.check_box :categories, { multiple: true, class: "form-check-input" }, cat, nil %>
                          <%= community_form.label :categories, cat.titleize, value: cat, class: "form-check-label" %>
                        </div>
                      <% end %>
                    </td>
                    <td><%= community_form.text_field :involved, class: 'form-control' %></td>
                    <td><%= community_form.text_area :smartgoals, class: 'form-control' %></td>
                    <td><%= community_form.text_area :difficulties, class: 'form-control' %></td>
                    <td><%= community_form.text_area :plan, class: 'form-control' %></td>
                    <td style="vertical-align: middle">
                      <button class="btn btn-danger text-white" style="border-radius: 10px;" data-action="click->nested-form#removeRow">
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                <% end %>
              </template>
          </div>
        </div>
      </div>
    </div>
    <div class="form-group d-flex justify-content-center gap-2 mb-5">
      <%= link_to 'Back', sprint_goals_path(date: @sprint_goal.sprint.start_date), class: "btn btn-secondary", style: 'border-radius: 10px;' %>
      <div data-nested-form-target="submit">
        <%= form.submit "Save Sprint Goal", class: "btn btn-primary", style: "border-radius: 10px;"%>
      </div>
    </div>
<% end %>

<script>
  document.addEventListener('turbo:load', function() {
    // Initialize select2 for all category selects
    document.querySelectorAll('select[multiple]').forEach(function(select) {
      new TomSelect(select, {
        plugins: ['remove_button'],
        maxItems: null
      });
    });
  });

  function initializeCategoryMultiselects() {
    document.querySelectorAll('.category-multiselect').forEach(function(select) {
      // Only initialize if not already initialized
      if (!select.tomselect) {
        new TomSelect(select, {
          plugins: ['remove_button'],
          persist: false,
          create: false,
          maxItems: null,
          render: {
            item: function(data, escape) {
              return `<div class="badge bg-primary me-1 mb-1">${escape(data.text)}</div>`;
            },
            optgroup: function(data, escape) {
              return `<div class="ts-optgroup"><div class="ts-optgroup-header" style="font-weight:bold;">${escape(data.label)}</div><div class="ts-optgroup-options"></div></div>`;
            }
          }
        });
      }
    });
  }
</script>
