<% year_now = Date.current.year %>
<% show_actions = @show_hr_view %>

<div class="card mb-4">
  <div class="card-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <h5 class="mb-0">Department Entitlements — <%= year_now %></h5>

      <div class="d-flex gap-2 align-items-center flex-wrap">
        <div class="d-flex gap-2 align-items-center">
          <label class="mb-0 small text-muted">Filter</label>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="deptFilterDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false" style="min-width: 180px; text-align: left;">
              All departments
            </button>
            <ul class="dropdown-menu p-2" aria-labelledby="deptFilterDropdownBtn" style="max-height: 300px; overflow-y: auto;">
              <li>
                <label class="dropdown-item d-flex gap-2 align-items-center cursor-pointer">
                  <input type="checkbox" class="form-check-input mt-0 filter-checkbox-all" value="all" checked>
                  <span>All departments</span>
                </label>
              </li>
              <li><hr class="dropdown-divider my-1"></li>

              <% @managed_departments.to_a.each do |d| %>
                <li>
                  <label class="dropdown-item d-flex gap-2 align-items-center cursor-pointer">
                    <input type="checkbox" class="form-check-input mt-0 filter-checkbox-dept" value="<%= d.id %>">
                    <span><%= d.name %></span>
                  </label>
                </li>
              <% end %>
            </ul>
          </div>
        </div>

        <div class="btn-group" role="group" aria-label="Actions">
          <% if show_actions %>
            <button type="button"
                    class="btn btn-sm btn-success me-2"
                    id="create-entitlement-btn"
                    title="Create new entitlement">
              <i class="fa-solid fa-plus"></i> New
            </button>
          <% end %>

          <button id="export-xlsx-btn"
                  type="button"
                  class="btn btn-sm btn-outline-success"
                  title="Export visible rows to Excel">
            <i class="fa-solid fa-file-excel"></i> Export
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="card-body p-0">
    <table class="table table-sm mb-0" id="dept-entitlements-table">
      <thead class="table-light">
        <tr>
          <th>Department</th>
          <th>Name</th>
          <th>Total</th>
          <th>Booked</th>
          <th>Pending</th>
          <th>Left</th>
          <% if show_actions %>
            <th>Actions</th>
          <% end %>
        </tr>
      </thead>

      <tbody>
        <% if @rows.blank? %>
          <tr>
            <td colspan="<%= show_actions ? 7 : 6 %>" class="text-center text-muted py-3">No users found for the selected departments.</td>
          </tr>
        <% else %>
          <% grouped = @rows.group_by do |r|
               dept = (r[:primary_department] || r[:departments].first)
               [dept&.id, dept&.name || "—"]
             end %>

          <% grouped.each do |(dept_id, dept_name), rows| %>
            <% rows.each do |r| %>
              <% primary_dept = (r[:primary_department] || r[:departments].first) %>
              <tr data-dept-id="<%= primary_dept&.id %>">
                <td><%= primary_dept&.name || '—' %></td>
                <td><%= "#{r[:user].full_name}" %></td>
                <td><%= r[:total_holidays] %></td>
                <td>
                  <%= r[:booked_holiday] %>
                  <% if r[:booked_carry_over].to_i > 0 %>
                    <small class="text-muted">(includes <%= r[:booked_carry_over] %> from <%= year_now + 1 %>)</small>
                  <% end %>
                </td>
                <td>
                  <%= r[:pending_holiday] %>
                  <% if r[:pending_carry_over].to_i > 0 %>
                    <small class="text-muted">(includes <%= r[:pending_carry_over] %> from <%= year_now + 1 %>)</small>
                  <% end %>
                </td>
                <td><%= r[:holidays_left] %></td>
                <% if show_actions %>
                  <td>
                    <button type="button"
                            class="btn btn-sm btn-outline-primary edit-entitlement"
                            data-user-id="<%= r[:user].id %>"
                            data-year="<%= year_now %>"
                            data-current-total="<%= r[:total_holidays] %>"
                            data-current-booked="<%= r[:booked_holiday] %>"
                            data-current-pending="<%= r[:pending_holiday] %>"
                            data-current-left="<%= r[:holidays_left] %>">Edit</button>
                  </td>
                <% end %>
              </tr>
            <% end %>
          <% end %>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<!-- Create New Entitlement Modal -->
<div class="modal fade" id="create-entitlement-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create New Entitlement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="create-entitlement-form">
          <input type="hidden" name="year" id="create-year" value="<%= year_now %>">

          <div class="mb-3">
            <label for="create-user-select" class="form-label">Select User <span class="text-danger">*</span></label>
            <select class="form-select" id="create-user-select" name="user_id" required>
              <option value="">Loading users...</option>
            </select>
            <small class="text-muted">Only staff members without an entitlement for <%= year_now %> are shown.</small>
          </div>

          <div class="mb-3">
            <label for="create-start-date" class="form-label">Start Date <span class="text-danger">*</span></label>
            <input type="date" class="form-control" id="create-start-date" name="start_date" required>
            <small class="text-muted">The date when this person starts working (used to calculate pro-rated holidays).</small>
          </div>

          <div class="mb-3">
            <label for="create-annual-holidays" class="form-label">Annual Holidays <span class="text-danger">*</span></label>
            <input type="number" class="form-control" id="create-annual-holidays" name="annual_holidays" min="0" value="25" required>
            <small class="text-muted">This will be auto-calculated based on start date, but you can adjust it.</small>
          </div>

          <div class="mb-3">
            <label for="create-holidays-left" class="form-label">Holidays Left <span class="text-danger">*</span></label>
            <input type="number" class="form-control" id="create-holidays-left" name="holidays_left" min="0" value="25" required>
            <small class="text-muted">Usually same as annual holidays for new entitlements.</small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-success" id="save-create-entitlement">Create Entitlement</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Entitlement Modal -->
<div class="modal fade" id="edit-entitlement-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Entitlement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-entitlement-form">
          <input type="hidden" name="user_id" id="edit-user-id">
          <input type="hidden" name="year" id="edit-year">
          <div class="mb-3">
            <label for="annual-total" class="form-label">Total (Annual Allowance)</label>
            <input type="number" class="form-control" id="annual-total" name="annual_total" min="0">
          </div>
          <div class="mb-3">
            <label for="remaining-left" class="form-label">Left (Remaining Days)</label>
            <input type="number" class="form-control" id="remaining-left" name="new_holidays_left" min="0">
          </div>
          <p>Current Booked: <span id="current-booked"></span></p>
          <p>Current Pending: <span id="current-pending"></span></p>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="save-entitlement">Save changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Inline scripts: filter + client-side XLSX export (SheetJS) + entitlement management -->
<script>
  document.addEventListener('turbo:load', function () {
    var filterBtn = document.getElementById('deptFilterDropdownBtn');
    var allCheckbox = document.querySelector('.filter-checkbox-all');
    var deptCheckboxes = document.querySelectorAll('.filter-checkbox-dept');

    if (filterBtn && allCheckbox && deptCheckboxes) {

      // 1. Helper to get currently selected IDs
      function getSelectedIds() {
        if (allCheckbox.checked) return ['all'];
        return Array.from(deptCheckboxes)
          .filter(cb => cb.checked)
          .map(cb => cb.value);
      }

      // 2. Main Filter Function
      function applyMultiFilter() {
        var selectedIds = getSelectedIds();
        var allRows = document.querySelectorAll('#dept-entitlements-table tbody tr[data-dept-id]');

        // Update Button Text
        if (selectedIds.includes('all') || selectedIds.length === 0) {
          filterBtn.innerText = 'All departments';
        } else if (selectedIds.length === 1) {
          // Find the name of the single selected dept
          var selectedCb = Array.from(deptCheckboxes).find(cb => cb.value === selectedIds[0]);
          filterBtn.innerText = selectedCb ? selectedCb.nextElementSibling.innerText : '1 selected';
        } else {
          filterBtn.innerText = selectedIds.length + ' departments selected';
        }

        // Show/Hide Rows
        allRows.forEach(function (row) {
          var rowDeptId = row.dataset.deptId;
          // Show if 'all' is selected OR if row ID is in the selected list
          if (selectedIds.includes('all') || selectedIds.includes(rowDeptId)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });

        // Save to localStorage
        try {
          localStorage.setItem('deptFilterMulti', JSON.stringify(selectedIds));
        } catch (e) {}
      }

      // 3. Event Listeners

      // Handle "All" click
      allCheckbox.addEventListener('change', function() {
        if (this.checked) {
          // Uncheck all specific departments
          deptCheckboxes.forEach(cb => cb.checked = false);
        } else {
          // If user unchecks "All" but nothing else is checked, force "All" back on (prevent empty state)
           var anyOtherChecked = Array.from(deptCheckboxes).some(cb => cb.checked);
           if (!anyOtherChecked) this.checked = true;
        }
        applyMultiFilter();
      });

      // Handle Specific Dept click
      deptCheckboxes.forEach(function(cb) {
        cb.addEventListener('change', function() {
          if (this.checked) {
            // If a specific dept is checked, uncheck "All"
            allCheckbox.checked = false;
          } else {
            // If all specific depts are now unchecked, re-check "All"
            var anyChecked = Array.from(deptCheckboxes).some(c => c.checked);
            if (!anyChecked) allCheckbox.checked = true;
          }
          applyMultiFilter();
        });
      });

      // 4. Restore state from LocalStorage on load
      try {
        var saved = JSON.parse(localStorage.getItem('deptFilterMulti'));
        if (Array.isArray(saved) && saved.length > 0) {
          if (saved.includes('all')) {
            allCheckbox.checked = true;
            deptCheckboxes.forEach(cb => cb.checked = false);
          } else {
            allCheckbox.checked = false;
            deptCheckboxes.forEach(cb => {
              cb.checked = saved.includes(cb.value);
            });
          }
        }
      } catch (e) {
        console.log("Error restoring filter", e);
      }

      // Initial Apply
      applyMultiFilter();
    }

    clientFilter.addEventListener('change', function () {
      var val = clientFilter.value;
      try { localStorage.setItem('deptFilter', val); } catch (e) {}
      applyFilter(val);
    });

    // Ensure SheetJS (XLSX) is loaded, then call callback
    function ensureXLSX(callback) {
      if (window.XLSX) return callback();
      var s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js';
      s.async = true;
      s.onload = function () { callback(); };
      s.onerror = function () {
        alert('Failed to load Excel export library. Please try again or contact the administrator.');
      };
      document.head.appendChild(s);
    }

    // Export visible rows to .xlsx
    function exportVisibleRowsXLSX() {
      var table = document.getElementById('dept-entitlements-table');
      if (!table) { alert('Table not found'); return; }

      var theadRow = table.querySelector('thead tr');
      var allHeaders = Array.from(theadRow.querySelectorAll('th')).map(th => th.innerText.trim());
      var header = allHeaders[allHeaders.length - 1] === 'Actions' ? allHeaders.slice(0, -1) : allHeaders;

      var tbodyRows = Array.from(table.querySelectorAll('tbody tr'));
      var visibleData = [];

      tbodyRows.forEach(function (row) {
        if (!row.dataset.deptId) return;
        var style = window.getComputedStyle(row);
        if (style.display === 'none') return;

        var cols = Array.from(row.querySelectorAll('td'));
        if (cols.length === 0) return;

        var cells = cols.slice(0, 6).map(function (td) {
          return (td.innerText || '').trim();
        });
        visibleData.push(cells);
      });

      if (visibleData.length === 0) {
        alert('No visible rows to export.');
        return;
      }

      var aoa = [header].concat(visibleData);

      try {
        var ws = XLSX.utils.aoa_to_sheet(aoa);

        ws['!cols'] = [
          { wch: 25 }, // Department
          { wch: 30 }, // Name
          { wch: 10 }, // Total
          { wch: 15 }, // Booked
          { wch: 15 }, // Pending
          { wch: 10 }  // Left
        ];

        var wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Entitlements');

        var wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        var blob = new Blob([wbout], { type: 'application/octet-stream' });

        var filename = 'department_entitlements_' + new Date().toISOString().slice(0,10) + '.xlsx';
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error('XLSX export error', err);
        alert('Failed to export to Excel. Check console for details.');
      }
    }

    if (exportBtn) {
      exportBtn.addEventListener('click', function () {
        ensureXLSX(function () { exportVisibleRowsXLSX(); });
      });
    }

    // Create Entitlement Modal Logic
    if (createBtn) {
      createBtn.addEventListener('click', function () {
        var modal = new bootstrap.Modal(document.getElementById('create-entitlement-modal'));
        var userSelect = document.getElementById('create-user-select');
        var yearNow = <%= year_now %>;

        // Reset form
        document.getElementById('create-entitlement-form').reset();
        document.getElementById('create-year').value = yearNow;

        // Load users without entitlement
        userSelect.innerHTML = '<option value="">Loading users...</option>';
        userSelect.disabled = true;

        fetch('/leaves/users_without_entitlement?year=' + yearNow, {
          method: 'GET',
          headers: {
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
            'Accept': 'application/json'
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          userSelect.disabled = false;
          if (data.users && data.users.length > 0) {
            userSelect.innerHTML = '<option value="">-- Select a user --</option>';
            data.users.forEach(user => {
              var option = document.createElement('option');
              option.value = user.id;
              option.textContent = user.name;
              userSelect.appendChild(option);
            });
          } else {
            userSelect.innerHTML = '<option value="">No users available</option>';
          }
        })
        .catch(err => {
          console.error('Error loading users:', err);
          userSelect.disabled = false;
          userSelect.innerHTML = '<option value="">Error loading users - please try again</option>';
          alert('Failed to load users. Please check your connection and try again.');
        });

        modal.show();
      });
    }

    // Calculate pro-rated holidays based on start date
    var startDateInput = document.getElementById('create-start-date');
    var annualHolidaysInput = document.getElementById('create-annual-holidays');
    var holidaysLeftInput = document.getElementById('create-holidays-left');

    if (startDateInput && annualHolidaysInput && holidaysLeftInput) {
      startDateInput.addEventListener('change', function () {
        var startDate = new Date(this.value);
        var yearNow = <%= year_now %>;
        var yearStart = new Date(yearNow, 0, 1);
        var yearEnd = new Date(yearNow, 11, 31);

        if (startDate && !isNaN(startDate.getTime())) {
          // Calculate pro-rated holidays based on remaining days in the year
          var totalDaysInYear = (yearEnd - yearStart) / (1000 * 60 * 60 * 24) + 1;
          var daysRemaining = Math.max(0, (yearEnd - startDate) / (1000 * 60 * 60 * 24) + 1);
          var proRatedHolidays = Math.round((daysRemaining / totalDaysInYear) * 25);

          annualHolidaysInput.value = proRatedHolidays;
          holidaysLeftInput.value = proRatedHolidays;
        }
      });

      // Also update holidays_left when annual_holidays changes
      annualHolidaysInput.addEventListener('input', function () {
        holidaysLeftInput.value = this.value;
      });
    }

    // Save Create Entitlement
    var saveCreateBtn = document.getElementById('save-create-entitlement');
    if (saveCreateBtn) {
      saveCreateBtn.addEventListener('click', function () {
        var form = document.getElementById('create-entitlement-form');
        var data = new FormData(form);

        // Validate required fields
        if (!data.get('user_id') || !data.get('start_date')) {
          alert('Please fill in all required fields');
          return;
        }

        // Disable button to prevent double-submit
        saveCreateBtn.disabled = true;
        saveCreateBtn.textContent = 'Creating...';

        fetch('/leaves/create_entitlement', {
          method: 'POST',
          body: data,
          headers: {
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            window.location.href = '/leaves?active_tab=manager';
          } else {
            alert('Failed to create entitlement: ' + (data.error || 'Unknown error'));
            saveCreateBtn.disabled = false;
            saveCreateBtn.textContent = 'Create Entitlement';
          }
        })
        .catch(err => {
          alert('Error: ' + err.message);
          saveCreateBtn.disabled = false;
          saveCreateBtn.textContent = 'Create Entitlement';
        });
      });
    }

    // Edit entitlement JS
    document.querySelectorAll('.edit-entitlement').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var userId = btn.dataset.userId;
        var year = btn.dataset.year;
        var currentTotal = parseInt(btn.dataset.currentTotal) || 0;
        var currentBooked = parseInt(btn.dataset.currentBooked) || 0;
        var currentPending = parseInt(btn.dataset.currentPending) || 0;
        var currentLeft = parseInt(btn.dataset.currentLeft) || 0;

        document.getElementById('edit-user-id').value = userId;
        document.getElementById('edit-year').value = year;
        var totalInput = document.getElementById('annual-total');
        var leftInput = document.getElementById('remaining-left');
        totalInput.value = currentTotal;
        leftInput.value = currentLeft;
        document.getElementById('current-booked').innerText = currentBooked;
        document.getElementById('current-pending').innerText = currentPending;

        // Enforce non-negative
        totalInput.addEventListener('input', function () {
          var val = parseInt(this.value);
          if (isNaN(val) || val < 0) this.value = 0;
        });
        leftInput.addEventListener('input', function () {
          var val = parseInt(this.value);
          if (isNaN(val) || val < 0) this.value = 0;
        });

        var modal = new bootstrap.Modal(document.getElementById('edit-entitlement-modal'));
        modal.show();
      });
    });

    var saveBtn = document.getElementById('save-entitlement');
    if (saveBtn) {
      saveBtn.addEventListener('click', function () {
        var form = document.getElementById('edit-entitlement-form');
        var data = new FormData(form);

        // Disable button to prevent double-submit
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        fetch('/leaves/update_entitlement', {
          method: 'POST',
          body: data,
          headers: {
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          }
        }).then(function (response) {
          return response.json();
        }).then(function (data) {
          if (data.success) {
            window.location.href = '/leaves?active_tab=manager';
          } else {
            alert('Failed to update entitlement: ' + (data.error || 'Unknown error'));
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save changes';
          }
        }).catch(function (err) {
          alert('Error: ' + err.message);
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save changes';
        });
      });
    }
  });
</script>
