<% year_now = Date.current.year %>

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Department Entitlements — <%= year_now %></h5>

    <div class="d-flex gap-2 align-items-center">
      <label class="mb-0 me-2 small text-muted">Filter</label>

      <!-- Client-side filter select -->
      <select id="client-dept-filter" class="form-select form-select-sm">
        <option value="all">All departments</option>
        <% @managed_departments.to_a.each do |d| %>
          <option value="<%= d.id %>"><%= d.name %></option>
        <% end %>
      </select>

      <!-- Excel-style export button (matches modal button styling) -->
      <!-- Uses FontAwesome icon if available; otherwise shows "Export" text -->
      <button id="export-xlsx-btn"
              type="button"
              class="btn btn-sm btn-outline-success ms-2"
              title="Export visible rows to Excel"
              aria-label="Export visible rows to Excel">
        <i class="fa-solid fa-file-excel" aria-hidden="true"></i>
      </button>
    </div>
  </div>

  <div class="card-body p-0">
    <table class="table table-sm mb-0" id="dept-entitlements-table">
      <thead class="table-light">
        <tr>
          <th>Department</th>
          <th>Name</th>
          <th>Total</th>
          <th>Booked</th>
          <th>Pending</th>
          <th>Left</th>
          <% if current_user&.email == 'humanresources@bravegenerationacademy.com' %>
            <th>Actions</th>
          <% end %>
        </tr>
      </thead>

      <tbody>
        <% if @rows.blank? %>
          <tr>
            <td colspan="<%= current_user&.email == 'humanresources@bravegenerationacademy.com' ? 7 : 6 %>" class="text-center text-muted py-3">No users found for the selected departments.</td>
          </tr>
        <% else %>
          <% grouped = @rows.group_by do |r|
               dept = (r[:primary_department] || r[:departments].first)
               [dept&.id, dept&.name || "—"]
             end %>

          <% grouped.each do |(dept_id, dept_name), rows| %>
            <% rows.each do |r| %>
              <% primary_dept = (r[:primary_department] || r[:departments].first) %>
              <tr data-dept-id="<%= primary_dept&.id %>">
                <td><%= primary_dept&.name || '—' %></td>
                <td><%= "#{r[:user].full_name}" %></td>
                <td><%= r[:total_holidays] %></td>
                <td>
                  <%= r[:booked_holiday] %>
                  <% if r[:booked_carry_over].to_i > 0 %>
                    <small class="text-muted">(includes <%= r[:booked_carry_over] %> from <%= year_now + 1 %>)</small>
                  <% end %>
                </td>
                <td>
                  <%= r[:pending_holiday] %>
                  <% if r[:pending_carry_over].to_i > 0 %>
                    <small class="text-muted">(includes <%= r[:pending_carry_over] %> from <%= year_now + 1 %>)</small>
                  <% end %>
                </td>
                <td><%= r[:holidays_left] %></td>
                <% if current_user&.email == 'humanresources@bravegenerationacademy.com' %>
                  <td>
                    <button class="btn btn-sm btn-outline-primary edit-entitlement-btn"
                            data-bs-toggle="modal"
                            data-bs-target="#editEntitlementModal"
                            data-user-id="<%= r[:user].id %>"
                            data-full-name="<%= r[:user].full_name %>"
                            data-holidays-left="<%= r[:holidays_left] %>">
                      Edit
                    </button>
                  </td>
                <% end %>
              </tr>
            <% end %>
          <% end %>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<% if current_user&.email == 'humanresources@bravegenerationacademy.com' %>
  <!-- Edit Entitlement Modal -->
  <div class="modal fade" id="editEntitlementModal" tabindex="-1" aria-labelledby="editEntitlementLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editEntitlementLabel">Edit Holidays Left</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <%= form_with url: update_entitlement_leaves_path, method: :patch, id: "edit-entitlement-form" do |f| %>
            <div class="mb-3">
              <label class="form-label">User</label>
              <input type="text" class="form-control" id="edit-user-name" readonly>
              <input type="hidden" name="user_id" id="edit-user-id">
            </div>
            <div class="mb-3">
              <label class="form-label" for="holidays_left">Holidays Left</label>
              <input type="number" class="form-control" name="holidays_left" id="edit-holidays-left" required>
            </div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          <% end %>
        </div>
      </div>
    </div>
  </div>
<% end %>

<!-- Inline scripts: filter + client-side XLSX export (SheetJS) + modal handling -->
<script>
  document.addEventListener('turbo:load', function () {
    var clientFilter = document.getElementById('client-dept-filter');
    var exportBtn = document.getElementById('export-xlsx-btn');
    if (!clientFilter) return;

    // restore saved selection (optional)
    try {
      var saved = localStorage.getItem('deptFilter');
      if (saved) clientFilter.value = saved;
    } catch (e) {}

    function applyFilter(val) {
      var allRows = document.querySelectorAll('#dept-entitlements-table tbody tr[data-dept-id]');
      allRows.forEach(function (row) {
        if (val === 'all' || val === '' ) {
          row.style.display = '';
        } else {
          row.style.display = (row.dataset.deptId === val) ? '' : 'none';
        }
      });
    }

    applyFilter(clientFilter.value);

    clientFilter.addEventListener('change', function () {
      var val = clientFilter.value;
      try { localStorage.setItem('deptFilter', val); } catch (e) {}
      applyFilter(val);
    });

    // Ensure SheetJS (XLSX) is loaded, then call callback
    function ensureXLSX(callback) {
      if (window.XLSX) return callback();
      var s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js';
      s.async = true;
      s.onload = function () { callback(); };
      s.onerror = function () {
        alert('Failed to load Excel export library. Please try again or contact the administrator.');
      };
      document.head.appendChild(s);
    }

    // Export visible rows to .xlsx
    function exportVisibleRowsXLSX() {
      var table = document.getElementById('dept-entitlements-table');
      if (!table) { alert('Table not found'); return; }

      var theadRow = table.querySelector('thead tr');
      var allHeaders = Array.from(theadRow.querySelectorAll('th')).map(th => th.innerText.trim());
      var header = allHeaders[allHeaders.length - 1] === 'Actions' ? allHeaders.slice(0, -1) : allHeaders;

      var tbodyRows = Array.from(table.querySelectorAll('tbody tr'));
      var visibleData = [];

      tbodyRows.forEach(function (row) {
        // only export data rows that have data-dept-id and are visible
        if (!row.dataset.deptId) return;
        var style = window.getComputedStyle(row);
        if (style.display === 'none') return;

        var cols = Array.from(row.querySelectorAll('td'));
        if (cols.length === 0) return;

        // Extract text content and trim (up to header length to skip actions if present)
        var cells = cols.slice(0, header.length).map(function (td) {
          return (td.innerText || '').trim();
        });
        visibleData.push(cells);
      });

      if (visibleData.length === 0) {
        alert('No visible rows to export.');
        return;
      }

      var aoa = [header].concat(visibleData);

      // Use SheetJS to create workbook
      try {
        var ws = XLSX.utils.aoa_to_sheet(aoa);

        // Optional: set column widths (characters)
        ws['!cols'] = [
          { wch: 25 }, // Department
          { wch: 30 }, // Name
          { wch: 10 }, // Total
          { wch: 15 }, // Booked
          { wch: 15 }, // Pending
          { wch: 10 }  // Left
        ];

        var wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Entitlements');

        var wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        var blob = new Blob([wbout], { type: 'application/octet-stream' });

        var filename = 'department_entitlements_' + new Date().toISOString().slice(0,10) + '.xlsx';
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error('XLSX export error', err);
        alert('Failed to export to Excel. Check console for details.');
      }
    }

    if (exportBtn) {
      exportBtn.addEventListener('click', function () {
        ensureXLSX(function () { exportVisibleRowsXLSX(); });
      });
    }

    // Handle edit entitlement buttons
    const editBtns = document.querySelectorAll('.edit-entitlement-btn');
    const modal = document.getElementById('editEntitlementModal');
    if (modal) {
      editBtns.forEach(btn => {
        btn.addEventListener('click', function (e) {
          e.preventDefault();
          const userId = btn.dataset.userId;
          const fullName = btn.dataset.fullName;
          const holidaysLeft = btn.dataset.holidaysLeft;
          document.getElementById('edit-user-name').value = fullName;
          document.getElementById('edit-user-id').value = userId;
          document.getElementById('edit-holidays-left').value = holidaysLeft;
        });
      });
    }
  });
</script>
