<% year_now = Date.current.year %>

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Department Entitlements — <%= year_now %></h5>

    <div class="d-flex gap-2 align-items-center">
      <label class="mb-0 me-2 small text-muted">Filter</label>

      <!-- Client-side filter select -->
      <select id="client-dept-filter" class="form-select form-select-sm">
        <option value="all">All departments</option>
        <% @managed_departments.to_a.each do |d| %>
          <option value="<%= d.id %>"><%= d.name %></option>
        <% end %>
      </select>

      <!-- Excel-style export button (matches modal button styling) -->
      <!-- Uses FontAwesome icon if available; otherwise shows "Export" text -->
      <button id="export-xlsx-btn"
              type="button"
              class="btn btn-sm btn-outline-success ms-2"
              title="Export visible rows to Excel"
              aria-label="Export visible rows to Excel">
        <i class="fa-solid fa-file-excel" aria-hidden="true"></i>
      </button>
    </div>
  </div>

  <div class="card-body p-0">
    <table class="table table-sm mb-0" id="dept-entitlements-table">
      <thead class="table-light">
        <tr>
          <th>Department</th>
          <th>Name</th>
          <th>Total</th>
          <th>Booked</th>
          <th>Pending</th>
          <th>Left</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
        <% if @rows.blank? %>
          <tr>
            <td colspan="7" class="text-center text-muted py-3">No users found for the selected departments.</td>
          </tr>
        <% else %>
          <% grouped = @rows.group_by do |r|
               dept = (r[:primary_department] || r[:departments].first)
               [dept&.id, dept&.name || "—"]
             end %>

          <% grouped.each do |(dept_id, dept_name), rows| %>
            <% rows.each do |r| %>
              <% primary_dept = (r[:primary_department] || r[:departments].first) %>
              <tr data-dept-id="<%= primary_dept&.id %>">
                <td><%= primary_dept&.name || '—' %></td>
                <td><%= "#{r[:user].full_name}" %></td>
                <td><%= r[:total_holidays] %></td>
                <td>
                  <%= r[:booked_holiday] %>
                  <% if r[:booked_carry_over].to_i > 0 %>
                    <small class="text-muted">(includes <%= r[:booked_carry_over] %> from <%= year_now + 1 %>)</small>
                  <% end %>
                </td>
                <td>
                  <%= r[:pending_holiday] %>
                  <% if r[:pending_carry_over].to_i > 0 %>
                    <small class="text-muted">(includes <%= r[:pending_carry_over] %> from <%= year_now + 1 %>)</small>
                  <% end %>
                </td>
                <td><%= r[:holidays_left] %></td>
                <td>
                  <button type="button"
                          class="btn btn-sm btn-outline-primary edit-entitlement"
                          data-user-id="<%= r[:user].id %>"
                          data-year="<%= year_now %>"
                          data-current-total="<%= r[:total_holidays] %>"
                          data-current-booked="<%= r[:booked_holiday] %>"
                          data-current-pending="<%= r[:pending_holiday] %>"
                          data-current-left="<%= r[:holidays_left] %>">Edit</button>
                </td>
              </tr>
            <% end %>
          <% end %>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<!-- Edit Entitlement Modal -->
<div class="modal fade" id="edit-entitlement-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Entitlement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-entitlement-form">
          <input type="hidden" name="user_id" id="edit-user-id">
          <input type="hidden" name="year" id="edit-year">
          <div class="mb-3">
            <label for="annual-total" class="form-label">Total (Annual Allowance)</label>
            <input type="number" class="form-control" id="annual-total" name="annual_total" min="0">
          </div>
          <div class="mb-3">
            <label for="remaining-left" class="form-label">Left (Remaining Days)</label>
            <input type="number" class="form-control" id="remaining-left" name="new_holidays_left" min="0">
          </div>
          <p>Current Booked: <span id="current-booked"></span></p>
          <p>Current Pending: <span id="current-pending"></span></p>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="save-entitlement">Save changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Inline scripts: filter + client-side XLSX export (SheetJS) -->
<script>
  document.addEventListener('turbo:load', function () {
    var clientFilter = document.getElementById('client-dept-filter');
    var exportBtn = document.getElementById('export-xlsx-btn');
    if (!clientFilter) return;

    // restore saved selection (optional)
    try {
      var saved = localStorage.getItem('deptFilter');
      if (saved) clientFilter.value = saved;
    } catch (e) {}

    function applyFilter(val) {
      var allRows = document.querySelectorAll('#dept-entitlements-table tbody tr[data-dept-id]');
      allRows.forEach(function (row) {
        if (val === 'all' || val === '' ) {
          row.style.display = '';
        } else {
          row.style.display = (row.dataset.deptId === val) ? '' : 'none';
        }
      });
    }

    applyFilter(clientFilter.value);

    clientFilter.addEventListener('change', function () {
      var val = clientFilter.value;
      try { localStorage.setItem('deptFilter', val); } catch (e) {}
      applyFilter(val);
    });

    // Ensure SheetJS (XLSX) is loaded, then call callback
    function ensureXLSX(callback) {
      if (window.XLSX) return callback();
      var s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js';
      s.async = true;
      s.onload = function () { callback(); };
      s.onerror = function () {
        alert('Failed to load Excel export library. Please try again or contact the administrator.');
      };
      document.head.appendChild(s);
    }

    // Export visible rows to .xlsx
    function exportVisibleRowsXLSX() {
      var table = document.getElementById('dept-entitlements-table');
      if (!table) { alert('Table not found'); return; }

      var tbodyRows = Array.from(table.querySelectorAll('tbody tr'));
      var visibleData = [];

      tbodyRows.forEach(function (row) {
        // only export data rows that have data-dept-id and are visible
        if (!row.dataset.deptId) return;
        var style = window.getComputedStyle(row);
        if (style.display === 'none') return;

        var cols = Array.from(row.querySelectorAll('td'));
        if (cols.length === 0) return;

        // Extract text content and trim, exclude actions column
        var cells = cols.slice(0, 6).map(function (td) {
          return (td.innerText || '').trim();
        });
        visibleData.push(cells);
      });

      if (visibleData.length === 0) {
        alert('No visible rows to export.');
        return;
      }

      // Header row
      var header = ['Department', 'Name', 'Total', 'Booked', 'Pending', 'Left'];
      var aoa = [header].concat(visibleData);

      // Use SheetJS to create workbook
      try {
        var ws = XLSX.utils.aoa_to_sheet(aoa);

        // Optional: set column widths (characters)
        ws['!cols'] = [
          { wch: 25 }, // Department
          { wch: 30 }, // Name
          { wch: 10 }, // Total
          { wch: 15 }, // Booked
          { wch: 15 }, // Pending
          { wch: 10 }  // Left
        ];

        var wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Entitlements');

        var wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        var blob = new Blob([wbout], { type: 'application/octet-stream' });

        var filename = 'department_entitlements_' + new Date().toISOString().slice(0,10) + '.xlsx';
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error('XLSX export error', err);
        alert('Failed to export to Excel. Check console for details.');
      }
    }

    if (exportBtn) {
      exportBtn.addEventListener('click', function () {
        ensureXLSX(function () { exportVisibleRowsXLSX(); });
      });
    }

    // Edit entitlement JS
    document.querySelectorAll('.edit-entitlement').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var userId = btn.dataset.userId;
        var year = btn.dataset.year;
        var currentTotal = parseInt(btn.dataset.currentTotal) || 0;
        var currentBooked = parseInt(btn.dataset.currentBooked) || 0;
        var currentPending = parseInt(btn.dataset.currentPending) || 0;
        var currentLeft = parseInt(btn.dataset.currentLeft) || 0;

        document.getElementById('edit-user-id').value = userId;
        document.getElementById('edit-year').value = year;
        var totalInput = document.getElementById('annual-total');
        var leftInput = document.getElementById('remaining-left');
        totalInput.value = currentTotal;
        leftInput.value = currentLeft;
        document.getElementById('current-booked').innerText = currentBooked;
        document.getElementById('current-pending').innerText = currentPending;

        // Enforce non-negative
        totalInput.addEventListener('input', function () {
          var val = parseInt(this.value);
          if (isNaN(val) || val < 0) this.value = 0;
        });
        leftInput.addEventListener('input', function () {
          var val = parseInt(this.value);
          if (isNaN(val) || val < 0) this.value = 0;
        });

        var modal = new bootstrap.Modal(document.getElementById('edit-entitlement-modal'));
        modal.show();
      });
    });

    var saveBtn = document.getElementById('save-entitlement');
    if (saveBtn) {
      saveBtn.addEventListener('click', function () {
        var form = document.getElementById('edit-entitlement-form');
        var data = new FormData(form);

        fetch('/leaves/update_entitlement', {
          method: 'POST',
          body: data,
          headers: {
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          }
        }).then(function (response) {
          if (response.ok) {
            location.reload();
          } else {
            alert('Failed to update entitlement.');
          }
        }).catch(function (err) {
          alert('Error: ' + err.message);
        });
      });
    }
  });
</script>
