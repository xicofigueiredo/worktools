<% year = params[:year] ? params[:year].to_i : Date.current.year %>
<% prev_year = year - 1 %>
<% next_year = year + 1 %>

<style>
  .calendar-table th, .calendar-table td {
    width: 14.28%;
    text-align: center;
    vertical-align: middle;
    height: 40px;
  }
  .calendar-table td {
    position: relative;
    cursor: default;
    transition: all 0.15s ease;
  }
  .calendar-table td:not(:empty):hover {
    transform: scale(1.05);
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  .holiday {
    background-color: #d1e7dd !important;
    font-weight: 600;
  }
  .blocked {
    background-image: linear-gradient(45deg, #f8d7da 25%, transparent 25%, transparent 50%, #f8d7da 50%, #f8d7da 75%, transparent 75%, transparent) !important;
    background-size: 8px 8px;
  }
  .holiday.blocked {
    background: linear-gradient(135deg, #d1e7dd 50%, #f8d7da 50%) !important;
  }
  .weekend {
    background-color: #f8f9fa;
  }
  .month-card {
    transition: all 0.2s ease;
  }
  .month-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }
  .filter-section {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.25rem;
    margin-bottom: 1rem;
  }
  .legend-item {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-right: 1.5rem;
  }
  .legend-box {
    width: 20px;
    height: 20px;
    border-radius: 3px;
    border: 1px solid #dee2e6;
  }
  .legend-box.holiday {
    background-color: #d1e7dd;
  }
  .legend-box.blocked {
    background-image: linear-gradient(45deg, #f8d7da 25%, transparent 25%, transparent 50%, #f8d7da 50%, #f8d7da 75%, transparent 75%, transparent);
    background-size: 8px 8px;
  }
  .legend-box.both {
    background: linear-gradient(135deg, #d1e7dd 50%, #f8d7da 50%);
  }
</style>

<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h2 class="h5 mb-0">Public Holidays and Blocked Periods for <%= year %></h2>
    <div>
      <button type="button" class="btn btn-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#createEventModal">
        <i class="fas fa-plus"></i> Add Event
      </button>
      <%= link_to 'Previous Year', leaves_path(year: prev_year, month: params[:month], active_tab: 'calendar'), class: 'btn btn-link btn-sm me-2' %>
      <%= link_to 'Next Year', leaves_path(year: next_year, month: params[:month], active_tab: 'calendar'), class: 'btn btn-link btn-sm' %>
    </div>
  </div>

  <div class="card-body">
    <!-- Filters Section -->
    <div class="filter-section">
      <form id="calendarFilters">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label small fw-bold">Country</label>
            <select class="form-select form-select-sm" id="countryFilter" name="country_filter">
              <option value="">All Countries</option>
              <% countries = @hubs.map(&:country).compact.uniq.sort %>
              <% countries.each do |country| %>
                <option value="<%= country %>" <%= 'selected' if params[:country_filter] == country %>><%= country %></option>
              <% end %>
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label small fw-bold">Hub</label>
            <select class="form-select form-select-sm" id="hubFilter" name="hub_filter">
              <option value="">All Hubs</option>
              <% @hubs.each do |hub| %>
                <option value="<%= hub.id %>" data-country="<%= hub.country %>" <%= 'selected' if params[:hub_filter].to_i == hub.id %>><%= hub.name %></option>
              <% end %>
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label small fw-bold">Department</label>
            <select class="form-select form-select-sm" id="departmentFilter" name="department_filter">
              <option value="">All Departments</option>
              <% @departments.each do |dept| %>
                <option value="<%= dept.id %>" <%= 'selected' if params[:department_filter].to_i == dept.id %>><%= dept.name %></option>
              <% end %>
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label small fw-bold">Type</label>
            <select class="form-select form-select-sm" id="typeFilter" name="type_filter">
              <option value="">All Types</option>
              <option value="holidays" <%= 'selected' if params[:type_filter] == 'holidays' %>>Holidays Only</option>
              <option value="blocked" <%= 'selected' if params[:type_filter] == 'blocked' %>>Blocked Periods Only</option>
            </select>
          </div>
        </div>
      </form>
    </div>

    <!-- Legend -->
    <div class="mb-3 pb-2 border-bottom">
      <div class="d-flex flex-wrap align-items-center gap-2">
        <span class="small text-muted me-2">Legend:</span>
        <div class="legend-item">
          <div class="legend-box holiday"></div>
          <span class="small">Public Holiday</span>
        </div>
        <div class="legend-item">
          <div class="legend-box blocked"></div>
          <span class="small">Blocked Period</span>
        </div>
        <div class="legend-item">
          <div class="legend-box both"></div>
          <span class="small">Both</span>
        </div>
      </div>
    </div>

    <%
      # Apply filters
      country_filter = params[:country_filter] if params[:country_filter].present?
      hub_filter = params[:hub_filter].to_i if params[:hub_filter].present?
      dept_filter = params[:department_filter].to_i if params[:department_filter].present?
      type_filter = params[:type_filter]

      # Create a hash of hub_id => country for quick lookup
      hub_countries = {}
      @hubs.each { |h| hub_countries[h.id] = h.country }

      holidays_by_date = {}

      if hub_filter.present? && !country_filter.present?
        country_filter = hub_countries[hub_filter]
      end

      # Filter holidays based on type
      unless type_filter == 'blocked'
        filtered_holidays = @public_holidays.select do |h|
          match = true

          # Apply country filter
          if country_filter.present?
            # Holiday matches if its country field matches
            # OR if it has a hub_id whose hub's country matches
            country_match = false

            if h.country.present? && h.country == country_filter
              country_match = true
            elsif h.hub_id.present? && hub_countries[h.hub_id] == country_filter
              country_match = true
            end

            match = match && country_match
          end

          # Apply hub filter
          if hub_filter.present?
            # Holiday matches if its hub_id matches
            # If holiday has no hub_id, it's global and should show
            if h.hub_id.present?
              match = match && h.hub_id == hub_filter
            end
            # Global holidays (no hub_id) always match when there's a hub filter
          end

          match
        end

        # Process non-recurring holidays
        filtered_holidays.reject(&:recurring).select { |h| h.date.year == year }.each do |h|
          holidays_by_date[h.date] ||= []
          holidays_by_date[h.date] << h
        end

        # Process recurring holidays
        filtered_holidays.select(&:recurring).each do |h|
          begin
            d = Date.new(year, h.date.month, h.date.day)
            holidays_by_date[d] ||= []
            holidays_by_date[d] << h
          rescue Date::Error
            # Skip invalid dates (e.g., Feb 29 on non-leap year)
          end
        end
      end

      blocked_by_date = {}

      # Filter blocked periods based on type and other filters
      unless type_filter == 'holidays'
        filtered_blocked = @blocked_periods.select do |b|
          match = true

          # Apply country filter
          if country_filter.present?
            # Blocked period matches if its hub's country matches
            # If no hub_id, it's global and should show
            if b.hub_id.present?
              hub_country = hub_countries[b.hub_id]
              match = match && (hub_country == country_filter)
            end
            # Global blocked periods (no hub_id) always match
          end

          # Apply hub filter
          if hub_filter.present?
            # Blocked period matches if its hub_id matches
            # If no hub_id, it's global and should show
            if b.hub_id.present?
              match = match && b.hub_id == hub_filter
            end
            # Global blocked periods (no hub_id) always match
          end

          # Apply department filter
          if dept_filter.present?
            # Blocked period matches if its department_id matches
            # If no department_id, it's global and should show
            if b.department_id.present?
              match = match && b.department_id == dept_filter
            end
            # Global blocked periods (no department_id) always match
          end

          match
        end

        filtered_blocked.each do |b|
          (b.start_date..b.end_date).each do |d|
            next unless d.year == year
            blocked_by_date[d] ||= []
            blocked_by_date[d] << b
          end
        end
      end
    %>

    <% if holidays_by_date.blank? && blocked_by_date.blank? %>
      <div class="text-center py-5">
        <p class="text-muted mb-0">No public holidays or blocked periods for <%= year %> with the selected filters.</p>
      </div>
    <% else %>
      <div class="row">
        <% (1..12).each do |month| %>
          <div class="col-md-4 mb-3">
            <div class="card month-card">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><%= Date::MONTHNAMES[month] %></h6>
              </div>
              <div class="card-body p-0">
                <%
                  first_day = Date.new(year, month, 1)
                  last_day = first_day.end_of_month
                  start_wday = first_day.wday
                  week = 0
                %>
                <table class="table table-bordered table-sm mb-0 calendar-table">
                  <thead class="table-light">
                    <tr>
                      <th>S</th><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% while week * 7 - start_wday < last_day.day %>
                      <tr>
                        <% (0..6).each do |day_in_week| %>
                          <% actual_day = week * 7 + day_in_week - start_wday + 1 %>
                          <% if actual_day < 1 || actual_day > last_day.day %>
                            <td></td>
                          <% else %>
                            <% date = Date.new(year, month, actual_day) %>
                            <% classes = [] %>

                            <%# We will build an HTML string for the Popover content %>
                            <% popover_content = [] %>

                            <% if holidays = holidays_by_date[date] %>
                              <% classes << 'holiday' %>
                              <% holidays.each do |h| %>
                                <%# Create the delete link %>
                                <% delete_link = if @show_hr_view
                                    link_to(
                                      '<i class="fas fa-trash"></i>'.html_safe,
                                      public_holiday_path(h),
                                      data: { turbo_method: :delete, turbo_confirm: "Delete holiday #{h.name}?" },
                                      class: "text-danger ms-2",
                                      tabindex: "-1",
                                      title: "Delete holiday"
                                    )
                                  else
                                    ""
                                  end
                                %>
                                <% popover_content << "<div class='d-flex justify-content-between align-items-center mb-1'><span>ðŸŽ‰ #{ERB::Util.html_escape(h.name)}</span> #{delete_link}</div>" %>
                              <% end %>
                            <% end %>

                            <% if blocked = blocked_by_date[date] %>
                              <% classes << 'blocked' %>
                              <% blocked.each do |b| %>
                                <%# Determine the name to show %>
                                <% if b.user_id %>
                                  <% entity = @users.find { |u| u.id == b.user_id }&.full_name || 'User' %>
                                  <% label = "ðŸ‘¤ #{entity}" %>
                                <% elsif b.department_id %>
                                  <% entity = @departments.find { |d| d.id == b.department_id }&.name || 'Dept' %>
                                  <% label = "ðŸ¢ #{entity}" %>
                                <% elsif b.hub_id %>
                                  <% entity = @hubs.find { |h| h.id == b.hub_id }&.name || 'Hub' %>
                                  <% label = "ðŸ“ #{entity}" %>
                                <% else %>
                                  <% label = "ðŸŒ Global Block" %>
                                <% end %>

                                <%# Create the delete link %>
                                <% delete_link = if @show_hr_view
                                    link_to(
                                      '<i class="fas fa-trash"></i>'.html_safe,
                                      blocked_period_path(b),
                                      data: { turbo_method: :delete, turbo_confirm: "Delete this blocked period?" },
                                      class: "text-danger ms-2",
                                      tabindex: "-1",
                                      title: "Delete blocked period"
                                    )
                                  else
                                    ""
                                  end
                                %>
                                <% popover_content << "<div class='d-flex justify-content-between align-items-center mb-1'><span class='small'>ðŸš« #{ERB::Util.html_escape(label)}</span> #{delete_link}</div>" %>
                              <% end %>
                            <% end %>

                            <% if day_in_week == 0 || day_in_week == 6 %>
                              <% classes << 'weekend' unless classes.any? %>
                            <% end %>

                            <% cell_classes = classes.join(' ') %>
                            <% has_events = popover_content.any? %>

                            <%# RENDER THE CELL %>
                            <td class="<%= cell_classes %>"
                                <% if has_events %>
                                  style="cursor: pointer;"
                                  data-bs-toggle="popover"
                                  data-bs-placement="top"
                                  data-bs-html="true"
                                  data-bs-title="Events for <%= date.strftime('%b %d') %>"
                                  data-bs-content="<%= ERB::Util.html_escape(popover_content.join('')) %>"
                                <% end %>
                            >
                              <%= actual_day %>
                            </td>
                          <% end %>
                        <% end %>
                      </tr>
                      <% week += 1 %>
                    <% end %>
                    <%# Add empty rows to make all calendars have 6 weeks for consistency %>
                    <% (week...6).each do %>
                      <tr>
                        <% (0..6).each do %><td></td><% end %>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<div class="modal fade" id="createEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Calendar Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <div class="mb-4">
          <label class="form-label fw-bold">What would you like to create?</label>
          <select class="form-select" id="eventTypeSelector">
            <option value="holiday">Public Holiday</option>
            <option value="blocked">Blocked Period</option>
          </select>
        </div>

        <div id="form-holiday-section">
          <%= form_with(model: @new_public_holiday, url: public_holidays_path, local: true) do |f| %>
            <div class="mb-3">
              <%= f.label :name, class: "form-label" %>
              <%= f.text_field :name, class: "form-control", required: true, placeholder: "e.g. Christmas Day" %>
            </div>

            <div class="mb-3">
              <%= f.label :date, class: "form-label" %>
              <%= f.date_field :date, class: "form-control", required: true, value: Date.current %>
            </div>

            <div class="mb-3 form-check">
              <%= f.check_box :recurring, class: "form-check-input" %>
              <%= f.label :recurring, "Recurring every year?", class: "form-check-label" %>
            </div>

            <hr>
            <p class="small text-muted mb-2">Scope (Leave empty for Global/All)</p>

            <div class="row g-2">
              <div class="col-6">
                <%= f.label :country, "Specific Country", class: "form-label small" %>
                <%= f.select :country, @hubs.map(&:country).compact.uniq.sort, { include_blank: "Global / All" }, { class: "form-select form-select-sm" } %>
              </div>
              <div class="col-6">
                <%= f.label :hub_id, "Specific Hub", class: "form-label small" %>
                <%= f.collection_select :hub_id, @hubs, :id, :name, { include_blank: "None" }, { class: "form-select form-select-sm" } %>
              </div>
            </div>

            <div class="mt-4 text-end">
              <button type="submit" class="btn btn-success">Create Holiday</button>
            </div>
          <% end %>
        </div>

        <div id="form-blocked-section" style="display: none;">
          <%= form_with(model: @new_blocked_period, url: blocked_periods_path, local: true) do |f| %>

            <div class="row g-2 mb-3">
              <div class="col-6">
                <%= f.label :start_date, class: "form-label" %>
                <%= f.date_field :start_date, class: "form-control", required: true %>
              </div>
              <div class="col-6">
                <%= f.label :end_date, class: "form-label" %>
                <%= f.date_field :end_date, class: "form-control", required: true %>
              </div>
            </div>

            <hr>
            <div class="mb-3">
              <label class="form-label">Who is this blocked for?</label>
              <select class="form-select" id="blockedTargetSelector">
                <option value="global">Entire Organization (Global)</option>
                <option value="hub">Specific Hub</option>
                <option value="department">Specific Department</option>
                <option value="user">Specific User</option>
              </select>
            </div>

            <div id="target-hub" class="target-group mb-3" style="display:none;">
              <%= f.label :hub_id, "Select Hub", class: "form-label" %>
              <%= f.collection_select :hub_id, @hubs, :id, :name, { include_blank: "Select Hub..." }, { class: "form-select" } %>
            </div>

            <div id="target-department" class="target-group mb-3" style="display:none;">
              <%= f.label :department_id, "Select Department", class: "form-label" %>
              <%= f.collection_select :department_id, @departments, :id, :name, { include_blank: "Select Department..." }, { class: "form-select" } %>
            </div>

            <div id="target-user" class="target-group mb-3" style="display:none;">
              <%= f.label :user_id, "Select User", class: "form-label" %>
              <%= f.collection_select :user_id, @users, :id, :full_name, { include_blank: "Select User..." }, { class: "form-select" } %>
            </div>

            <div class="mt-4 text-end">
              <button type="submit" class="btn btn-warning">Create Blocked Period</button>
            </div>
          <% end %>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('turbo:load', function () {
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
      popoverTriggerEl.addEventListener('show.bs.popover', function (e) {
        popoverTriggerList.forEach(function (el) {
          if (el !== popoverTriggerEl) {
            var popover = bootstrap.Popover.getInstance(el);
            if (popover) {
              popover.hide();
            }
          }
        });
      });
      return new bootstrap.Popover(popoverTriggerEl, {
        trigger: 'click',
        sanitize: false,
        container: 'body'
      });
    });

    document.addEventListener('click', function (e) {
      popoverList.forEach(function (popover) {
        if (popover.tip && popover.tip.classList.contains('show')) {
          if (
            !popover._element.contains(e.target) &&
            !popover.tip.contains(e.target)
          ) {
            popover.hide();
          }
        }
      });
    });

    // Handle country filter change - update hub dropdown
    var countryFilter = document.getElementById('countryFilter');
    var hubFilter = document.getElementById('hubFilter');

    if (countryFilter && hubFilter) {
      countryFilter.addEventListener('change', function() {
        var selectedCountry = this.value;
        var hubOptions = hubFilter.querySelectorAll('option');

        hubOptions.forEach(function(option) {
          if (option.value === '') {
            option.style.display = '';
            return;
          }

          var optionCountry = option.getAttribute('data-country');
          if (!selectedCountry || optionCountry === selectedCountry) {
            option.style.display = '';
          } else {
            option.style.display = 'none';
          }
        });

        // Reset hub selection if it's now hidden
        if (hubFilter.value && hubFilter.selectedOptions[0].style.display === 'none') {
          hubFilter.value = '';
        }
      });
    }

    // Handle filter changes
    var filterSelects = document.querySelectorAll('.filter-section select');
    filterSelects.forEach(function(select) {
      select.addEventListener('change', function() {
        var form = document.getElementById('calendarFilters');
        var formData = new FormData(form);
        var params = new URLSearchParams(window.location.search);

        // Update URL params with filter values
        formData.forEach(function(value, key) {
          if (value) {
            params.set(key, value);
          } else {
            params.delete(key);
          }
        });

        // Preserve year and active_tab
        if (!params.has('year')) {
          params.set('year', '<%= year %>');
        }
        params.set('active_tab', 'calendar');

        // Redirect with new params
        window.location.href = window.location.pathname + '?' + params.toString();
      });
    });

    var typeSelector = document.getElementById('eventTypeSelector');
    var holidaySection = document.getElementById('form-holiday-section');
    var blockedSection = document.getElementById('form-blocked-section');

    if(typeSelector) {
      typeSelector.addEventListener('change', function() {
        if(this.value === 'holiday') {
          holidaySection.style.display = 'block';
          blockedSection.style.display = 'none';
        } else {
          holidaySection.style.display = 'none';
          blockedSection.style.display = 'block';
        }
      });
    }

    var targetSelector = document.getElementById('blockedTargetSelector');
    var targetGroups = document.querySelectorAll('.target-group');

    if(targetSelector) {
      targetSelector.addEventListener('change', function() {
        // Hide all target specific inputs first
        targetGroups.forEach(function(el) { el.style.display = 'none'; });
        // Reset their values so we don't submit hidden data
        targetGroups.forEach(function(el) {
          var select = el.querySelector('select');
          if(select) select.value = "";
        });

        // Show the selected one
        var selection = this.value;
        if(selection !== 'global') {
          var targetDiv = document.getElementById('target-' + selection);
          if(targetDiv) targetDiv.style.display = 'block';
        }
      });
    }
  });
</script>
