<%= form_with(model: @weekly_goal, local: true) do |form| %>
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-13">
        <% if @weekly_goal.errors.any? %>
          <div id="error_explanation" class="alert alert-danger">
            <h2><%= pluralize(@weekly_goal.errors.count, "error") %> prohibited this weekly goal from being saved:</h2>
            <ul>
              <% @weekly_goal.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div class="card">
          <div class="card-body">
            <!-- Week Selection -->
            <div class="field">
              <%= form.label :week_id, 'Select Week' %>
              <%= form.collection_select :week_id, @available_weeks, :id, :name, include_blank: true, class: 'form-select', required: true %>
            </div>

            <!-- Schedule Table -->
            <div class="table-responsive">
              <table class="table table-bordered text-center">
                <thead>
                  <tr class="bg-gray">
                    <th class="text-uppercase">Time</th>
                    <% WeeklySlot.day_of_weeks.keys.each do |day| %>
                      <th class="text-uppercase"><%= day.capitalize %></th>
                    <% end %>
                  </tr>
                </thead>
                <tbody>
                  <%= form.fields_for :weekly_slots do |slot_form| %>
                    <% day = slot_form.object.day_of_week.capitalize %>
                    <% time = slot_form.object.time_slot.capitalize %>
                    <tr>
                      <td class="align-middle"><%= time %></td>
                      <% WeeklySlot.day_of_weeks.keys.each do |day| %>
                        <td class="align-middle">
                          <div class="form-group" data-controller="selects">
                            <%= slot_form.collection_select :subject_name, @subjects || [], :id, :name, {prompt: "Select a subject"}, {class: "form-control", "data-action": "change->selects#updateTopics", "data-selects-target": "subject"} %>
                            <%= slot_form.collection_select :topic_name, [], :id, :name, {prompt: ""}, {class: "form-control", "data-selects-target": "topic"} %>
                          </div>
                        </td>
                      <% end %>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
            <!-- Form Actions -->
            <div class="text-center mt-4">
              <%= form.submit 'Save Weekly Goal', class: 'btn btn-primary' %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>
