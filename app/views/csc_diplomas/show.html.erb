<div class="container mt-4">
  <% if notice.present? %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <%= notice %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% end %>
  <% if alert.present? %>
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
      <%= alert %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% end %>

  <div class="d-flex justify-content-between align-items-center mb-4" >
    <h1>CSC Diploma</h1>
    <div class="d-flex align-items-center gap-3">
      <%= button_to fetch_activities_csc_diploma_path, method: :post, class: "btn btn-primary", data: { turbo_confirm: "This will fetch activities from your last sprint goal. Continue?" } do %>
        <i class="fa-solid fa-download me-1"></i> Fetch Activities
      <% end %>
      <% if @csc_diploma.issued? %>
        <span class="badge bg-success fs-6">
          <i class="fa-solid fa-check-circle me-1"></i> Issued
        </span>
      <% else %>
        <span class="badge bg-secondary fs-6">
          <i class="fa-solid fa-clock me-1"></i> In Progress
        </span>
      <% end %>
    </div>
  </div>

  <div data-controller="totals-calculator">
    <div class="d-flex justify-content-center">
      <div data-totals-calculator-target="weightWarning" style="display: none;"></div>
    </div>

    <div class="card">
    <div class="card-header">
      <h5 class="mb-0">Activities</h5>
    </div>
    <div class="card-body">
      <% if @csc_activities.any? || @hidden_activities.any? %>
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr class="text-center">
                <th class="text-start">Activity</th>
                <th>Type</th>
                <th>Sprint</th>
                <th>Hours</th>
                <th>Base <i class="fa-solid fa-circle-info text-secondary" data-bs-toggle="tooltip" title="Hours รท 8 (max 3.5)"></i></th>
                <th>Extra <i class="fa-solid fa-circle-info text-secondary" data-bs-toggle="tooltip" title="Additional credits"></i></th>
                <th>Credits <i class="fa-solid fa-circle-info text-secondary" data-bs-toggle="tooltip" title="Base + Extra"></i></th>
                <th>Rubric</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% @csc_activities.each do |activity| %>
                <tr data-controller="activity-row-calculator" data-activity-type="<%= activity.activitable_type %>" class="text-center">
                  <td class="text-start">
                    <% if activity.activitable.is_a?(Skill) %>
                      <%= activity.activitable.extracurricular %>
                    <% elsif activity.activitable.is_a?(Community) %>
                      <%= activity.activitable.involved %>
                    <% end %>
                  </td>
                  <td>
                    <span class="badge <%= activity.activitable_type == 'Skill' ? 'bg-info' : 'bg-primary' %>">
                      <%= activity.activitable_type %>
                    </span>
                  </td>
                  <td>
                    <% if activity.activitable.respond_to?(:sprint_goal) && activity.activitable.sprint_goal&.sprint %>
                      <%= activity.activitable.sprint_goal.sprint.name %> <%= activity.activitable.sprint_goal.sprint.start_date&.year %>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </td>
                  <%= form_with model: activity, url: csc_activity_path(activity), method: :patch, data: { activity_row_calculator_target: "form" } do |f| %>
                    <td>
                      <input type="number" name="csc_activity[hours]" value="<%= activity.hours %>" class="form-control form-control-sm mx-auto" style="width: 70px;" min="0" step="1" data-activity-row-calculator-target="hours" data-action="input->activity-row-calculator#calculate blur->activity-row-calculator#save">
                    </td>
                    <td>
                      <%
                        base_credits = '-'
                        if activity.hours.present? && activity.hours > 0
                          base_credits = [activity.hours / 8.0, 3.5].min.round(2)
                        end
                      %>
                      <span data-activity-row-calculator-target="baseCredits"><%= base_credits %></span>
                    </td>
                    <td>
                      <input type="number" name="csc_activity[extra]" value="<%= activity.extra %>" class="form-control form-control-sm mx-auto" style="width: 70px;" min="0" max="3.5" step="0.5" data-activity-row-calculator-target="extra" data-action="input->activity-row-calculator#calculate blur->activity-row-calculator#save">
                      <input type="hidden" name="csc_activity[credits]" value="<%= activity.credits %>" data-activity-row-calculator-target="creditsHidden">
                    </td>
                    <td>
                      <span data-activity-row-calculator-target="finalCredits"><%= activity.credits || '-' %></span>
                    </td>
                    <td>
                      <span><%= activity.rubric_score || '-' %></span>
                    </td>
                  <% end %>
                  <td>
                    <div class="d-flex gap-1 justify-content-center">
                      <%= link_to edit_csc_activity_path(activity), class: "btn btn-sm btn-outline-primary", title: "Edit all fields" do %>
                        <i class="fa-solid fa-pen"></i>
                      <% end %>
                      <%= button_to toggle_hidden_csc_activity_path(activity), method: :patch, class: "btn btn-sm btn-outline-secondary", title: "Hide activity", form: { style: "display: inline;" } do %>
                        <i class="fa-solid fa-eye-slash"></i>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>

              <% if @hidden_activities.any? %>
                <tr>
                  <td colspan="9" class="text-center py-2">
                    <hr class="my-1">
                    <small class="text-muted">Hidden Activities</small>
                    <hr class="my-1">
                  </td>
                </tr>
                <% @hidden_activities.each do |activity| %>
                  <tr class="table-secondary text-muted text-center" style="opacity: 0.6;" data-controller="activity-row-calculator" data-activity-type="<%= activity.activitable_type %>" data-hidden="true">
                    <td class="text-start">
                      <% if activity.activitable.is_a?(Skill) %>
                        <%= activity.activitable.extracurricular %>
                      <% elsif activity.activitable.is_a?(Community) %>
                        <%= activity.activitable.involved %>
                      <% end %>
                    </td>
                    <td>
                      <span class="badge bg-secondary">
                        <%= activity.activitable_type %>
                      </span>
                    </td>
                    <td>
                      <% if activity.activitable.respond_to?(:sprint_goal) && activity.activitable.sprint_goal&.sprint %>
                        <%= activity.activitable.sprint_goal.sprint.name %> <%= activity.activitable.sprint_goal.sprint.start_date&.year %>
                      <% else %>
                        <span class="text-muted">-</span>
                      <% end %>
                    </td>
                    <%= form_with model: activity, url: csc_activity_path(activity), method: :patch, data: { activity_row_calculator_target: "form" } do |f| %>
                      <td>
                        <input type="number" name="csc_activity[hours]" value="<%= activity.hours %>" class="form-control form-control-sm mx-auto" style="width: 70px;" min="0" step="1" data-activity-row-calculator-target="hours" data-action="input->activity-row-calculator#calculate blur->activity-row-calculator#save">
                      </td>
                      <td>
                        <%
                        base_credits = '-'
                        if activity.hours.present? && activity.hours > 0
                          base_credits = [activity.hours / 8.0, 3.5].min.round(2)
                        end
                        %>
                        <span data-activity-row-calculator-target="baseCredits"><%= base_credits %></span>
                      </td>
                      <td>
                        <input type="number" name="csc_activity[extra]" value="<%= activity.extra %>" class="form-control form-control-sm mx-auto" style="width: 70px;" min="0" max="3.5" step="0.5" data-activity-row-calculator-target="extra" data-action="input->activity-row-calculator#calculate blur->activity-row-calculator#save">
                        <input type="hidden" name="csc_activity[credits]" value="<%= activity.credits %>" data-activity-row-calculator-target="creditsHidden">
                      </td>
                      <td>
                        <span data-activity-row-calculator-target="finalCredits"><%= activity.credits || '-' %></span>
                      </td>
                      <td>
                        <span><%= activity.rubric_score || '-' %></span>
                      </td>
                    <% end %>
                    <td>
                      <div class="d-flex gap-1 justify-content-center">
                        <%= link_to edit_csc_activity_path(activity), class: "btn btn-sm btn-outline-secondary", title: "Edit all fields" do %>
                          <i class="fa-solid fa-pen"></i>
                        <% end %>
                        <%= button_to toggle_hidden_csc_activity_path(activity), method: :patch, class: "btn btn-sm btn-outline-success", title: "Show activity", form: { style: "display: inline;" } do %>
                          <i class="fa-solid fa-eye"></i>
                        <% end %>
                      </div>
                    </td>
                  </tr>
                <% end %>
              <% end %>
            </tbody>
          </table>
        </div>

        <div class="mt-3 p-3 bg-light rounded">
          <div class="row">
            <div class="col-md-4">
              <strong>Total Hours:</strong> <span data-totals-calculator-target="totalHours"><%= @csc_activities.sum { |a| a.hours.to_i } %></span>
            </div>
            <div class="col-md-4">
              <strong>Total Credits:</strong> <span data-totals-calculator-target="totalCredits"><%= @csc_activities.sum { |a| a.credits.to_f }.round(2) %></span>
            </div>
            <div class="col-md-4">
              <strong>Valid Activities:</strong> <%= @csc_activities.count { |a| a.validated } %> / <%= @csc_activities.count %>
            </div>
          </div>
        </div>
      <% else %>
        <div class="text-center py-5">
          <i class="fa-solid fa-graduation-cap fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">No activities yet</h5>
          <p class="text-muted">Your CSC Diploma activities will appear here once they are added.</p>
        </div>
      <% end %>
    </div>
  </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.forEach(function(el) { new bootstrap.Tooltip(el); });
    }
  });
</script>
