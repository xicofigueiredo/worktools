<div class="container mt-3">
    <div class="d-flex justify-content-between mb-4">
      <h2><%= @selected_subject.name %></h2>
      <h2>Learner Count: <%=  @users.count  %></h2>
    </div>
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5">
      <% @users.each do |user| %>
      <% result = 0 %>
      <% max = 0 %>
        <div class="col d-flex mb-3 px-2">
          <div class="card shadow-sm w-100" style="border-radius: 10px; ">
            <%= link_to learner_profile_path(user), class: "text-decoration-none on-card-hover", data: { turbo: false }, style: "border-radius: 10px; height: 100%;" do %>
              <div class="p-3">
                <p class="text-black d-flex justify-content-center"><%= user.full_name %></p>
                <div class="d-flex justify-content-center mb-3">
                  <div class="card p-2 d-flex flex-row gap-1" style="border-radius: 10px; width: fit-content;">
                    <div>
                      <div class="text-secondary">
                        Unjustified Absences:
                        <%= @current_sprint.count_absences(user) %>
                      </div>
                    </div>
                  </div>
                </div>
                <% if user.timelines.present? %>
                  <% sorted_timelines = user.timelines.where(hidden: false).to_a.sort_by { |timeline| timeline.difference } %>
                  <% sorted_timelines.each do |timeline| %>
                    <div class="d-flex justify-content-between gap-2" style="height: fit-content;">
                      <p class="text-secondary mb-1"><%= timeline.subject.name != '' ? timeline.subject.name : timeline.personalized_name %>
                      <% if !timeline.personalized_name.present? && timeline.difference != nil %>
                        <% if timeline.difference > 0 %>
                          <div style="height: 28px;">
                            <div class="badge rounded-pill bg-success">+<%= timeline.difference %>%</div></p>
                          </div>
                        <% elsif timeline.difference < 0 %>
                          <div style="height: 28px;">
                            <div class="badge rounded-pill bg-danger"><%= timeline.difference %>%</div></p>
                          </div>
                        <% else %>
                          <div style="height: 28px;">
                            <div class="badge rounded-pill bg-warning">On time</div>
                          </div>
                        <% end %>
                      <% else %>
                          <div style="height: 28px;">
                            <div class="badge rounded-pill bg-warning">N/A</div>
                          </div>
                      <% end %>
                    </div>
                  <% end %>
                <% end %>
              </div>
            <% end %>

          </div>
        </div>
      <% end %>
    </div>
</div>



<%# Topics ahead and on time logic %>
<%# <% if user.topics_balance > 0 %>
  <%# <p class="text-secondary mb-1"><span class="badge rounded-pill bg-success">In Total: <%= user.topics_balance %> <%# Topics Ahead</p> %>
<%# <% elsif user.topics_balance == 0 %>
  <%# <p class="text-secondary mb-1"><span class="badge rounded-pill bg-success"> On Time </p> %>
<%# <% else %>
  <%# <p class="text-secondary mb-1"><span class="badge rounded-pill bg-danger">In Total: <%= -user.topics_balance %> <%#Topics Behind</span></p> %>
<%# <% end %>
