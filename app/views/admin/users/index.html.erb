<div class="container">
  <div class="card main-card">
    <div class="card-body">
      <div class="table-responsive">
        <%= form_with url: admin_users_path, method: :get, local: true, class: "d-flex" do |f| %>
          <table id="usersTable" style="border-collapse: collapse; width: 100%;">
            <thead>
              <tr style="background-color: white; position: sticky; top: 0; z-index: 1000;">
                <th style="border: 1px solid #ddd; padding: 8px;">
                  <div>Email</div>
                </th>
                <th style="border: 1px solid #ddd; padding: 8px;">
                  <div>Full Name</div>
                </th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                  <% if @role == "admin" %>
                    <%= f.select :role,
                        options_for_select([["All", ""], ["Learner", "learner"], ["Learning Coach", "lc"], ["Course Manager", "cm"], ["Parent", "guardian"], ["Admin", "admin"], ["Exams", "exams"], ["Edu", "edu"], ["Staff", "staff"], ["Admissions", "admissions"], ["Finance", "finance"], ["Operations", "ops"], ["IT", "it"]], params[:role]),
                        {},
                        { class: "form-select form-select-sm", style: "width: 120px; font-size: 0.8rem; padding: 2px 4px;", onchange: "this.form.submit()" } %>
                  <% else %>
                    <%= f.select :role,
                        options_for_select([["All", ""], ["Learner", "learner"], ["Learning Coach", "lc"], ["Course Manager", "cm"], ["Parent", "guardian"]], params[:role]),
                        { },
                        { class: "form-select form-select-sm", style: "width: 120px; font-size: 0.8rem; padding: 2px 4px;", onchange: "this.form.submit()" } %>
                  <% end %>
                </th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                  <%= f.select :main_hub_id,
                      options_from_collection_for_select(@hubs, "id", "name", params[:main_hub_id]),
                      { prompt: "All" },
                      { class: "form-select form-select-sm", style: "width: 120px; font-size: 0.8rem; padding: 2px 4px;", onchange: "this.form.submit()" } %>
                </th>
                <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                  <%= f.select :active,
                      options_for_select([["All", ""], ["Active", "active"], ["Inactive", "inactive"]], params[:active]),
                      { },
                      { class: "form-select form-select-sm", style: "width: 120px; font-size: 0.8rem; padding: 2px 4px;", onchange: "this.form.submit()" } %>
                </th>
              </tr>
            </thead>
            <tbody>
              <% if @users.any? %>
                <% @users.each do |user| %>
                  <tr class="editable-row"
                      data-user-id="<%= user.id %>"
                      style="cursor: pointer;"
                      data-bs-toggle="modal"
                      data-bs-target="#editUserModal">
                    <td style="padding: 8px;"><%= user.email %></td>
                    <td style="padding: 8px;"><%= user.full_name %></td>
                    <td style="padding: 8px; text-align: center;"><%= user.role_before_type_cast %></td>
                    <td style="padding: 8px; text-align: center;"><%= user.main_hub.try(:name) %></td>
                    <td style="padding: 8px; text-align: center;">
                      <% if user.deactivate? %>
                        <i class="fa-solid fa-circle" style="color: red;"></i>
                      <% else %>
                        <i class="fa-solid fa-circle" style="color: green;"></i>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              <% else %>
                <tr>
                  <td colspan="6" style="text-align: center; padding: 20px;">
                    <div class="alert alert-info mb-0">
                      <i class="fas fa-info-circle me-2"></i>No users found.
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Modal content will be loaded here -->
      </div>
    </div>
  </div>
</div>

<style>
  .editable-row:hover {
    background-color: rgb(213, 240, 0);
    transition: background-color 0.2s ease;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('editUserModal');
    const modalBody = modal.querySelector('.modal-body');

    document.querySelectorAll('.editable-row').forEach(row => {
      row.addEventListener('click', function() {
        const userId = this.dataset.userId;
        fetch(`/admin/users/${userId}/edit`)
          .then(response => response.text())
          .then(html => {
            modalBody.innerHTML = html;
          });
      });
    });
  });
</script>
