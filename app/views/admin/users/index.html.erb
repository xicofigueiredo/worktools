
<table id="usersTable" style="border-collapse: collapse; width: 100%;">
<%= form_with url: admin_users_path, method: :get, local: true do |f| %>
  <thead>
    <tr style="background-color: white; position: sticky; top: 59px;">
      <th style="border: 1px solid #ddd; padding: 8px;">Email</th>
      <th style="border: 1px solid #ddd; padding: 8px;">Full Name</th>
      <th style="border: 1px solid #ddd; padding: 8px;">      <%= f.select :role, options_for_select([["All", ""], ["Learner", "learner"], ["Learning Coach", "lc"], ["Course Manager", "cm"], ["Parent", "guardian"]], params[:role]),
           { prompt: "All" },
           { class: "form-control", onchange: "this.form.submit();" } %></th>
      <th style="border: 1px solid #ddd; padding: 8px;">      <%= f.select :main_hub_id,
           options_from_collection_for_select(@hubs, "id", "name", params[:main_hub_id]),
           { prompt: "All" },
           { class: "form-control", onchange: "this.form.submit();" } %></th>
      <th style="border: 1px solid #ddd; padding: 8px;">Level</th>
      <th style="border: 1px solid #ddd; padding: 8px;">      <%= f.select :active, options_for_select([["All", ""], ["Active", "active"], ["Inactive", "inactive"]], params[:active]),
           { prompt: "All" },
           { class: "form-control", onchange: "this.form.submit();" } %></th>
    </tr>
  </thead>
<% end %>
  <tbody>
    <% @users.each do |user| %>
      <tr class="editable-row" data-user-id="<%= user.id %>" style="cursor: pointer;">
        <td style="padding: 8px;"><%= user.email %></td>
        <td style="padding: 8px;"><%= user.full_name %></td>
        <td style="padding: 8px;"><%= user.role_before_type_cast %></td>
        <td style="padding: 8px;"><%= user.main_hub.try(:name) %></td>
        <td style="padding: 8px;"><%= user.level %></td>
        <td style="padding: 8px;">
          <% if user.deactivate? %>
            <i class="fa-solid fa-circle" style="color: red;"></i>
          <% else %>
            <i class="fa-solid fa-circle" style="color: green;"></i>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<!-- Single modal container placed outside the loop -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0;
  width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5);
  justify-content: center; align-items: center; z-index: 9999;">
  <div style="background-color: white; padding: 20px; border-radius: 8px; width: 500px; position: relative;">
    <span id="closeModal" style="position: absolute; top: 10px; right: 15px; cursor: pointer;">âœ•</span>
    <div id="modalFormContent">
      <!-- This content will be loaded from the server when a row is clicked -->
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const modal = document.getElementById('editModal');
  const modalContent = document.getElementById('modalFormContent');
  const closeBtn = document.getElementById('closeModal');

  // Use event delegation on the table's <tbody>
  const tableBody = document.querySelector('#usersTable tbody');
  tableBody.addEventListener('click', function (e) {
    const row = e.target.closest('.editable-row');
    if (row) {
      const userId = row.dataset.userId;
      fetch(`/admin/users/${userId}/edit`)
        .then(response => response.text())
        .then(html => {
          modalContent.innerHTML = html;
          modal.style.display = 'flex';

          // Attach any form submission handlers if needed
          const form = modalContent.querySelector('form');
          if (form) {
            form.addEventListener('submit', function(e) {
              e.preventDefault();
              const formData = new FormData(form);
              fetch(form.action, {
                method: form.method,
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
              })
              .then(response => {
                if (response.ok) {
                  modal.style.display = 'none';
                  location.reload();
                } else {
                  console.error('Failed to save');
                }
              })
              .catch(error => console.error('Error:', error));
            });
          }
        });
    }
  });

  // Close modal when clicking the close button
  closeBtn.addEventListener('click', () => {
    modal.style.display = 'none';
  });

  // Close modal when clicking outside the modal content
  window.addEventListener('click', function (e) {
    if (e.target === modal) {
      modal.style.display = 'none';
    }
  });
});

</script>

<style>
  .editable-row:hover {
    background-color: #d5f000;
    transition: background-color 0.2s ease-in-out;
  }
</style>
