<div class="container-fluid">
  <div class="row min-vh-100">

    <div class="col-md-2 border-end py-4">
      <h6 class="px-3 text-uppercase text-muted small fw-bold mb-3">Countries</h6>
      <div class="list-group list-group-flush">
        <% @countries.each do |country| %>
          <%= link_to country,
              pricing_tiers_path(year: @selected_year, country: country),
              class: "list-group-item list-group-item-action border-0 px-3 py-2 rounded #{'active fw-bold' if country == @selected_country}" %>
        <% end %>
      </div>
    </div>

    <div class="col-md-10 py-4 px-md-5">

      <div class="mb-4">
        <ul class="nav nav-pills justify-content-center">
          <% @years.each do |year| %>
            <li class="nav-item mx-1">
              <%= link_to year,
                  pricing_tiers_path(year: year, country: @selected_country, hub_id: @selected_hub_id, hub_type: @selected_hub_type),
                  class: "nav-link px-4 #{'active shadow-sm' if year == @selected_year}" %>
            </li>
          <% end %>
        </ul>
      </div>

      <% if @available_hubs.any? %>
        <ul class="nav nav-tabs border-bottom-0 ms-1">
          <% @available_hubs.each do |hub| %>
            <% is_active = (hub[:hub_id].to_s == @selected_hub_id.to_s && hub[:type] == @selected_hub_type) %>
            <li class="nav-item">
              <%= link_to hub[:name],
                  pricing_tiers_path(year: @selected_year, country: @selected_country, hub_id: hub[:hub_id], hub_type: hub[:type]),
                  class: "nav-link #{'active fw-bold' if is_active} #{'text-muted' unless is_active}" %>
            </li>
          <% end %>
        </ul>
      <% end %>

      <div class="card shadow-sm border-0 mb-5">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 text-center">
              <thead class="bg-light">
                <tr>
                  <th class="text-start ps-4 py-3 text-secondary text-uppercase small" style="width: 25%;">Curriculum</th>
                  <th class="py-3 text-secondary text-uppercase small">Admission</th>
                  <th class="py-3 text-secondary text-uppercase small">Monthly</th>
                  <th class="py-3 text-secondary text-uppercase small">Renewal</th>
                  <th class="py-3 text-secondary text-uppercase small">Invoice To</th>
                  <th class="py-3 text-secondary text-uppercase small">Notes</th>
                  <th class="py-3 text-secondary text-uppercase small">Actions</th>
                </tr>
              </thead>
              <tbody>
                <% if @curriculums.empty? %>
                  <tr>
                    <td colspan="7" class="py-5 text-muted">No pricing data found for this selection.</td>
                  </tr>
                <% else %>
                  <% @curriculums.each do |curr| %>
                    <% tier = @matrix_tiers[curr] %>
                    <tr>
                      <td class="text-start ps-4 fw-bold text-dark"><%= curr %></td>

                      <td class="text-dark">
                        <%= tier.admission_fee.to_f.positive? ? "#{tier.currency_symbol}#{number_with_precision(tier.admission_fee, precision: 2)}" : "-" %>
                      </td>
                      <td class="text-dark">
                        <%= tier.monthly_fee.to_f.positive? ? "#{tier.currency_symbol}#{number_with_precision(tier.monthly_fee, precision: 2)}" : "-" %>
                      </td>
                      <td class="text-dark">
                        <%= tier.renewal_fee.to_f.positive? ? "#{tier.currency_symbol}#{number_with_precision(tier.renewal_fee, precision: 2)}" : "-" %>
                      </td>
                      <td class="text-dark"><%= tier.invoice_recipient.presence || "-" %></td>
                      <td class="text-dark small"><%= tier.notes.presence || "-" %></td>

                      <td>
                        <div class="d-flex justify-content-center gap-2">

                          <button type="button"
                                  class="btn btn-primary d-inline-flex align-items-center justify-content-center p-0 shadow-sm"
                                  style="width: 32px; height: 32px; border-radius: 4px;"
                                  onclick="openEditModal(this)"
                                  data-id="<%= tier.id %>"
                                  data-curriculum="<%= curr %>"
                                  data-currency="<%= tier.currency_symbol %>"
                                  data-admission="<%= tier.admission_fee %>"
                                  data-monthly="<%= tier.monthly_fee %>"
                                  data-renewal="<%= tier.renewal_fee %>"
                                  data-invoice="<%= tier.invoice_recipient %>"
                                  data-notes="<%= tier.notes %>"
                                  title="Edit"
                                  data-bs-toggle="tooltip">
                            <i class="fas fa-pen" style="font-size: 0.8rem;"></i>
                          </button>

                          <%= button_to pricing_tier_path(tier),
                              method: :delete,
                              class: "btn btn-danger d-inline-flex align-items-center justify-content-center p-0 shadow-sm",
                              style: "width: 32px; height: 32px; border-radius: 4px;",
                              title: "Delete",
                              data: { turbo_confirm: "Are you sure? This cannot be undone.", bs_toggle: "tooltip" } do %>
                            <i class="fas fa-trash" style="font-size: 0.8rem;"></i>
                          <% end %>

                        </div>
                      </td>
                    </tr>
                  <% end %>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="sharedEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="sharedModalLabel">Edit Pricing</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <%= form_with(model: @shared_tier, url: "#", method: :patch, id: "sharedEditForm", local: true) do |f| %>
        <div class="modal-body">
          <div class="row g-3">

            <div class="col-md-6">
              <label class="form-label small text-muted fw-bold">Admission Fee</label>
              <div class="input-group">
                <span class="input-group-text currency-symbol">$</span>
                <%= f.number_field :admission_fee, step: "0.01", class: "form-control", id: "inputAdmission" %>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label small text-muted fw-bold">Monthly Fee</label>
              <div class="input-group">
                <span class="input-group-text currency-symbol">$</span>
                <%= f.number_field :monthly_fee, step: "0.01", class: "form-control", id: "inputMonthly" %>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label small text-muted fw-bold">Renewal Fee</label>
              <div class="input-group">
                <span class="input-group-text currency-symbol">$</span>
                <%= f.number_field :renewal_fee, step: "0.01", class: "form-control", id: "inputRenewal" %>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label small text-muted fw-bold">Invoice To</label>
              <%= f.text_field :invoice_recipient, class: "form-control", id: "inputInvoice" %>
            </div>

            <div class="col-12">
              <label class="form-label small text-muted fw-bold">Notes</label>
              <%= f.text_area :notes, rows: 2, class: "form-control", id: "inputNotes" %>
            </div>

          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= f.submit "Save Changes", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  // Tooltip Initialization
  document.addEventListener("DOMContentLoaded", function(){
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
  });

  // Shared Modal Logic
  function openEditModal(button) {
    // Get Data from Button
    const id = button.getAttribute('data-id');
    const curr = button.getAttribute('data-curriculum');
    const symbol = button.getAttribute('data-currency');
    const admission = button.getAttribute('data-admission');
    const monthly = button.getAttribute('data-monthly');
    const renewal = button.getAttribute('data-renewal');
    const invoice = button.getAttribute('data-invoice');
    const notes = button.getAttribute('data-notes');

    // Update Modal Title & Currency Symbols
    document.getElementById('sharedModalLabel').textContent = 'Edit ' + curr + ' Pricing';
    document.querySelectorAll('.currency-symbol').forEach(el => el.textContent = symbol);

    // Populate Inputs (Handle empty strings)
    document.getElementById('inputAdmission').value = admission;
    document.getElementById('inputMonthly').value = monthly;
    document.getElementById('inputRenewal').value = renewal;
    document.getElementById('inputInvoice').value = invoice;
    document.getElementById('inputNotes').value = notes;

    // Update Form Action URL
    const form = document.getElementById('sharedEditForm');
    form.action = '/pricing_tiers/' + id;

    // Show Modal
    const modalEl = document.getElementById('sharedEditModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  }
</script>
