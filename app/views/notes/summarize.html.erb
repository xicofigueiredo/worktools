<%= turbo_frame_tag "modal" do %>
  <div class="modal-backdrop">
    <div class="custom-modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="d-flex justify-content-between mb-3">
        <h1>
          AI Note Summary <br>
          <% if @learner %>
            <small class="text-muted">for <%= @learner.full_name %></small>
          <% end %>
        </h1>
        <div>
          <%= link_to 'X', '#', data: {
            controller: "modals",
            action: "modals#close"
          }, class: "btn btn-secondary" %>
        </div>
      </div>

      <!-- Date Range Selection -->
      <%= form_with url: summarize_user_notes_path(@learner), method: :get, local: false, data: { turbo_frame: "modal" }, class: "mb-3" do |f| %>
        <div class="row g-2">
          <div class="col-md-4">
            <%= f.label :start_date, "Start Date", class: "form-label" %>
            <%= f.date_field :start_date, value: @start_date || @learner&.notes&.minimum(:date) || Date.today, class: "form-control", required: true %>
          </div>
          <div class="col-md-4">
            <%= f.label :end_date, "End Date", class: "form-label" %>
            <%= f.date_field :end_date, value: @end_date || Date.today, class: "form-control", required: true %>
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <%= f.submit "Generate", class: "btn btn-primary w-100" %>
          </div>
        </div>
      <% end %>

      <div id="summary-content" class="d-flex justify-content-center align-items-center">
      <% if @summary_result.nil? %>
        <!-- Show form only, no summary generated yet -->
        <div class="alert alert-info mt-3" style="margin-left:16px !important; margin-right:-16px !important;">
          <i class="fa-solid fa-info-circle me-2 ml-2 mt-2"></i>
          <strong>Select Date Range</strong>
          <p class="mb-0 mt-2">Choose the start and end dates for the notes you want to summarize, then click "Generate".</p>
        </div>
      <% elsif @summary_result && @summary_result[:success] %>
      <%
        # Handle weekly summary structure (nested summary_data)
        summary_data = @summary_result[:summary_data] || @summary_result
        is_weekly = @summary_result[:week].present?
        from_saved = summary_data[:from_saved_summary] || false
      %>
        <!-- Weekly Summary Info -->
        <% if is_weekly %>
          <div class="alert alert-info mb-3">
            <strong>Week:</strong> <%= @summary_result[:week] %><br>
            <strong>Total Notes:</strong> <%= @summary_result[:total_notes] %>
          </div>
        <% end %>

        <!-- Categories Breakdown -->
        <% if summary_data[:categories_breakdown] && summary_data[:categories_breakdown].any? %>
          <div class="mb-3">
            <strong>Notes by Category:</strong>
            <% summary_data[:categories_breakdown].each do |category, count| %>
              <span class="badge bg-primary ms-2"><%= category %>: <%= count %></span>
            <% end %>
          </div>
        <% end %>

        <!-- Summary Card -->
        <div class="card mb-3">
          <div class="card-header bg-primary text-white">
            <h6 class="mb-0"><i class="fa-solid fa-file-lines me-2"></i>Summary</h6>
          </div>
          <div class="card-body">
            <div class="whitespace-pre-wrap" style="white-space: pre-wrap;"><%= summary_data[:summary] || "No summary available." %></div>
          </div>
        </div>

        <!-- Key Points Card -->
        <% if summary_data[:key_points] && summary_data[:key_points].any? %>
          <div class="card mb-3">
            <div class="card-header bg-info text-white">
              <h6 class="mb-0"><i class="fa-solid fa-list-check me-2"></i>Key Points</h6>
            </div>
            <div class="card-body">
              <ul class="mb-0">
                <% summary_data[:key_points].each do |point| %>
                  <li><%= point %></li>
                <% end %>
              </ul>
            </div>
          </div>
        <% end %>

        <!-- Recommendations Card -->
        <% if summary_data[:recommendations].present? %>
          <div class="card mb-3">
            <div class="card-header bg-success text-white">
              <h6 class="mb-0"><i class="fa-solid fa-lightbulb me-2"></i>Recommendations</h6>
            </div>
            <div class="card-body">
              <div class="whitespace-pre-wrap" style="white-space: pre-wrap;"><%= summary_data[:recommendations] %></div>
            </div>
          </div>
        <% end %>

      <% else %>
        <!-- Error State -->
        <div class="alert alert-warning">
          <i class="fa-solid fa-exclamation-triangle me-2"></i>
          <strong>Unable to Generate Summary</strong>
          <p class="mb-2 mt-2"><%= @summary_result[:error] %></p>
          <% if @summary_result[:error]&.include?("temporarily unavailable") || @summary_result[:error]&.include?("rate limit") %>
            <div class="mt-3">
              <p class="mb-2"><strong>Possible reasons:</strong></p>
              <ul class="mb-3">
                <li>API rate limit reached - please wait a few moments and try again</li>
                <li>High demand on the AI service</li>
              </ul>
              <%= link_to 'Try Again', summarize_user_notes_path(@learner, regenerate: true),
                  data: { turbo_frame: "modal" },
                  class: 'btn btn-primary' %>
            </div>
          <% elsif @summary_result[:error]&.include?("API key") %>
            <p class="text-muted mt-2">
              Please contact your administrator to configure the OpenAI API key.
            </p>
          <% else %>
            <div class="mt-3">
              <%= link_to 'ðŸ”„ Try Again', summarize_user_notes_path(@learner, regenerate: true),
                  data: { turbo_frame: "modal" },
                  class: 'btn btn-primary' %>
            </div>
          <% end %>
        </div>
      <% end %>
      </div>
    </div>
  </div>
<% end %>

<style>
  .whitespace-pre-wrap {
    white-space: pre-wrap;
    word-wrap: break-word;
  }
</style>
