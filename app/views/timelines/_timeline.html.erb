<div>
  <h2>
    <div class="d-flex">
      <!-- Timeline Header -->
      <div class="col-12">
        <div class="card shadow-sm m-2 p-2" style="border-radius: 10px;">
          <div class="d-flex justify-content-between">
            <h5>
              <%= timeline["subject_name"].present? ? timeline["subject_name"] : timeline["personalized_name"] %>
              <% unless timeline["personalized_name"].present? %>
                <% if timeline["balance"] > 0 %>
                  <span class="badge rounded-pill bg-success">+<%= timeline["balance"] %></span>
                <% elsif timeline["balance"] < 0 %>
                  <span class="badge rounded-pill bg-danger"><%= timeline["balance"] %></span>
                <% else %>
                  <span class="badge rounded-pill bg-warning">On time</span>
                <% end %>
              <% end %>
            </h5>
            <div class="d-flex gap-2 fs-2">
              <%= link_to edit_timeline_path(timeline["id"]) do %>
                <i class="fa-solid fa-pencil" title="Edit" style="font-size: 20px; color: gray;"></i>
              <% end %>
              <%= link_to toggle_archive_timeline_path(timeline["id"]), data: { turbo_method: :patch, turbo_confirm: "Are you sure you want to archive this timeline?" } do %>
                <i class="fa-solid fa-box-archive" title="Archive" style="font-size: 20px; color: #808080;"></i>
              <% end %>
              <%# <%= link_to timeline_path(timeline["id"]), data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this timeline?" } do %>
                <%# <i class="fa-solid fa-trash" title="Delete" style="font-size: 20px; color: gray;"></i>
              <% end %>
            </div>
          </div>

          <div class="d-flex justify-content-between align-middle">
            <div>
              <div class="d-flex gap-3">
                <p class="mb-1" style="color: gray; font-size: 16px;">Start Date: </p>
                <p style="font-size: 16px;"><%= timeline["start_date"].strftime('%d-%m-%Y') %></p>
              </div>
              <div class="d-flex gap-3">
                <p class="mb-1" style="color: gray; font-size: 16px;">End Date: </p>
                <p style="font-size: 16px;"><%= timeline["end_date"].strftime('%d-%m-%Y') %></p>
              </div>
            </div>
            <div style="margin-block: auto;">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= timeline["id"] %>" aria-expanded="false" aria-controls="collapse<%= timeline["id"] %>" style="border-radius: 10px;"></button>
            </div>
          </div>

          <div class="progress mt-2" role="progressbar" aria-label="Progress bar" aria-valuenow="<%= timeline["progress"] %>" aria-valuemin="0" aria-valuemax="100" style="border-radius: 10px;">
            <div class="progress-bar" style="width: <%= timeline["progress"] %>%; border-radius: 10px;"> <%= timeline["progress"] %>% </div>
          </div>
        </div>
      </div>

    <%# Monthly Goal %>

    </div>
  </h2>

  <!-- Accordion Content -->
  <div id="collapse<%= timeline["id"] %>" class="accordion-collapse collapse" aria-labelledby="heading<%= timeline["id"] %>" data-bs-parent="#parentAccordion">
    <div class="accordion-body p-2">
      <div class="card shadow-sm px-2" style="border-radius: 10px;">
        <table class="table">
          <thead>
            <tr>
              <th><%= timeline["category"].include?("lws") ? 'Project' : 'Unit' %></th>
              <th>Topic</th>
              <% unless timeline["category"].include?("lws") %>
                <th>Hours</th>
                <th width="120px">Date</th>
              <% end %>
              <th>Done</th>
            </tr>
          </thead>
          <tbody>
            <% previous_unit = nil %>
            <% timeline["topics"].each do |topic| %>
              <% background_color = if !topic["done"] && topic["deadline"] && topic["deadline"] < Date.today && !['lws7', 'lws8', 'lws9'].include?(topic["subject_category"])
                                      '#ff193499'
                                    elsif !topic["done"] && topic["deadline"] && Date.today.monday? && topic["deadline"] < (Date.today + ((5 - Date.today.wday) % 7)) && !['lws7', 'lws8', 'lws9'].include?(topic["subject_category"])
                                      'lightgrey'
                                    elsif topic["done"]
                                      '#00ce00a6'
                                    else
                                      'transparent'
                                    end
              %>

              <tr>
                <td style="background-color: <%= background_color %>;">
                  <% if topic["unit"] != previous_unit %>
                    <%= topic["unit"] %>
                    <% previous_unit = topic["unit"] %>
                  <% end %>
                </td>
                <td style="background-color: <%= background_color %>;"><%= topic["name"] %></td>
                <% if topic["deadline"] %>
                  <% unless timeline["category"].include?("lws") %>
                    <td style="background-color: <%= background_color %>;"><%= topic["time"] %></td>
                    <td style="background-color: <%= background_color %>;"><%= topic["deadline"].strftime('%d-%m-%Y') %></td>
                  <% end %>
                <% else %>
                  <td style="background-color: <%= background_color %>;">Update Dates</td>
                <% end %>
                <td style="background-color: <%= background_color %>;">
                  <div class="d-flex justify-content-center align-items-center" data-controller="toggle-done">
                    <% if topic["user_topic_id"].present? %>
                      <%= form_with model: UserTopic.find(topic["user_topic_id"]), url: timeline_path(timeline["id"]), method: :patch, local: true do |form| %>
                      <div class="form-check">
                        <%= form.check_box :done, class: "form-check-input",
                                            data: {
                                              action: "change->toggle-done#toggle",
                                              toggle_done_target: "checkbox",
                                              user_topic_id: topic["user_topic_id"],
                                              timeline_id: timeline["id"]
                                            } %>
                        </div>
                      <% end %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
