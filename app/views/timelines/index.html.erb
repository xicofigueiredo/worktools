<div class="container-fluid">
  <div class="row">
    <div class="col-md-8">
      <% @timelines.each_with_index do |timeline, index| %>
        <div class="accordion" id="parentAccordion">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= index %>" aria-expanded="false" aria-controls="collapse<%= index %>">
                <div class="d-flex justify-content-between align-items-center">
                  <%= timeline.subject.name %>
                </div>
                <div class="d-flex justify-content-end" >
                  <% if timeline.balance.negative? %>
                      <span class="badge rounded-pill bg-danger">
                        <%= timeline.balance %>
                      </span>
                  <% elsif timeline.balance.positive?%>
                      <span class="badge rounded-pill bg-success">
                        +<%= timeline.balance %>
                      </span>
                  <% else %>
                      <span class="badge rounded-pill bg-success"></span>
                  <% end %>
              </div>
              </button>
              <div class="progress" role="progressbar" aria-label="Progress bar" aria-valuenow="<%= (index + 1)* 30 - 21  %>" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar" style="width:<%= (index + 1)* 30 - 21  %>%"><%= (index + 1)* 30 - 21  %>%</div>
              </div>
            </h2>
            <div id="collapse<%= index %>" class="accordion-collapse collapse" aria-labelledby="heading<%= index %>" data-bs-parent="#parentAccordion">
              <div class="accordion-body">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Start Date</th>
                      <th>End Date</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><%= timeline.start_date %></td>
                      <td><%= timeline.end_date %></td>
                      <td><% link_to 'Show', timeline %></td>
                      <td><%= link_to 'Edit', edit_timeline_path(timeline) %></td>
                      <td><%= link_to 'Delete', timeline_path(timeline), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" } %></td>
                    </tr>
                </table>
                <table class="table">
                  <thead>
                    <tr>
                      <th>Unit</th>
                      <th>Topic</th>
                      <th>Hours</th>
                      <th width = "120px" >Date</th>
                      <th>Done</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% timeline.subject.topics.each_with_index do |topic, index| %>
                      <tr>
                        <td>
                          <% if index == 0 || topic.unit != timeline.subject.topics[index - 1].unit %>
                            <%= topic.unit %>
                          <% end %>
                        </td>
                        <td><%= topic.name %></td>
                        <td class="d-flex justify-content-center align-items-center"><%= topic.time %></td>
                        <td><%= current_user.user_topics.find_by(topic_id: topic.id).deadline %></td>
                        <td>
                          <div class="d-flex justify-content-center align-items-center">
                            <%= form_with model: current_user.user_topics.find_by(topic_id: topic.id), url: timeline_path(timeline), method: :patch do |form| %>
                              <div class="form-check">
                                <%= form.check_box :done, { class: "form-check-input", checked: current_user.user_topics.find_by(topic_id: topic.id).done } %>
                              </div>
                            <% end %>
                          </div>
                        </td>
                        <% (current_user.user_topics.find_by(topic_id: topic.id).calculate_percentage * 100).round(3)%>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      <% end %>
      <div class="container">
        <div class="row">
          <div class="col text-end mt-3 mb-3">
            <%= link_to new_timeline_path, class: 'btn btn-primary' do %>
              <i class="fas fa-plus"></i>
              New Timeline
            <% end %>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <h3>Holidays</h3>
      <table class="table">
        <thead>
          <tr>
            <th>Start Date</th>
            <th>End Date</th>
          </tr>
        </thead>
        <tbody>
          <% current_user.holidays.each do |holiday| %>
            <tr>
              <td><%= holiday.start_date %></td>
              <td><%= holiday.end_date %></td>
              <td><%= link_to 'Edit', edit_holiday_path(holiday) %></td>
              <td><%= link_to 'Delete', holiday_path(holiday), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" } %></td>
            </tr>
          <% end %>
          <tr>
            <td>
              <div class="container">
                <div class="row">
                  <div class="col text-end mt-3 mb-3">
                    <%= link_to new_holiday_path, class: 'btn btn-primary' do  %>
                      <i class="fas fa-plus"></i>
                      New Holiday
                    <% end %>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
