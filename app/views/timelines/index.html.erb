<div class="container mt-3">
  <div class="container">
    <div class="mb-5">
      <div class="d-flex justify-content-between">
        <div>
          <h2>Holidays</h2>
          <p>Create new Holidays here</p>
        </div>
        <div>
          <%= link_to "New Holiday", new_holiday_path, class: "btn btn-primary", style: 'border-radius: 10px;' %>
        </div>
      </div>
      <div class="row row-cols-4">
        <% @holidays.each do |holiday| %>
          <div>
            <div class="card shadow-sm mb-3" style="border-radius: 10px">
              <div class="p-3">
                <div class="d-flex justify-content-between mb-2 align-items-center">
                  <h5>
                    <%= holiday.name %>
                  </h5>
                  <div class="d-flex gap-2">
                    <%= link_to edit_holiday_path(holiday) do %>
                      <i class="fa-solid fa-pencil" style="font-size: 20px; color: gray;"></i>
                    <% end %>
                    <%= link_to holiday_path(holiday), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" } do %>
                      <i class="fa-solid fa-trash" style="font-size: 20px; color: gray;"></i>
                    <% end %>
                  </div>
                </div>
                <div>
                  <div class="d-flex justify-content-between">
                    <p class="mb-1" style="color: gray">Start Date: </p>
                    <%= holiday.start_date.strftime('%d-%m-%Y') %>
                  </div>
                  <div class="d-flex justify-content-between">
                    <p class="mb-1" style="color: gray">End Date: </p>
                    <%= holiday.end_date.strftime('%d-%m-%Y') %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <div class="mb-5">
      <div class="d-flex justify-content-between">
        <div>
            <h2>Timelines</h2>
          <p>Create your Timelines here</p>
        </div>
        <div style="margin-right: 130px;">
          <% if @has_lws %>
              <div class="flex">
                <h5 class="mb-0" style="margin-top: 12px">Blocks per day: <%= (@total_blocks_per_day * 1.2).round(1)  %></h5>
                <h5 class="mb-0" style="margin-top: 12px">Total Hours: <%= (@total_remaining_hours).round(1)  %></h5>
              </div>
          <% end %>
        </div>
        <div>
          <%= link_to "New Timeline", new_timeline_path, class: "btn btn-primary", style: 'border-radius: 10px;' %>
        </div>
      </div>
      <div class="accordion" id="parentAccordion">
        <% @timelines.each_with_index do |timeline, index| %>
          <% is_lws = timeline.subject.category&.include?("lws")%>
          <div>
            <h2>
              <div class="d-flex">
                <%# Timeline Header %>
                <div class="col-8">
                  <div class="card shadow-sm m-2 p-2" style="border-radius: 10px;">
                    <div class="d-flex justify-content-between">
                      <h5>
                        <%= timeline.subject.name != '' ? timeline.subject.name : timeline.personalized_name %>
                        <% unless is_lws || timeline.personalized_name.present? %>
                          <% if timeline.balance > 0 %>
                              <div class="badge rounded-pill bg-success">+<%= timeline.balance %></div></p>
                          <% elsif timeline.balance < 0 %>
                              <div class="badge rounded-pill bg-danger"><%= timeline.balance %></div></p>
                          <% else %>
                              <div class="badge rounded-pill bg-warning">On time</div>
                          <% end %>
                        <% end %>
                      </h5>
                      <% if timeline.subject.name.present? %>
                        <div class="d-flex gap-2 fs-2">
                          <%= link_to edit_timeline_path(timeline) do %>
                            <i class="fa-solid fa-pencil" style="font-size: 20px; color: gray;"></i>
                          <% end %>
                      <% else %>
                         <div class="d-flex gap-2 fs-2">
                          <%= link_to personalized_edit_timeline_path(timeline) do %>
                            <i class="fa-solid fa-pencil" style="font-size: 20px; color: gray;"></i>
                          <% end %>
                      <% end %>
                        <%= link_to timeline_path(timeline), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" } do %>
                          <i class="fa-solid fa-trash" style="font-size: 20px; color: gray;"></i>
                        <% end %>
                      </div>
                    </div>
                    <div class="d-flex justify-content-between align-middle">
                      <div>
                        <div class="d-flex gap-3">
                          <p class="mb-1" style="color: gray; font-size: 16px;">Start Date: </p>
                          <p style="font-size: 16px;">
                            <%= timeline.start_date.strftime('%d-%m-%Y') %>
                          </p>
                        </div>
                        <div class="d-flex gap-3">
                          <p class="mb-1" style="color: gray; font-size: 16px;">End Date: </p>
                          <p style="font-size: 16px;">
                            <%= timeline.end_date.strftime('%d-%m-%Y') %>
                          </p>
                        </div>
                      </div>
                      <% if timeline.subject.name.present? %>
                      <%#  %>
                      <%#  Accordion Button%>
                      <%#  %>
                        <div style="margin-block: auto;">
                          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= index %>" aria-expanded="false" aria-controls="collapse<%= index %>" style="border-radius: 10px;">
                          </button>
                        </div>
                    </div>
                    <div class="progress" role="progressbar" aria-label="Progress bar" aria-valuenow="<%= timeline.progress %>" aria-valuemin="0" aria-valuemax="100" style="border-radius: 10px;">
                      <div class="progress-bar" style="width: <%= timeline.progress > 5 ? timeline.progress : 4 %>%; border-radius: 10px;"> <%= timeline.progress %>% </div>
                      <% end %>
                    </div>
                  </div>
                </div>
                <%# Monthly Goal %>
                <div class="col-4 h-full">
                  <div class="card shadow-sm m-2 p-2" style="border-radius: 10px; height: 91%;">
                    <% monthly_goal = @monthly_goals.find { |monthly_goal| monthly_goal[:timeline].subject.name == timeline.subject.name } %>

                    <% if monthly_goal %>
                      <p style="font-size: 16px;"><%= monthly_goal[:timeline].subject.name %></p>
                      <div>
                        <div class="d-flex gap-3">
                          <p class="mb-1" style="color: gray; font-size: 16px;">Topic: </p>
                          <p style="font-size: 16px;">
                            <%= monthly_goal[:topic].name %>
                          </p>
                        </div>
                        <div class="d-flex gap-3">
                          <p class="mb-1" style="color: gray; font-size: 16px">Deadline: </p>
                          <p style="font-size: 16px;">
                            <%= monthly_goal[:topic]&.user_topics.find_by(topic: monthly_goal[:topic], user: current_user).deadline.strftime('%d-%m-%Y') %>
                          </p>
                        </div>
                      </div>
                    <% else %>
                      <div class="d-flex justify-content-center align-middle" style="margin-block: auto;">
                        <p style="font-size: 16px;">This Timeline has no goal for this month</p>
                      </div>
                    <% end %>

                  </div>
                </div>
              </div>
            </h2>
            <div id="collapse<%= index %>" class="accordion-collapse collapse" aria-labelledby="heading<%= index %>" data-bs-parent="#parentAccordion">
              <div class="accordion-body p-2">
                <div class="card shadow-sm px-2" style="border-radius: 10px;">
                  <table class="table">
                    <thead>
                      <tr>
                        <th><%= is_lws ? 'Project' : 'Unit' %></th>
                        <th>Topic</th>
                        <% if !is_lws %>
                          <th>Hours</th>
                          <th width = "120px" >Date</th>
                        <% end %>
                        <th>Done</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% previous_unit = nil %>
                      <% timeline.subject.topics.order(:order, id: :asc).each_with_index do |topic, index| %>
                        <% user_topic = current_user.user_topics.find_or_initialize_by(topic: topic) %>
                        <% subject_category = topic.subject.category %>
                        <% background_color = if !user_topic.done && !user_topic.deadline.nil? && user_topic.deadline < Date.today && !['lws7', 'lws8', 'lws9'].include?(subject_category)
                            'background-color: lightcoral;'
                          elsif !user_topic.done && !user_topic.deadline.nil? &&  Date.today.monday < user_topic.deadline && user_topic.deadline < (Date.today + ((5 - Date.today.wday) % 7)) && !['lws7', 'lws8', 'lws9'].include?(subject_category)
                            'background-color: lightgrey;'
                          elsif user_topic.done
                            'background-color: lightgreen;'
                          else
                            ''
                          end
                        %>

                        <tr style="<%= background_color %>">
                          <td>
                            <% if topic.unit != previous_unit %>
                              <%= topic.unit %>
                              <% previous_unit = topic.unit %>
                            <% end %>
                          </td>
                          <td style="<%= background_color %>"><%= topic.name %></td>
                          <% if !user_topic.deadline.nil? %>
                            <% if !is_lws %>
                              <td style="<%= background_color %>"><%= topic.time %></td>
                              <td style="<%= background_color %>"><%= user_topic.deadline.strftime('%d-%m-%Y') %></td>
                            <% end %>
                          <% else %>
                            <td style="<%= background_color %>">Update Dates</td>
                          <% end %>
                          <td style="<%= background_color %>">
                            <div class="d-flex justify-content-center align-items-center" data-controller="toggle-done">                              <%= form_with model: user_topic, url: timeline_path(timeline), method: :patch, local: true do |form| %>
                                <div class="form-check">
                                  <%= form.check_box :done, class: "form-check-input",
                                                          data: {
                                                            action: "change->toggle-done#toggle",
                                                            toggle_done_target: "checkbox",
                                                            user_topic_id: user_topic.id,
                                                            timeline_id: timeline.id
                                                          } %>
                                </div>
                              <% end %>
                            </div>
                          </td>
                          <% (user_topic.calculate_percentage * 100).round(3)%>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

</div>
