<div class="container">
  <div class="row">
    <div class="col text-end mt-3 mb-3">
      <%= link_to new_timeline_path, class: 'btn btn-primary' do %>
        <i class="fas fa-plus"></i>
        Add a new Timeline
      <% end %>
    </div>
  </div>
</div>

<% @timelines.each_with_index do |timeline, index| %>
  <div class="accordion" id="accordionExample">
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= index %>" aria-expanded="true" aria-controls="collapse<%= index %>">
          <div class="d-flex justify-content-between align-items-center">
            <%= timeline.subject.name %>
            <div class="btn btn-success position-absolute top-50 end-50 translate-middle-y">3 Topics Ahead</div>
          </div>
        </button>
        <div class="progress" role="progressbar" aria-label="Example with label" aria-valuenow="27" aria-valuemin="0" aria-valuemax="100">
              <div class="progress-bar" style="width: 27%">27%</div>
        </div>
      </h2>
      <div id="collapse<%= index %>" class="accordion-collapse collapse <%= index == 0 ? ' show' : '' %>" aria-labelledby="heading<%= index %>" data-bs-parent="#accordionExample">
        <div class="accordion-body">
          <table class="table">
            <thead>
              <tr>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Total Time</th>
                <th colspan="3">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><%= timeline.start_date %></td>
                <td><%= timeline.end_date %></td>
                <td><%= timeline.total_time %></td>
                <td><%= link_to 'Show', timeline %></td>
                <td><%= link_to 'Edit', edit_timeline_path(timeline) %></td>
                <td><%= link_to 'Delete', timeline_path(timeline), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" } %></td>
              </tr>
              <tr>
                <td colspan="6">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Unit</th>
                        <th>Topic</th>
                        <th>Hours</th>
                        <th>Date</th>
                        <th>Done</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% timeline.subject.topics.each_with_index do |topic, index| %>
                        <tr>
                          <td><% if index == 0 || topic.unit != timeline.subject.topics[index - 1].unit %>
                                <%= topic.unit %>
                              <% end %>
                          </td>
                          <td><%= topic.name %></td>
                          <td><%= topic.time %></td>
                          <td><%= current_user.user_topics.find_by(topic_id: topic.id).deadline %></td>
                          <td>
                            <input type="checkbox" data-controller="topic" data-user-topic-id="<%= current_user.user_topics.find_by(topic_id: topic.id).id %>" <%= current_user.user_topics.find_by(topic_id: topic.id).done? ? 'checked' : '' %>>
                            <label for="topic_<%= topic.id %>_done"></label>
                          </td>
                          <td><%= (current_user.user_topics.find_by(topic_id: topic.id).calculate_percentage * 100).round(3)%></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
<% end %>
